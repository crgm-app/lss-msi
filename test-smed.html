<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SMED History Analytics v16</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --neon-green: #00ff00; --neon-blue: #00d4ff; --neon-orange: #ffaa00; --bg-dark: #050505; --panel: #111; }
        * { box-sizing: border-box; margin: 0; padding: 0; touch-action: manipulation; }
        body { background-color: var(--bg-dark); color: #fff; font-family: 'Segoe UI', sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        header { background: var(--panel); padding: 5px 10px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
        .main-clock { font-size: 1.8rem; font-weight: 900; font-family: monospace; color: var(--neon-green); }
        
        nav { display: flex; background: #000; border-bottom: 1px solid #333; height: 45px; flex-shrink: 0; }
        .tab-btn { flex: 1; background: none; border: none; color: #666; font-weight: bold; font-size: 0.75rem; text-transform: uppercase; cursor: pointer; }
        .tab-btn.active { color: var(--neon-blue); background: #151515; border-bottom: 3px solid var(--neon-blue); }

        .view-section { display: none; flex: 1; overflow: hidden; position: relative; flex-direction: column; }
        .view-section.active { display: flex; }

        /* GANTT CHRONOLOGY CONTROLS */
        .timeline-controls { background: #111; padding: 10px; display: flex; align-items: center; justify-content: space-between; gap: 10px; border-bottom: 1px solid #333; }
        .date-nav-btn { background: #222; border: 1px solid #444; color: #fff; padding: 5px 15px; border-radius: 4px; cursor: pointer; }

        /* BOXPLOT & STATS */
        .stats-container { flex: 1; overflow-y: auto; padding: 15px; background: #000; }
        .chart-card { background: #111; border-radius: 8px; border: 1px solid #333; padding: 15px; margin-bottom: 20px; }
        
        /* REGISTRO LAYOUT */
        .capture-layout { flex-direction: row; }
        .left-list { flex: 1; border-right: 1px solid #333; display: flex; flex-direction: column; }
        .right-btns { flex: 1.2; padding: 10px; overflow-y: auto; display: grid; gap: 8px; align-content: start; }
        
        .smed-btn-box { display: flex; height: 55px; border: 1px solid #333; border-radius: 6px; overflow: hidden; }
        .smed-btn { flex: 1; background: #151515; color: #fff; border: none; text-align: left; padding-left: 12px; font-weight: bold; position: relative; }
        .smed-btn.active { background: #221100; color: var(--neon-orange); border-left: 4px solid var(--neon-orange); }
        .status-tag { position: absolute; bottom: 5px; right: 8px; font-size: 0.5rem; color: #555; }

        footer { height: 55px; background: #111; display: flex; gap: 8px; align-items: center; justify-content: center; padding: 0 10px; border-top: 1px solid #333; }
        .btn-foot { background: #222; color: #fff; border: 1px solid #444; padding: 10px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; }
    </style>
</head>
<body>

    <header>
        <div><div id="abs-clock" class="main-clock">00000.0</div><div style="font-size:0.5rem; color:#555">CHRONOS HISTORIC ANALYZER</div></div>
        <div style="text-align:right"><div id="real-date" style="font-size:0.7rem; color:#666">--/--/--</div><div id="real-time" style="font-size:1rem; font-weight:bold; color:var(--neon-blue)">00:00:00</div></div>
    </header>

    <nav>
        <button class="tab-btn active" onclick="switchView('capture', this)">Captura</button>
        <button class="tab-btn" onclick="switchView('history', this)">Cronología</button>
        <button class="tab-btn" onclick="switchView('stats', this)">Estadística Velas</button>
    </nav>

    <div id="view-capture" class="view-section capture-layout active">
        <section class="left-list">
            <div style="flex:1; overflow-y:auto;">
                <table id="log-table" style="width:100%; border-collapse:collapse; font-size:0.6rem; font-family:monospace;">
                    <thead><tr style="background:#111; color:var(--neon-blue); border-bottom:1px solid #333;"><th>Tarea</th><th>Inicio</th><th>Fin</th><th>Dur(s)</th></tr></thead>
                    <tbody id="log-body"></tbody>
                </table>
            </div>
            <div style="padding:10px; background:#111; border-top:1px solid #333;">
                <input type="text" id="new-task" placeholder="Ej: Troquel Montar" style="width:100%; background:#000; border:1px solid #444; color:#fff; padding:10px; margin-bottom:5px; border-radius:4px;">
                <button onclick="addBtn()" style="width:100%; background:var(--neon-blue); border:none; padding:10px; font-weight:bold; border-radius:4px;">AÑADIR BOTÓN</button>
            </div>
        </section>
        <section class="right-btns" id="btn-container"></section>
    </div>

    <div id="view-history" class="view-section">
        <div class="timeline-controls">
            <button class="date-nav-btn" onclick="changeDate(-1)">◀ Anterior</button>
            <div id="viewing-date" style="font-weight:bold; color:var(--neon-blue)">CARGANDO...</div>
            <button class="date-nav-btn" onclick="changeDate(1)">Siguiente ▶</button>
        </div>
        <div style="flex:1; padding:10px; position:relative;">
            <canvas id="ganttCanvas"></canvas>
        </div>
    </div>

    <div id="view-stats" class="view-section stats-container">
        <div class="chart-card">
            <div style="color:#888; font-size:0.7rem; margin-bottom:10px; text-transform:uppercase;">Diagrama de Cajas (Box-Plot) con Datos</div>
            <div style="height:400px; position:relative;">
                <canvas id="boxPlotCanvas"></canvas>
            </div>
        </div>
    </div>

    <footer>
        <button class="btn-foot" style="background:var(--neon-blue); color:#000" onclick="triggerImport()">IMPORTAR</button>
        <button class="btn-foot" onclick="exportData('csv')">CSV</button>
        <button class="btn-foot" style="background:#311; color:#f55" onclick="hardReset()">RESET</button>
    </footer>

    <input type="file" id="csv-file" style="display:none" accept=".csv" multiple onchange="importCSV(this)">

    <script>
        let absTime = 0;
        let logs = JSON.parse(localStorage.getItem('smed_v16_logs')) || [];
        let btns = JSON.parse(localStorage.getItem('smed_v16_btns')) || ["Troquel Montar", "Troquel Desmontar", "Sello Ajuste"];
        let activeTasks = {};
        let viewDate = new Date(); // Fecha que estamos viendo en el gráfico cronológico

        function tick() {
            const now = new Date();
            absTime = (now.getHours()*3600)+(now.getMinutes()*60)+now.getSeconds()+(now.getMilliseconds()/1000);
            document.getElementById('abs-clock').textContent = absTime.toFixed(1);
            document.getElementById('real-time').textContent = now.toLocaleTimeString();
            document.getElementById('real-date').textContent = now.toLocaleDateString();
            
            // Auto-guardado de respaldo cada 30 segundos
            if(Math.floor(absTime) % 30 === 0) saveData();
        }

        /* --- LÓGICA DE CAPTURA --- */
        function addBtn() {
            const name = document.getElementById('new-task').value.trim();
            if(!name || btns.includes(name)) return;
            btns.push(name); saveData(); renderBtns();
            document.getElementById('new-task').value = "";
        }

        function renderBtns() {
            const cont = document.getElementById('btn-container');
            cont.innerHTML = "";
            btns.forEach(name => {
                const group = name.split(' ')[0].toUpperCase();
                const div = document.createElement('div');
                div.className = 'smed-btn-box';
                const isActive = activeTasks[group] && activeTasks[group].name === name;
                div.innerHTML = `
                    <button class="smed-btn ${isActive ? 'active' : ''}" onclick="handleTask('${name}', '${group}', this)">
                        <div style="font-size:0.5rem; color:var(--neon-blue); opacity:0.6">${group}</div>
                        ${name}
                        <div class="status-tag">${isActive ? 'CONTANDO' : 'OFF'}</div>
                    </button>
                    <button onclick="delBtn('${name}')" style="width:30px; background:#211; border:none; color:#f55">×</button>
                `;
                cont.appendChild(div);
            });
        }

        function handleTask(name, group, btn) {
            const now = new Date();
            if(activeTasks[group] && activeTasks[group].name === name) {
                // DETENER
                const task = activeTasks[group];
                const duration = (now.getTime() - task.start.getTime()) / 1000;
                logs.push({
                    name: name,
                    group: group,
                    start: task.start,
                    end: now,
                    dur: duration.toFixed(1)
                });
                delete activeTasks[group];
            } else {
                // INICIAR (Y cerrar previa del grupo)
                if(activeTasks[group]) {
                    const prev = activeTasks[group];
                    logs.push({ name: prev.name, group: group, start: prev.start, end: now, dur: ((now.getTime()-prev.start.getTime())/1000).toFixed(1) });
                }
                activeTasks[group] = { name: name, start: now };
            }
            saveData(); renderBtns(); renderLogs();
        }

        function renderLogs() {
            const body = document.getElementById('log-body');
            body.innerHTML = logs.slice(-15).reverse().map(l => {
                const s = new Date(l.start);
                const e = new Date(l.end);
                return `<tr style="border-bottom:1px solid #222">
                    <td>${l.name}</td>
                    <td>${s.getHours()}:${s.getMinutes()}:${s.getSeconds()}</td>
                    <td>${e.getHours()}:${e.getMinutes()}:${e.getSeconds()}</td>
                    <td style="color:var(--neon-orange); font-weight:bold">${l.dur}s</td>
                </tr>`;
            }).join('');
        }

        /* --- GRÁFICO CRONOLÓGICO (GANTT) --- */
        function renderGantt() {
            const canvas = document.getElementById('ganttCanvas');
            const ctx = canvas.getContext('2d');
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;

            const w = canvas.width;
            const h = canvas.height;
            const padding = 60;

            document.getElementById('viewing-date').textContent = viewDate.toLocaleDateString();

            // Filtrar logs del día seleccionado
            const dayLogs = logs.filter(l => {
                const d = new Date(l.start);
                return d.toDateString() === viewDate.toDateString();
            });

            ctx.clearRect(0,0,w,h);
            if(!dayLogs.length) {
                ctx.fillStyle = "#444"; ctx.textAlign="center"; ctx.fillText("SIN DATOS PARA ESTE DÍA", w/2, h/2);
                return;
            }

            // Eje X: 24 horas (o rango del día)
            const minH = 0; const maxH = 24;
            const scaleX = (val) => padding + ((val / (maxH * 3600)) * (w - padding * 2));
            
            // Eje Y: Actividades únicas
            const uniqueTasks = [...new Set(dayLogs.map(l => l.name))];
            const scaleY = (idx) => padding + (idx * (h - padding*2) / uniqueTasks.length);

            // Dibujar cuadrícula de horas
            ctx.strokeStyle = "#222"; ctx.lineWidth=1;
            for(let i=0; i<=24; i+=2) {
                const x = scaleX(i * 3600);
                ctx.beginPath(); ctx.moveTo(x, padding); ctx.lineTo(x, h-padding); ctx.stroke();
                ctx.fillStyle="#555"; ctx.font="8px monospace"; ctx.fillText(i+"h", x-5, h-padding+15);
            }

            // Dibujar barras Gantt
            dayLogs.forEach(l => {
                const sDate = new Date(l.start);
                const eDate = new Date(l.end);
                const sSecs = (sDate.getHours()*3600) + (sDate.getMinutes()*60) + sDate.getSeconds();
                const eSecs = (eDate.getHours()*3600) + (eDate.getMinutes()*60) + eDate.getSeconds();
                
                const x = scaleX(sSecs);
                const width = scaleX(eSecs) - x;
                const y = scaleY(uniqueTasks.indexOf(l.name));
                
                ctx.fillStyle = "rgba(0, 212, 255, 0.4)";
                ctx.strokeStyle = "#00d4ff";
                ctx.fillRect(x, y, width, 20);
                ctx.strokeRect(x, y, width, 20);
                
                ctx.fillStyle="#fff"; ctx.font="9px sans-serif"; ctx.textAlign="left";
                ctx.fillText(l.name, padding, y-5);
            });
        }

        /* --- GRÁFICO DE VELAS (BOX PLOT) CON VALORES --- */
        function renderBoxPlots() {
            const canvas = document.getElementById('boxPlotCanvas');
            const ctx = canvas.getContext('2d');
            const w = canvas.parentElement.clientWidth;
            const h = canvas.parentElement.clientHeight;
            canvas.width = w; canvas.height = h;

            const padding = 80;
            const groups = {};
            logs.forEach(l => {
                if(!groups[l.name]) groups[l.name] = [];
                groups[l.name].push(parseFloat(l.dur));
            });

            const tasks = Object.keys(groups);
            const maxVal = Math.max(...logs.map(l => l.dur)) * 1.2;

            ctx.clearRect(0,0,w,h);
            
            tasks.forEach((name, i) => {
                const data = groups[name].sort((a,b)=>a-b);
                const n = data.length;
                const min = data[0], max = data[n-1], q1 = data[Math.floor(n*0.25)], med = data[Math.floor(n*0.5)], q3 = data[Math.floor(n*0.75)];
                
                const y = padding + (i * (h - padding*2) / tasks.length);
                const scaleX = (val) => padding + (val / maxVal * (w - padding*2));

                // Dibujar Vela
                const xMin = scaleX(min), xMax = scaleX(max), xQ1 = scaleX(q1), xMed = scaleX(med), xQ3 = scaleX(q3);
                
                ctx.strokeStyle="#444"; ctx.beginPath(); ctx.moveTo(xMin, y); ctx.lineTo(xMax, y); ctx.stroke();
                ctx.fillStyle="rgba(255, 170, 0, 0.2)"; ctx.fillRect(xQ1, y-15, xQ3-xQ1, 30);
                ctx.strokeStyle="#ffaa00"; ctx.strokeRect(xQ1, y-15, xQ3-xQ1, 30);
                ctx.beginPath(); ctx.moveTo(xMed, y-15); ctx.lineTo(xMed, y+15); ctx.stroke();

                // ETIQUETAS DE DATOS (VALORES)
                ctx.fillStyle="#fff"; ctx.font="8px monospace"; ctx.textAlign="center";
                ctx.fillText(min.toFixed(1), xMin, y+25);
                ctx.fillText(max.toFixed(1), xMax, y+25);
                ctx.fillStyle=varColor('neon-blue');
                ctx.fillText(`M:${med.toFixed(1)}`, xMed, y-20);
                
                ctx.fillStyle="#aaa"; ctx.textAlign="right";
                ctx.fillText(name, padding-10, y+3);
            });
        }

        /* --- UTILIDADES --- */
        function switchView(view, btn) {
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('view-'+view).classList.add('active');
            btn.classList.add('active');
            if(view === 'history') renderGantt();
            if(view === 'stats') renderBoxPlots();
        }

        function changeDate(days) {
            viewDate.setDate(viewDate.getDate() + days);
            renderGantt();
        }

        function saveData() {
            localStorage.setItem('smed_v16_logs', JSON.stringify(logs));
            localStorage.setItem('smed_v16_btns', JSON.stringify(btns));
        }

        function varColor(name) { return getComputedStyle(document.documentElement).getPropertyValue('--'+name).trim(); }
        
        function exportData(fmt) {
            let csv = "Tarea,InicioFull,FinFull,DuracionSeg\n";
            logs.forEach(l => csv += `"${l.name}","${l.start}","${l.end}",${l.dur}\n`);
            const blob = new Blob([csv], {type:'text/csv'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `SMED_LOG_${new Date().getTime()}.csv`;
            a.click();
        }

        function hardReset() { if(confirm("¿Borrar historial?")) { localStorage.clear(); location.reload(); } }
        function triggerImport() { document.getElementById('csv-file').click(); }
        function delBtn(n) { btns = btns.filter(b=>b!==n); saveData(); renderBtns(); }

        window.onload = () => {
            init(); renderBtns(); renderLogs();
            setInterval(tick, 100);
        };
    </script>
</body>
</html>
