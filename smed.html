<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMED Cronometro y resultados Pro</title>
    <style>
        :root {
            --bg-color: #0a0a0a;
            --card-bg: #141414;
            --text-muted: #666;
            --text-bright: #e0e0e0;
            --primary-sec: #00ff9d;
            --secondary-time: #00d4ff;
            --active-run: #ffaa00; /* Color para actividad corriendo */
            --danger: #ff4444;
            --border: #2a2a2a;
            --tab-active: #222;
        }

        body {
            font-family: 'Consolas', 'Monaco', monospace;
            background-color: var(--bg-color);
            color: var(--text-bright);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            margin: 0;
            font-size: 12px;
        }

        /* --- TABS --- */
        .tab-nav { display: flex; gap: 5px; width: 100%; max-width: 650px; margin-bottom: 10px; }
        .tab-btn {
            flex: 1; background: var(--card-bg); border: 1px solid var(--border);
            color: var(--text-muted); padding: 8px; cursor: pointer;
            text-transform: uppercase; font-family: inherit; font-weight: bold; font-size: 0.75rem;
        }
        .tab-btn.active { background: var(--tab-active); color: var(--primary-sec); border-bottom: 2px solid var(--primary-sec); }

        .view-section { display: none; width: 100%; max-width: 650px; gap: 8px; flex-direction: column; }
        .view-section.active { display: flex; }

        /* --- ESTILOS GENERALES --- */
        h2 { font-size: 0.75rem; color: var(--text-muted); margin: 0 0 5px 0; font-weight: normal; text-transform: uppercase; border-bottom: 1px solid var(--border); padding-bottom: 2px;}
        .card { background-color: var(--card-bg); border: 1px solid var(--border); padding: 10px; border-radius: 4px; }
        
        .sec-display-huge { font-size: 2.5rem; color: var(--primary-sec); font-weight: bold; text-align: center; line-height: 1; margin: 5px 0; }
        .time-display { font-size: 0.8rem; color: var(--secondary-time); text-align: right; }
        
        /* --- BOTONERA --- */
        .dynamic-btn-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; margin-bottom: 10px; }
        .dyn-btn {
            background: #222; border: 1px solid #444; color: #fff; padding: 10px 5px;
            cursor: pointer; border-radius: 4px; font-family: inherit; font-size: 0.8rem;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: all 0.1s;
        }
        .dyn-btn:active { transform: translateY(2px); }
        .dyn-btn small { font-size: 0.6rem; color: #888; margin-top: 2px; }
        
        /* Estilo botón activo (corriendo) */
        .dyn-btn.is-running { border-color: var(--active-run); background: #2a2200; color: var(--active-run); box-shadow: 0 0 5px rgba(255, 170, 0, 0.2); }

        /* --- PANELES ACTIVOS --- */
        .active-timers-panel { margin-bottom: 10px; border: 1px dashed #333; padding: 5px; border-radius: 4px; }
        .active-timer-row { display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 2px; }
        .timer-cat { color: #888; }
        .timer-name { color: var(--active-run); font-weight: bold; }
        .timer-val { color: #fff; font-family: monospace; }

        /* --- LISTA HISTORIAL --- */
        .lap-list-container { max-height: 200px; overflow-y: auto; border-top: 1px solid var(--border); margin-top: 5px; }
        .lap-item { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; border-bottom: 1px solid #222; font-size: 0.75rem; }
        .lap-val { color: var(--primary-sec); font-weight: bold; }

        /* --- STATS & VELA --- */
        .stats-summary { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-bottom: 15px; text-align: center; }
        .stat-box { background: #1a1a1a; padding: 5px; border: 1px solid #333; border-radius: 3px;}
        .stat-label { font-size: 0.65rem; color: #666; display: block;}
        .stat-val { font-size: 0.9rem; color: var(--primary-sec); font-weight: bold;}

        /* Vela (Box Plot) */
        .boxplot-container { height: 100px; position: relative; background: #111; border: 1px solid #333; margin-top: 10px; }
        .boxplot-track { position: relative; height: 50px; width: 90%; margin: 25px auto; }
        .bp-line { position: absolute; top: 50%; height: 1px; background: #555; }
        .bp-box { position: absolute; top: 20%; height: 60%; background: rgba(0, 255, 157, 0.1); border: 1px solid var(--primary-sec); }
        .bp-median { position: absolute; top: 10%; height: 80%; width: 2px; background: #fff; z-index: 2;}
        .bp-whisker { position: absolute; top: 30%; height: 40%; width: 1px; background: #888; }
        .bp-label { position: absolute; top: 110%; font-size: 0.6rem; color: #888; transform: translateX(-50%); }

        /* Config */
        .config-row { display: flex; justify-content: space-between; padding: 5px; border-bottom: 1px solid #222; align-items: center; }
        .input-dark { background: #111; border: 1px solid #333; color: #fff; padding: 5px; }

        /* Scroll */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }
    </style>
</head>
<body>

    <div class="tab-nav">
        <button class="tab-btn active" onclick="switchTab('main')">Reloj</button>
        <button class="tab-btn" onclick="switchTab('stats')">Estadísticas</button>
        <button class="tab-btn" onclick="switchTab('config')">Configurar</button>
    </div>

    <div id="tab-main" class="view-section active">
        
        <div class="card">
            <h2>Tiempo Maestro</h2>
            <div class="sec-display-huge" id="mainSeconds">00000.0</div>
            <div style="text-align: center; margin-bottom: 10px;">
                <span class="time-display" id="mainTime">00:00:00</span>
            </div>

            <div id="activeTimersList" class="active-timers-panel" style="display:none;">
                </div>

            <div id="dynamicButtons" class="dynamic-btn-grid"></div>

            <div style="display:flex; justify-content:center; gap:5px; margin-top:10px;">
                <button class="dyn-btn" style="padding:5px 10px;" onclick="stopAllTimers()">⏹ DETENER TODO</button>
                <button class="dyn-btn" style="padding:5px 10px;" onclick="exportCSV()">Exportar CSV</button>
                <button class="dyn-btn" style="padding:5px 10px;" onclick="document.getElementById('fileInput').click()">Importar</button>
                <button class="dyn-btn" style="padding:5px 10px; color:var(--danger); border-color:var(--danger);" onclick="clearAllData()">Reset</button>
                <input type="file" id="fileInput" accept=".csv" style="display: none;" onchange="importCSV(this)">
            </div>
            
            <h2 style="margin-top:15px;">Historial de Actividades Cerradas</h2>
            <div class="lap-list-container" id="lapList"></div>
        </div>
    </div>

    <div id="tab-stats" class="view-section">
        <div class="card">
            <h2 style="color:var(--primary-sec);">Análisis de Duración</h2>
            
            <div style="margin-bottom:15px; background:#1a1a1a; padding:10px;">
                <label class="label">Filtrar por:</label>
                <select id="statsFilter" class="input-dark" style="width:100%; margin-top:5px;" onchange="calculateStats()">
                    <option value="ALL">Todo el Historial</option>
                </select>
            </div>
            
            <div class="stats-summary">
                <div class="stat-box"><span class="stat-label">Min</span><span class="stat-val" id="st-min">--</span></div>
                <div class="stat-box"><span class="stat-label">Q1</span><span class="stat-val" id="st-q1">--</span></div>
                <div class="stat-box"><span class="stat-label">Mediana</span><span class="stat-val" id="st-med">--</span></div>
                <div class="stat-box"><span class="stat-label">Q3</span><span class="stat-val" id="st-q3">--</span></div>
                <div class="stat-box"><span class="stat-label">Max</span><span class="stat-val" id="st-max">--</span></div>
            </div>

            <h2>Diagrama de Vela (Box Plot)</h2>
            <div id="boxPlotContainer" class="boxplot-container">
                <div style="text-align: center; padding-top: 40px; color: #444;" id="noDataMsg">Sin datos suficientes</div>
            </div>

            <h2 style="margin-top: 20px;">Distribución Normal (Gauss)</h2>
            <div style="width: 100%; height: 150px; background: #111; border: 1px solid #333;">
                <svg id="bellCurve" viewBox="0 0 300 150" preserveAspectRatio="none" style="width:100%; height:100%;"></svg>
            </div>
        </div>
    </div>

    <div id="tab-config" class="view-section">
        <div class="card">
            <h2>Gestión de Botones</h2>
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <input type="text" id="newBtnName" class="input-dark" placeholder="Nombre (ej: Cambio Molde)" style="flex:2">
                <input type="text" id="newBtnCat" class="input-dark" placeholder="Categoría (ej: SMED)" style="flex:1">
                <button class="dyn-btn" onclick="addButton()" style="border-color: var(--primary-sec);">Crear</button>
            </div>
            
            <div id="configList" style="max-height: 300px; overflow-y: auto;"></div>
            
            <div style="margin-top:10px;">
                <button class="dyn-btn" onclick="restoreDefaults()" style="width:100%; color:#888;">Restaurar Fábrica</button>
            </div>
        </div>
    </div>

    <script>
        // --- UTILIDADES ---
        const pad = (n) => n.toString().padStart(2, '0');
        const getDaySeconds = (d) => (d.getHours() * 3600) + (d.getMinutes() * 60) + d.getSeconds() + (d.getMilliseconds() / 1000);
        const formatHMS = (d) => `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;

        // --- ESTADO ---
        let laps = []; // Historial de actividades CERRADAS
        let buttons = []; // Configuración de botones
        let activeTimers = {}; // { 'Categoria': { start: timestamp, btnName: 'Nombre' } }

        function init() {
            // Cargar datos
            const sLaps = localStorage.getItem('v10_laps');
            const sBtns = localStorage.getItem('v10_btns');
            const sActive = localStorage.getItem('v10_active');

            if(sLaps) laps = JSON.parse(sLaps);
            if(sBtns) buttons = JSON.parse(sBtns);
            else restoreDefaults(false);
            if(sActive) activeTimers = JSON.parse(sActive);

            renderUI();
            setInterval(loop, 100); // Loop principal 10Hz
        }

        function saveData() {
            localStorage.setItem('v10_laps', JSON.stringify(laps));
            localStorage.setItem('v10_btns', JSON.stringify(buttons));
            localStorage.setItem('v10_active', JSON.stringify(activeTimers));
        }

        // --- LÓGICA CORE (CRONÓMETRO) ---
        function handleBtnClick(name, cat) {
            const now = Date.now();

            // 1. Revisar si hay algo corriendo en esta categoría
            if (activeTimers[cat]) {
                const prev = activeTimers[cat];
                
                // Si pulsamos el MISMO botón que ya corre, no hacemos nada (o podríamos detenerlo, aquí asumimos switch)
                if(prev.btnName === name) return; 

                // DETENER el anterior
                const duration = (now - prev.start) / 1000;
                laps.unshift({
                    id: now,
                    name: prev.btnName,
                    cat: cat,
                    duration: parseFloat(duration.toFixed(1)),
                    endTime: formatHMS(new Date())
                });
            }

            // 2. INICIAR el nuevo
            activeTimers[cat] = {
                start: now,
                btnName: name
            };

            saveData();
            renderUI();
        }

        function stopAllTimers() {
            const now = Date.now();
            for (const cat in activeTimers) {
                const prev = activeTimers[cat];
                const duration = (now - prev.start) / 1000;
                laps.unshift({
                    id: now,
                    name: prev.btnName,
                    cat: cat,
                    duration: parseFloat(duration.toFixed(1)),
                    endTime: formatHMS(new Date())
                });
            }
            activeTimers = {}; // Limpiar todo
            saveData();
            renderUI();
        }

        function deleteLap(index) {
            if(!confirm("¿Borrar registro?")) return;
            laps.splice(index, 1);
            saveData();
            renderUI();
        }

        // --- GESTIÓN BOTONES ---
        function restoreDefaults(save = true) {
            buttons = [
                { name: 'Hito Genérico', cat: 'General' },
                { name: 'Operación A', cat: 'Producción' },
                { name: 'Operación B', cat: 'Producción' },
                { name: 'Mantenimiento', cat: 'Paro' },
                { name: 'Falta Material', cat: 'Paro' },
                { name: 'Descanso', cat: 'Personal' }
            ];
            if(save) { saveData(); renderUI(); }
        }

        function addButton() {
            const name = document.getElementById('newBtnName').value;
            const cat = document.getElementById('newBtnCat').value;
            if(name && cat) {
                buttons.push({ name, cat });
                saveData(); renderUI();
            }
        }

        function removeButton(index) {
            buttons.splice(index, 1);
            saveData(); renderUI();
        }

        // --- RENDERIZADO UI ---
        function renderUI() {
            // 1. Botones
            const btnContainer = document.getElementById('dynamicButtons');
            btnContainer.innerHTML = '';
            
            buttons.forEach(btn => {
                const b = document.createElement('button');
                // Verificar si está activo
                const isActive = activeTimers[btn.cat] && activeTimers[btn.cat].btnName === btn.name;
                
                b.className = `dyn-btn ${isActive ? 'is-running' : ''}`;
                b.innerHTML = `
                    ${isActive ? '▶ ' : ''}${btn.name} 
                    <small>${btn.cat}</small>
                    ${isActive ? '<small style="color:#fff" id="timer-'+btn.cat+'">...</small>' : ''}
                `;
                b.onclick = () => handleBtnClick(btn.name, btn.cat);
                btnContainer.appendChild(b);
            });

            // 2. Timers Activos (Panel superior)
            const timerList = document.getElementById('activeTimersList');
            const catsActive = Object.keys(activeTimers);
            
            if(catsActive.length > 0) {
                timerList.style.display = 'block';
                timerList.innerHTML = '<div class="label" style="margin-bottom:5px;">ACTIVIDAD EN CURSO:</div>';
                catsActive.forEach(cat => {
                    const t = activeTimers[cat];
                    timerList.innerHTML += `
                        <div class="active-timer-row">
                            <span class="timer-cat">[${cat}]</span>
                            <span class="timer-name">${t.btnName}</span>
                            <span class="timer-val" id="panel-timer-${cat}">0.0s</span>
                        </div>
                    `;
                });
            } else {
                timerList.style.display = 'none';
            }

            // 3. Historial
            const list = document.getElementById('lapList');
            list.innerHTML = '';
            laps.forEach((l, idx) => {
                list.innerHTML += `
                    <div class="lap-item">
                        <div>
                            <span style="color:#fff">${l.name}</span> 
                            <span style="color:#666; font-size:0.7em">(${l.cat})</span>
                            <br><span style="color:#444">Fin: ${l.endTime}</span>
                        </div>
                        <div style="display:flex; align-items:center;">
                            <span class="lap-val">${l.duration}s</span>
                            <button onclick="deleteLap(${idx})" style="background:none; border:none; color:#444; margin-left:8px; cursor:pointer;">x</button>
                        </div>
                    </div>
                `;
            });

            // 4. Config List
            const conf = document.getElementById('configList');
            conf.innerHTML = '';
            buttons.forEach((btn, idx) => {
                conf.innerHTML += `
                    <div class="config-row">
                        <span>${btn.name} <small>(${btn.cat})</small></span>
                        <button class="dyn-btn" style="padding:2px 5px; color:var(--danger); border-color:var(--danger);" onclick="removeButton(${idx})">Borrar</button>
                    </div>
                `;
            });

            // 5. Filtros Stats
            updateFilterOptions();
            calculateStats(); // Refrescar gráficos
        }

        // --- LOOP (Actualiza contadores visuales) ---
        function loop() {
            const now = new Date();
            const nowTs = Date.now();
            
            // Reloj Maestro
            document.getElementById('mainSeconds').innerText = getDaySeconds(now).toFixed(1);
            document.getElementById('mainTime').innerText = formatHMS(now);

            // Actualizar contadores visuales de botones activos
            for (const cat in activeTimers) {
                const t = activeTimers[cat];
                const elBtn = document.getElementById(`timer-${cat}`);
                const elPanel = document.getElementById(`panel-timer-${cat}`);
                const val = ((nowTs - t.start) / 1000).toFixed(1) + 's';
                
                if(elBtn) elBtn.innerText = val;
                if(elPanel) elPanel.innerText = val;
            }
        }

        // --- ESTADÍSTICAS ---
        function updateFilterOptions() {
            const sel = document.getElementById('statsFilter');
            const current = sel.value;
            
            // Recopilar únicos
            const cats = [...new Set(laps.map(l => l.cat))];
            const names = [...new Set(laps.map(l => l.name))];

            let html = '<option value="ALL">Todo el Historial</option>';
            
            if(cats.length) {
                html += '<optgroup label="Por Categoría">';
                cats.forEach(c => html += `<option value="CAT:${c}">${c}</option>`);
                html += '</optgroup>';
            }
            if(names.length) {
                html += '<optgroup label="Por Actividad">';
                names.forEach(n => html += `<option value="NAME:${n}">${n}</option>`);
                html += '</optgroup>';
            }
            
            sel.innerHTML = html;
            sel.value = current;
        }

        function calculateStats() {
            const filter = document.getElementById('statsFilter').value;
            let values = [];

            // Filtrado
            if(filter === 'ALL') values = laps.map(l => l.duration);
            else if(filter.startsWith('CAT:')) values = laps.filter(l => l.cat === filter.split(':')[1]).map(l => l.duration);
            else if(filter.startsWith('NAME:')) values = laps.filter(l => l.name === filter.split(':')[1]).map(l => l.duration);

            values = values.sort((a,b) => a-b);

            // Render Gráficos
            if(values.length < 2) {
                document.getElementById('noDataMsg').style.display = 'block';
                document.getElementById('bellCurve').innerHTML = '';
                return;
            }
            document.getElementById('noDataMsg').style.display = 'none';

            // Quartiles
            const q1Pos = Math.floor(values.length * 0.25);
            const medPos = Math.floor(values.length * 0.50);
            const q3Pos = Math.floor(values.length * 0.75);

            const min = values[0];
            const max = values[values.length - 1];
            const q1 = values[q1Pos];
            const med = values[medPos];
            const q3 = values[q3Pos];

            document.getElementById('st-min').innerText = min;
            document.getElementById('st-q1').innerText = q1;
            document.getElementById('st-med').innerText = med;
            document.getElementById('st-q3').innerText = q3;
            document.getElementById('st-max').innerText = max;

            drawBoxPlot(min, q1, med, q3, max);
            drawBellCurve(values);
        }

        function drawBoxPlot(min, q1, med, q3, max) {
            const container = document.getElementById('boxPlotContainer');
            const range = max - min || 1;
            // Mapear 0-100% con padding 5%
            const getPct = (val) => ((val - min) / range) * 90 + 5;

            const pMin = getPct(min); const pQ1 = getPct(q1);
            const pMed = getPct(med); const pQ3 = getPct(q3);
            const pMax = getPct(max);

            container.innerHTML = `
                <div class="boxplot-track">
                    <div class="bp-whisker" style="left:${pMin}%"></div>
                    <div class="bp-line" style="left:${pMin}%; width:${pQ1-pMin}%"></div>
                    <div class="bp-box" style="left:${pQ1}%; width:${pQ3-pQ1}%"></div>
                    <div class="bp-median" style="left:${pMed}%"></div>
                    <div class="bp-line" style="left:${pQ3}%; width:${pMax-pQ3}%"></div>
                    <div class="bp-whisker" style="left:${pMax}%"></div>
                    
                    <div class="bp-label" style="left:${pMin}%">${min}</div>
                    <div class="bp-label" style="left:${pMed}%; top:-20px; color:#fff;">${med}</div>
                    <div class="bp-label" style="left:${pMax}%">${max}</div>
                </div>
            `;
        }

        function drawBellCurve(values) {
            const n = values.length;
            const mean = values.reduce((a,b)=>a+b,0)/n;
            const stdDev = Math.sqrt(values.map(x=>Math.pow(x-mean,2)).reduce((a,b)=>a+b)/n) || 0.1;

            const startX = Math.min(...values) - stdDev;
            const endX = Math.max(...values) + stdDev;
            
            const w = 300, h = 150, pad = 10;
            let points = []; let maxY = 0;

            for(let x=startX; x<=endX; x+=(endX-startX)/50) {
                const y = (1/(stdDev*Math.sqrt(2*Math.PI))) * Math.exp(-0.5*Math.pow((x-mean)/stdDev, 2));
                if(y>maxY) maxY=y;
                points.push({x,y});
            }

            const mapX = (v) => ((v-startX)/(endX-startX))*(w-2*pad) + pad;
            const mapY = (v) => h - pad - ((v/maxY)*(h-2*pad));

            let d = `M ${mapX(points[0].x)} ${mapY(points[0].y)}`;
            points.forEach(p => d += ` L ${mapX(p.x)} ${mapY(p.y)}`);
            const dArea = d + ` L ${mapX(points[points.length-1].x)} ${h} L ${mapX(points[0].x)} ${h} Z`;

            document.getElementById('bellCurve').innerHTML = `
                <path d="${dArea}" style="fill:rgba(0,255,157,0.1); stroke:none;" />
                <path d="${d}" style="fill:none; stroke:#00d4ff; stroke-width:2;" />
                <line x1="${mapX(mean)}" y1="10" x2="${mapX(mean)}" y2="${h}" style="stroke:#fff; stroke-dasharray:4; opacity:0.5" />
            `;
        }

        // --- EXPORT/IMPORT/RESET ---
        function clearAllData() {
            if(confirm("¿Borrar TODO?")) {
                laps = []; activeTimers = {};
                saveData(); init();
            }
        }
        function exportCSV() {
            let csv = "data:text/csv;charset=utf-8,ID_Timestamp,Actividad,Categoria,Duracion(s),HoraFin\n";
            laps.forEach(l => csv += `${l.id},${l.name},${l.cat},${l.duration},${l.endTime}\n`);
            const link = document.createElement("a");
            link.href = encodeURI(csv); link.download = "crono_industrial.csv"; link.click();
        }
        function importCSV(input) {
            const f = input.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = e => {
                const lines = e.target.result.split('\n').slice(1);
                laps = [];
                lines.forEach(line => {
                    const c = line.split(',');
                    if(c.length>=5) laps.push({id:parseInt(c[0]), name:c[1], cat:c[2], duration:parseFloat(c[3]), endTime:c[4]});
                });
                saveData(); renderUI();
            };
            r.readAsText(f);
        }
        function switchTab(t) {
            document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active'));
            document.getElementById('tab-'+t).classList.add('active');
            document.querySelector(`button[onclick="switchTab('${t}')"]`).classList.add('active');
            if(t==='stats') calculateStats();
        }

        // INIT
        init();

    </script>
</body>
</html>
