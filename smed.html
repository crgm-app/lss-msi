<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cronómetro Industrial V9 Analytics</title>
    <style>
        :root {
            --bg-color: #0a0a0a;
            --card-bg: #141414;
            --text-muted: #666;
            --text-bright: #e0e0e0;
            --primary-sec: #00ff9d;
            --secondary-time: #00d4ff;
            --accent-lap: #fff;
            --danger: #ff4444;
            --border: #2a2a2a;
            --tab-active: #222;
            --cat-color: #ffaa00;
        }

        body {
            font-family: 'Consolas', 'Monaco', monospace;
            background-color: var(--bg-color);
            color: var(--text-bright);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            margin: 0;
            font-size: 12px;
        }

        /* --- TABS --- */
        .tab-nav {
            display: flex; gap: 5px; width: 100%; max-width: 650px; margin-bottom: 10px;
        }
        .tab-btn {
            flex: 1; background: var(--card-bg); border: 1px solid var(--border);
            color: var(--text-muted); padding: 8px; cursor: pointer;
            text-transform: uppercase; font-family: inherit; font-weight: bold; font-size: 0.75rem;
        }
        .tab-btn.active {
            background: var(--tab-active); color: var(--primary-sec); border-bottom: 2px solid var(--primary-sec);
        }

        .view-section { display: none; width: 100%; max-width: 650px; gap: 8px; flex-direction: column; }
        .view-section.active { display: flex; }

        /* --- ESTILOS GENERALES --- */
        h2 { font-size: 0.75rem; color: var(--text-muted); margin: 0 0 5px 0; font-weight: normal; text-transform: uppercase; border-bottom: 1px solid var(--border); padding-bottom: 2px;}

        .card { background-color: var(--card-bg); border: 1px solid var(--border); padding: 10px; border-radius: 4px; }

        .row { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 4px; border-bottom: 1px solid #222; padding-bottom: 2px; }
        .row:last-child { border-bottom: none; }

        .sec-display { font-size: 1.2rem; color: var(--primary-sec); font-weight: bold; line-height: 1.1; }
        .sec-display-huge { font-size: 2.5rem; color: var(--primary-sec); font-weight: bold; text-align: center; line-height: 1; margin: 5px 0; }
        .time-display { font-size: 0.8rem; color: var(--secondary-time); text-align: right; }
        .label { font-size: 0.65rem; color: var(--text-muted); display: block; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.75rem; margin-top: 2px; }
        th, td { border: 1px solid #333; padding: 4px 6px; text-align: right; }
        th { background-color: #1f1f1f; text-align: center; color: #888; font-weight: normal; }
        td:first-child { text-align: left; color: #aaa; }
        td.col-sec { color: var(--primary-sec); font-weight: bold; }

        /* --- BOTONERA DINÁMICA --- */
        .dynamic-btn-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; margin-bottom: 10px;
        }
        .dyn-btn {
            background: #222; border: 1px solid #444; color: #fff; padding: 10px 5px;
            cursor: pointer; border-radius: 4px; font-family: inherit; font-size: 0.8rem;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: all 0.1s;
        }
        .dyn-btn:active { transform: translateY(2px); background: #333; }
        .dyn-btn small { font-size: 0.6rem; color: var(--cat-color); margin-top: 2px; }

        /* --- CONFIGURACIÓN --- */
        .config-form { display: flex; gap: 5px; margin-bottom: 10px; align-items: center; }
        .input-dark { background: #111; border: 1px solid #333; color: #fff; padding: 5px; font-family: inherit; }
        .btn-list-item { display: flex; justify-content: space-between; padding: 5px; border-bottom: 1px solid #222; align-items: center; }

        /* --- LISTA DE LAPS --- */
        .lap-list-container { max-height: 250px; overflow-y: auto; border-top: 1px solid var(--border); margin-top: 5px; }
        .lap-item { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; border-bottom: 1px solid #222; font-size: 0.75rem; }
        .lap-info { display: flex; flex-direction: column; }
        .lap-cat-tag { font-size: 0.6rem; color: var(--cat-color); }
        .lap-vals { text-align: right; }
        .val-delta { color: var(--primary-sec); font-weight: bold; margin-left: 5px; }
        .val-cat-delta { color: var(--cat-color); font-weight: bold; margin-left: 5px; font-size: 0.7rem; }

        /* --- STATS --- */
        .filter-bar { margin-bottom: 15px; background: #1a1a1a; padding: 10px; border-radius: 4px; }
        .stats-summary { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-bottom: 15px; text-align: center; }
        .stat-box { background: #1a1a1a; padding: 5px; border: 1px solid #333; border-radius: 3px;}
        .stat-label { font-size: 0.65rem; color: #666; display: block;}
        .stat-val { font-size: 0.9rem; color: var(--primary-sec); font-weight: bold;}
        
        .chart-container { width: 100%; height: 180px; position: relative; background: #111; border: 1px solid #333; margin-top: 10px; }
        
        /* Box Plot CSS */
        .boxplot-track { position: relative; height: 40px; width: 90%; margin: 30px auto; border-bottom: 1px solid #333; }
        .bp-line { position: absolute; top: 50%; height: 2px; background: #555; transform: translateY(-50%); }
        .bp-box { position: absolute; top: 20%; height: 60%; background: rgba(0, 255, 157, 0.2); border: 1px solid var(--primary-sec); }
        .bp-median { position: absolute; top: 10%; height: 80%; width: 2px; background: #fff; }
        .bp-whisker { position: absolute; top: 30%; height: 40%; width: 2px; background: #555; }
        .bp-label { position: absolute; top: 110%; font-size: 0.6rem; color: #888; transform: translateX(-50%); }

        /* SVG */
        svg { width: 100%; height: 100%; }
        path { fill: none; stroke: var(--secondary-time); stroke-width: 2; }
        .area-fill { fill: rgba(0, 212, 255, 0.1); stroke: none; }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }
    </style>
</head>
<body>

    <div class="tab-nav">
        <button class="tab-btn active" onclick="switchTab('main')">Reloj</button>
        <button class="tab-btn" onclick="switchTab('stats')">Estadísticas</button>
        <button class="tab-btn" onclick="switchTab('config')">Configurar Botones</button>
    </div>

    <div id="tab-main" class="view-section active">
        
        <div class="card">
            <h2>Tiempo Real</h2>
            <div class="sec-display-huge" id="mainSeconds">00000.0</div>
            <div style="text-align: center; margin-bottom: 10px;">
                <span class="time-display" style="font-size: 1rem;" id="mainTime">00:00:00</span>
            </div>

            <div id="dynamicButtons" class="dynamic-btn-grid">
                </div>

            <div style="text-align: center; margin-bottom: 5px;">
                <button class="dyn-btn" style="width: 100%; padding: 5px;" onclick="addLap('Hito Simple', 'General')">
                    + Hito Genérico
                </button>
            </div>

            <div style="display:flex; justify-content:center; gap:5px; margin-bottom:5px; flex-wrap:wrap;">
                <button class="dyn-btn" style="padding:4px 8px; font-size:0.7rem;" onclick="exportCSV()">CSV Export</button>
                <button class="dyn-btn" style="padding:4px 8px; font-size:0.7rem;" onclick="document.getElementById('fileInput').click()">CSV Import</button>
                <button class="dyn-btn" style="padding:4px 8px; font-size:0.7rem; border-color:var(--danger); color:var(--danger);" onclick="clearAllLaps()">Reset Todo</button>
                <input type="file" id="fileInput" accept=".csv" style="display: none;" onchange="importCSV(this)">
            </div>
            
            <div class="lap-list-container" id="lapList"></div>
        </div>

        <div class="card">
            <h2>Cuenta Regresiva</h2>
            <div class="row">
                <div><span class="label">Prox. 10-Min</span><div class="sec-display" style="color: #ffaa00;" id="remTen">0.0</div></div>
                <div><span class="label">Prox. Hora</span><div class="sec-display" style="color: #ff5555;" id="remHour">0.0</div></div>
            </div>
        </div>
    </div>

    <div id="tab-stats" class="view-section">
        <div class="card">
            <h2>Filtros de Análisis</h2>
            <div class="filter-bar">
                <label class="label" style="margin-bottom:5px;">Selecciona qué analizar:</label>
                <select id="statsFilter" class="input-dark" style="width:100%;" onchange="calculateStats()">
                    <option value="ALL">Todo (Global Deltas)</option>
                    </select>
                <div class="label" style="margin-top:5px; color:#888;">
                    * Analiza "Deltas Globales" o "Deltas de Categoría" según selección.
                </div>
            </div>
            
            <div class="stats-summary">
                <div class="stat-box"><span class="stat-label">Min</span><span class="stat-val" id="st-min">--</span></div>
                <div class="stat-box"><span class="stat-label">Q1</span><span class="stat-val" id="st-q1">--</span></div>
                <div class="stat-box"><span class="stat-label">Med</span><span class="stat-val" id="st-med">--</span></div>
                <div class="stat-box"><span class="stat-label">Q3</span><span class="stat-val" id="st-q3">--</span></div>
                <div class="stat-box"><span class="stat-label">Max</span><span class="stat-val" id="st-max">--</span></div>
            </div>

            <h2>Diagrama de Vela (Box Plot)</h2>
            <div id="boxPlotContainer" style="height: 100px; position: relative; background: #111; border: 1px solid #333;">
                <div style="text-align: center; padding-top: 40px; color: #444;" id="noDataMsg">Sin datos</div>
            </div>

            <h2 style="margin-top: 20px;">Distribución (Curva de Gauss)</h2>
            <div class="chart-container">
                <svg id="bellCurve" viewBox="0 0 300 150" preserveAspectRatio="none"></svg>
            </div>
        </div>
    </div>

    <div id="tab-config" class="view-section">
        <div class="card">
            <h2>Crear Botón Personalizado</h2>
            <div class="config-form">
                <input type="text" id="newBtnName" class="input-dark" placeholder="Nombre (ej: Paro)" style="flex:2">
                <input type="text" id="newBtnCat" class="input-dark" placeholder="Categoría (ej: Mant)" style="flex:1">
                <button class="dyn-btn" onclick="addCustomButton()" style="border-color: var(--primary-sec);">Crear</button>
            </div>
            
            <h2>Botones Activos</h2>
            <div id="configList" style="max-height: 300px; overflow-y: auto;">
                </div>
            
            <div style="margin-top:10px;">
                <button class="dyn-btn" onclick="restoreDefaultButtons()" style="width:100%; color:#888;">Restaurar Predeterminados</button>
            </div>
        </div>
    </div>

    <script>
        // --- UTILIDADES ---
        const pad = (n) => n.toString().padStart(2, '0');
        const getDaySeconds = (d) => (d.getHours() * 3600) + (d.getMinutes() * 60) + d.getSeconds() + (d.getMilliseconds() / 1000);
        const formatHMS = (d) => `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;

        // --- ESTADO & PERSISTENCIA ---
        let laps = [];
        let customButtons = [];
        let lastTimestampGlobal = Date.now();
        // Mapa para rastrear el último timestamp por categoría
        let lastTimestampByCat = {}; 

        function init() {
            // Cargar Laps
            const storedLaps = localStorage.getItem('ind_clock_laps_v9');
            if (storedLaps) {
                laps = JSON.parse(storedLaps);
                if(laps.length > 0) lastTimestampGlobal = laps[0].id;
                
                // Reconstruir mapa de categorías basado en historial
                // Recorremos de atrás para adelante para encontrar el último de cada cat
                for(let i = laps.length -1; i >= 0; i--) {
                    const l = laps[i];
                    if(!lastTimestampByCat[l.cat]) lastTimestampByCat[l.cat] = l.id;
                }
            }

            // Cargar Botones
            const storedBtns = localStorage.getItem('ind_clock_btns_v9');
            if (storedBtns) {
                customButtons = JSON.parse(storedBtns);
            } else {
                restoreDefaultButtons(false);
            }

            renderButtons();
            renderConfigList();
            renderLaps();
            updateFilterOptions();
            calculateStats();
        }

        function saveData() {
            localStorage.setItem('ind_clock_laps_v9', JSON.stringify(laps));
            localStorage.setItem('ind_clock_btns_v9', JSON.stringify(customButtons));
            updateFilterOptions(); // Actualizar filtros si hay nuevos tipos
        }

        // --- GESTIÓN DE BOTONES ---
        function restoreDefaultButtons(save = true) {
            customButtons = [
                { name: 'Inicio Op.', cat: 'Operación' },
                { name: 'Fin Op.', cat: 'Operación' },
                { name: 'Mantenimiento', cat: 'Paro' },
                { name: 'Falla Material', cat: 'Paro' },
                { name: 'Descanso', cat: 'Personal' }
            ];
            if(save) {
                saveData();
                renderButtons();
                renderConfigList();
            }
        }

        function addCustomButton() {
            const name = document.getElementById('newBtnName').value.trim();
            const cat = document.getElementById('newBtnCat').value.trim();
            if(!name || !cat) return alert("Nombre y Categoría requeridos");

            customButtons.push({ name, cat });
            document.getElementById('newBtnName').value = '';
            document.getElementById('newBtnCat').value = '';
            saveData();
            renderButtons();
            renderConfigList();
        }

        function removeButton(index) {
            customButtons.splice(index, 1);
            saveData();
            renderButtons();
            renderConfigList();
        }

        function renderButtons() {
            const container = document.getElementById('dynamicButtons');
            container.innerHTML = '';
            customButtons.forEach(btn => {
                const b = document.createElement('button');
                b.className = 'dyn-btn';
                b.innerHTML = `${btn.name} <small>${btn.cat}</small>`;
                b.onclick = () => addLap(btn.name, btn.cat);
                container.appendChild(b);
            });
        }

        function renderConfigList() {
            const container = document.getElementById('configList');
            container.innerHTML = '';
            customButtons.forEach((btn, idx) => {
                const div = document.createElement('div');
                div.className = 'btn-list-item';
                div.innerHTML = `
                    <span>${btn.name} <span style="color:#ffaa00; font-size:0.8em">(${btn.cat})</span></span>
                    <button class="dyn-btn" style="color:var(--danger); border-color:var(--danger); padding:2px 6px;" onclick="removeButton(${idx})">Eliminar</button>
                `;
                container.appendChild(div);
            });
        }

        // --- LÓGICA DE LAPS (DELTA GLOBAL + CATEGORÍA) ---
        function addLap(name, cat) {
            const now = new Date();
            const nowTs = Date.now();
            
            // 1. Delta Global
            let diffGlobal = (nowTs - lastTimestampGlobal) / 1000;
            if (laps.length === 0 || diffGlobal < 0) diffGlobal = 0;
            
            // 2. Delta Categoría (Stop Logic)
            let diffCat = 0;
            const lastCatTs = lastTimestampByCat[cat];
            if (lastCatTs) {
                diffCat = (nowTs - lastCatTs) / 1000;
                if (diffCat < 0) diffCat = 0;
            } else {
                // Primera vez que se usa esta categoría
                diffCat = 0; 
            }

            // Actualizar referencias
            lastTimestampGlobal = nowTs;
            lastTimestampByCat[cat] = nowTs;

            const newLap = {
                id: nowTs,
                name: name,
                cat: cat,
                deltaG: parseFloat(diffGlobal.toFixed(1)),
                deltaC: parseFloat(diffCat.toFixed(1)),
                abs: getDaySeconds(now).toFixed(1)
            };
            
            laps.unshift(newLap);
            renderLaps();
            saveData();
            calculateStats(); // Recalcular stats en tiempo real
        }

        function deleteLap(id) {
            if(!confirm("¿Borrar registro?")) return;
            laps = laps.filter(l => l.id !== id);
            saveData();
            renderLaps();
            calculateStats();
        }

        function clearAllLaps() {
            if(!confirm("¿Borrar TODO?")) return;
            laps = [];
            lastTimestampGlobal = Date.now();
            lastTimestampByCat = {};
            saveData();
            renderLaps();
            calculateStats();
        }

        function renderLaps() {
            const container = document.getElementById('lapList');
            container.innerHTML = '';

            laps.forEach(lap => {
                const row = document.createElement('div');
                row.className = 'lap-item';
                
                row.innerHTML = `
                    <div class="lap-info">
                        <span style="color:#fff; font-weight:bold;">${lap.name}</span>
                        <span class="lap-cat-tag">${lap.cat}</span>
                        <span style="color:#555; font-family:monospace;">Abs: ${lap.abs}</span>
                    </div>
                    <div class="lap-vals">
                        <div>Glo: <span class="val-delta">+${lap.deltaG}s</span></div>
                        <div>${lap.cat}: <span class="val-cat-delta">+${lap.deltaC}s</span></div>
                    </div>
                    <button onclick="deleteLap(${lap.id})" style="background:none; border:none; color:#444; margin-left:10px; cursor:pointer;">x</button>
                `;
                container.appendChild(row);
            });
        }

        // --- ESTADÍSTICAS AVANZADAS ---
        function updateFilterOptions() {
            const select = document.getElementById('statsFilter');
            const currentVal = select.value;
            
            // Obtener listas únicas
            const cats = [...new Set(laps.map(l => l.cat))];
            const names = [...new Set(laps.map(l => l.name))];

            select.innerHTML = '<option value="ALL">Todo (Global Deltas)</option>';
            
            if(cats.length > 0) {
                const grp = document.createElement('optgroup');
                grp.label = "--- Por Categoría (Ciclos) ---";
                cats.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = `CAT:${c}`;
                    opt.innerText = `Categoría: ${c}`;
                    grp.appendChild(opt);
                });
                select.appendChild(grp);
            }

            if(names.length > 0) {
                const grp2 = document.createElement('optgroup');
                grp2.label = "--- Por Botón Específico ---";
                names.forEach(n => {
                    const opt = document.createElement('option');
                    opt.value = `NAME:${n}`;
                    opt.innerText = `Botón: ${n}`;
                    grp2.appendChild(opt);
                });
                select.appendChild(grp2);
            }
            
            // Intentar mantener selección
            select.value = currentVal;
            if(select.selectedIndex === -1) select.selectedIndex = 0;
        }

        function calculateStats() {
            const filter = document.getElementById('statsFilter').value;
            let dataValues = [];

            // Filtrado Lógico
            if (filter === 'ALL') {
                // Usamos Delta Global de todos (menos los que sean 0 iniciales si se desea)
                dataValues = laps.map(l => l.deltaG).filter(v => v > 0);
            } else if (filter.startsWith('CAT:')) {
                const targetCat = filter.split(':')[1];
                // Usamos Delta Categoria
                dataValues = laps.filter(l => l.cat === targetCat).map(l => l.deltaC).filter(v => v > 0);
            } else if (filter.startsWith('NAME:')) {
                const targetName = filter.split(':')[1];
                // Usamos Delta Global (tiempo hasta llegar a este botón) o Delta Categoria?
                // Interpretación: Cuánto tarda en llegar a este botón. Usaremos Delta Categoria para ser consistentes con ciclos.
                dataValues = laps.filter(l => l.name === targetName).map(l => l.deltaC).filter(v => v > 0);
            }

            dataValues.sort((a, b) => a - b);

            // Renderizado
            if (dataValues.length < 2) {
                document.getElementById('noDataMsg').style.display = 'block';
                document.getElementById('bellCurve').innerHTML = '';
                ['min','q1','med','q3','max'].forEach(id => document.getElementById(`st-${id}`).innerText = '--');
                // Limpiar Box Plot
                const boxContainer = document.getElementById('boxPlotContainer');
                boxContainer.innerHTML = '<div style="text-align: center; padding-top: 40px; color: #444;" id="noDataMsg">Insuficientes datos</div>';
                return;
            }

            document.getElementById('noDataMsg').style.display = 'none';

            // Cálculos
            const q1Pos = Math.floor(dataValues.length * 0.25);
            const medPos = Math.floor(dataValues.length * 0.50);
            const q3Pos = Math.floor(dataValues.length * 0.75);

            const min = dataValues[0];
            const max = dataValues[dataValues.length - 1];
            const q1 = dataValues[q1Pos];
            const med = dataValues[medPos];
            const q3 = dataValues[q3Pos];

            document.getElementById('st-min').innerText = min;
            document.getElementById('st-q1').innerText = q1;
            document.getElementById('st-med').innerText = med;
            document.getElementById('st-q3').innerText = q3;
            document.getElementById('st-max').innerText = max;

            drawBoxPlot(min, q1, med, q3, max);
            drawBellCurve(dataValues);
        }

        function drawBoxPlot(min, q1, med, q3, max) {
            const container = document.getElementById('boxPlotContainer');
            container.innerHTML = '';
            
            const range = max - min || 1;
            const getPct = (val) => ((val - min) / range) * 90 + 5;

            const pMin = getPct(min);
            const pQ1 = getPct(q1);
            const pMed = getPct(med);
            const pQ3 = getPct(q3);
            const pMax = getPct(max);

            const html = `
                <div class="boxplot-track">
                    <div class="bp-whisker" style="left: ${pMin}%;"></div>
                    <div class="bp-line" style="left: ${pMin}%; width: ${pQ1 - pMin}%;"></div>
                    <div class="bp-box" style="left: ${pQ1}%; width: ${pQ3 - pQ1}%;"></div>
                    <div class="bp-median" style="left: ${pMed}%;"></div>
                    <div class="bp-line" style="left: ${pQ3}%; width: ${pMax - pQ3}%;"></div>
                    <div class="bp-whisker" style="left: ${pMax}%;"></div>
                    
                    <div class="bp-label" style="left: ${pMin}%; top: 110%;">${min}</div>
                    <div class="bp-label" style="left: ${pMed}%; top: -35%; color: #fff;">${med}</div>
                    <div class="bp-label" style="left: ${pMax}%; top: 110%;">${max}</div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        }

        function drawBellCurve(values) {
            const n = values.length;
            const mean = values.reduce((a, b) => a + b, 0) / n;
            const stdDev = Math.sqrt(values.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b) / n) || 1;

            const svg = document.getElementById('bellCurve');
            const startX = Math.min(...values) - (stdDev); 
            const endX = Math.max(...values) + (stdDev);
            const step = (endX - startX) / 40;
            
            let points = [];
            let maxY = 0;

            for (let x = startX; x <= endX; x += step) {
                const y = (1 / (stdDev * Math.sqrt(2 * Math.PI))) * Math.exp(-0.5 * Math.pow((x - mean) / stdDev, 2));
                if (y > maxY) maxY = y;
                points.push({x, y});
            }

            const width = 300; const height = 150; const padding = 20;
            const mapX = (val) => ((val - startX) / (endX - startX)) * (width - 2*padding) + padding;
            const mapY = (val) => height - padding - ((val / maxY) * (height - 2*padding));

            let d = `M ${mapX(points[0].x)} ${mapY(points[0].y)}`;
            points.forEach(p => { d += ` L ${mapX(p.x)} ${mapY(p.y)}`; });
            const dFill = d + ` L ${mapX(points[points.length-1].x)} ${height} L ${mapX(points[0].x)} ${height} Z`;

            svg.innerHTML = `
                <path d="${dFill}" class="area-fill" />
                <path d="${d}" stroke="#00d4ff" fill="none" />
                <line x1="${mapX(mean)}" y1="${height-20}" x2="${mapX(mean)}" y2="${20}" stroke="#fff" stroke-dasharray="4" opacity="0.5" />
                <text x="${mapX(mean)}" y="15" fill="#fff" font-size="10" text-anchor="middle">μ ${mean.toFixed(1)}</text>
            `;
        }

        // --- EXPORT/IMPORT ---
        function exportCSV() {
            if(laps.length === 0) return alert("Sin datos");
            let csv = "data:text/csv;charset=utf-8,ID,Nombre,Categoria,Delta_Global,Delta_Categoria,Absoluto\n";
            laps.forEach(l => csv += `${l.id},${l.name},${l.cat},${l.deltaG},${l.deltaC},${l.abs}\n`);
            const link = document.createElement("a");
            link.href = encodeURI(csv);
            link.download = "crono_v9.csv";
            link.click();
        }

        function importCSV(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const rows = e.target.result.split('\n').slice(1);
                const newLaps = [];
                rows.forEach(r => {
                    if(!r.trim()) return;
                    const c = r.split(',');
                    if(c.length >= 6) {
                        newLaps.push({
                            id: parseInt(c[0]), name: c[1], cat: c[2],
                            deltaG: parseFloat(c[3]), deltaC: parseFloat(c[4]), abs: c[5]
                        });
                    }
                });
                laps = newLaps;
                saveData(); init();
            };
            reader.readAsText(file);
        }

        function switchTab(t) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
            document.querySelector(`.tab-btn[onclick="switchTab('${t}')"]`).classList.add('active');
            document.getElementById(`tab-${t}`).classList.add('active');
        }

        // --- RELOJ ---
        function updateClock() {
            const now = new Date();
            const nowSec = getDaySeconds(now);
            const m = now.getMinutes();
            const nextTen = new Date(now); 
            nextTen.setMinutes((Math.floor(m/10)*10)+10,0,0);
            const nextHour = new Date(now); 
            nextHour.setHours(now.getHours()+1,0,0,0);

            document.getElementById('mainSeconds').innerText = nowSec.toFixed(1);
            document.getElementById('mainTime').innerText = formatHMS(now);
            document.getElementById('remTen').innerText = ((nextTen - now)/1000).toFixed(1);
            document.getElementById('remHour').innerText = ((nextHour - now)/1000).toFixed(1);
        }

        // INIT
        init();
        setInterval(updateClock, 50);
        updateClock();

    </script>
</body>
</html>
