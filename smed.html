<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cron√≥metro Industrial V11</title>
    <style>
        :root {
            --bg-color: #0a0a0a;
            --card-bg: #141414;
            --text-muted: #666;
            --text-bright: #e0e0e0;
            --primary-sec: #00ff9d;
            --secondary-time: #00d4ff;
            --active-run: #ffaa00;
            --danger: #ff4444;
            --edit-mode: #ffff00;
            --border: #2a2a2a;
            --tab-active: #222;
        }

        body {
            font-family: 'Consolas', 'Monaco', monospace;
            background-color: var(--bg-color);
            color: var(--text-bright);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            margin: 0;
            font-size: 12px;
        }

        /* TABS */
        .tab-nav { display: flex; gap: 5px; width: 100%; max-width: 650px; margin-bottom: 10px; }
        .tab-btn {
            flex: 1; background: var(--card-bg); border: 1px solid var(--border);
            color: var(--text-muted); padding: 8px; cursor: pointer;
            text-transform: uppercase; font-family: inherit; font-weight: bold; font-size: 0.75rem;
        }
        .tab-btn.active { background: var(--tab-active); color: var(--primary-sec); border-bottom: 2px solid var(--primary-sec); }

        .view-section { display: none; width: 100%; max-width: 650px; gap: 8px; flex-direction: column; }
        .view-section.active { display: flex; }

        /* GENERAL */
        h2 { font-size: 0.75rem; color: var(--text-muted); margin: 0 0 5px 0; font-weight: normal; text-transform: uppercase; border-bottom: 1px solid var(--border); padding-bottom: 2px;}
        .card { background-color: var(--card-bg); border: 1px solid var(--border); padding: 10px; border-radius: 4px; }
        
        .sec-display-huge { font-size: 2.5rem; color: var(--primary-sec); font-weight: bold; text-align: center; line-height: 1; margin: 5px 0; }
        .time-display { font-size: 0.8rem; color: var(--secondary-time); text-align: right; }
        
        /* BOTONERA */
        .dynamic-btn-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; margin-bottom: 10px; }
        .dyn-btn {
            background: #222; border: 1px solid #444; color: #fff; padding: 10px 5px;
            cursor: pointer; border-radius: 4px; font-family: inherit; font-size: 0.8rem;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: all 0.1s;
        }
        .dyn-btn:active { transform: translateY(2px); }
        .dyn-btn small { font-size: 0.6rem; color: #888; margin-top: 2px; }
        .dyn-btn.is-running { border-color: var(--active-run); background: #2a2200; color: var(--active-run); box-shadow: 0 0 5px rgba(255, 170, 0, 0.2); }

        /* PANELES ACTIVOS */
        .active-timers-panel { margin-bottom: 10px; border: 1px dashed #333; padding: 5px; border-radius: 4px; }
        .active-timer-row { display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 2px; }
        .timer-cat { color: #888; }
        .timer-name { color: var(--active-run); font-weight: bold; }
        .timer-val { color: #fff; font-family: monospace; }

        /* LISTA HISTORIAL */
        .lap-list-container { max-height: 200px; overflow-y: auto; border-top: 1px solid var(--border); margin-top: 5px; }
        .lap-item { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; border-bottom: 1px solid #222; font-size: 0.75rem; }
        .lap-val { color: var(--primary-sec); font-weight: bold; }

        /* STATS */
        .stats-summary { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-bottom: 15px; text-align: center; }
        .stat-box { background: #1a1a1a; padding: 5px; border: 1px solid #333; border-radius: 3px;}
        .stat-label { font-size: 0.65rem; color: #666; display: block;}
        .stat-val { font-size: 0.9rem; color: var(--primary-sec); font-weight: bold;}

        /* GR√ÅFICOS */
        .boxplot-container { height: 80px; position: relative; background: #111; border: 1px solid #333; margin-top: 10px; margin-bottom: 15px;}
        .boxplot-track { position: relative; height: 40px; width: 90%; margin: 20px auto; }
        .bp-line { position: absolute; top: 50%; height: 1px; background: #555; }
        .bp-box { position: absolute; top: 20%; height: 60%; background: rgba(0, 255, 157, 0.2); border: 1px solid var(--primary-sec); }
        .bp-median { position: absolute; top: 20%; height: 60%; width: 2px; background: #fff; z-index: 2;}
        .bp-whisker { position: absolute; top: 30%; height: 40%; width: 1px; background: #888; }
        .bp-label { position: absolute; top: 110%; font-size: 0.6rem; color: #888; transform: translateX(-50%); }

        /* CONFIG */
        .config-row { display: flex; justify-content: space-between; padding: 5px; border-bottom: 1px solid #222; align-items: center; }
        .input-dark { background: #111; border: 1px solid #333; color: #fff; padding: 5px; font-family: inherit; }
        .input-dark:focus { border-color: var(--primary-sec); outline: none; }
        .edit-mode input { border-color: var(--edit-mode); color: var(--edit-mode); }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }
    </style>
</head>
<body>

    <div class="tab-nav">
        <button class="tab-btn active" onclick="switchTab('main')">Reloj</button>
        <button class="tab-btn" onclick="switchTab('stats')">Estad√≠sticas</button>
        <button class="tab-btn" onclick="switchTab('config')">Configurar</button>
    </div>

    <div id="tab-main" class="view-section active">
        <div class="card">
            <h2>Tiempo Maestro</h2>
            <div class="sec-display-huge" id="mainSeconds">00000.0</div>
            <div style="text-align: center; margin-bottom: 10px;">
                <span class="time-display" id="mainTime">00:00:00</span>
            </div>

            <div id="activeTimersList" class="active-timers-panel" style="display:none;"></div>

            <div id="dynamicButtons" class="dynamic-btn-grid"></div>

            <div style="display:flex; justify-content:center; gap:5px; margin-top:10px;">
                <button class="dyn-btn" style="padding:5px 10px;" onclick="stopAllTimers()">‚èπ DETENER TODO</button>
                <button class="dyn-btn" style="padding:5px 10px; color:var(--danger); border-color:var(--danger);" onclick="clearAllData()">Reset</button>
            </div>
            
            <h2 style="margin-top:15px;">Historial Reciente</h2>
            <div class="lap-list-container" id="lapList"></div>
        </div>
    </div>

    <div id="tab-stats" class="view-section">
        <div class="card">
            <h2 style="color:var(--primary-sec);">An√°lisis de Duraci√≥n</h2>
            
            <div style="margin-bottom:15px; background:#1a1a1a; padding:10px;">
                <label class="label">Filtrar Historial:</label>
                <select id="statsFilter" class="input-dark" style="width:100%; margin-top:5px;" onchange="calculateStats()">
                    <option value="ALL">Todo el Historial</option>
                </select>
            </div>
            
            <div class="stats-summary">
                <div class="stat-box"><span class="stat-label">Min</span><span class="stat-val" id="st-min">--</span></div>
                <div class="stat-box"><span class="stat-label">Q1</span><span class="stat-val" id="st-q1">--</span></div>
                <div class="stat-box"><span class="stat-label">Mediana</span><span class="stat-val" id="st-med">--</span></div>
                <div class="stat-box"><span class="stat-label">Q3</span><span class="stat-val" id="st-q3">--</span></div>
                <div class="stat-box"><span class="stat-label">Max</span><span class="stat-val" id="st-max">--</span></div>
            </div>

            <h2>Box Plot (Vela)</h2>
            <div id="boxPlotContainer" class="boxplot-container">
                <div style="text-align: center; padding-top: 30px; color: #444;" id="noDataMsg">Det√©n una actividad para ver datos</div>
            </div>

            <h2>Curva de Gauss</h2>
            <div style="width: 100%; height: 150px; background: #111; border: 1px solid #333;">
                <svg id="bellCurve" viewBox="0 0 300 150" preserveAspectRatio="none" style="width:100%; height:100%;"></svg>
            </div>
        </div>
    </div>

    <div id="tab-config" class="view-section">
        <div class="card">
            <h2>Editor de Botones</h2>
            <div class="config-row" id="formContainer">
                <input type="text" id="newBtnName" class="input-dark" placeholder="Nombre (ej: Cambio Molde)" style="flex:2; margin-right:5px;">
                <input type="text" id="newBtnCat" class="input-dark" placeholder="Categor√≠a (ej: SMED)" style="flex:1; margin-right:5px;">
                <button class="dyn-btn" id="saveBtn" onclick="handleSaveButton()" style="border-color: var(--primary-sec);">Crear</button>
                <button class="dyn-btn" id="cancelBtn" onclick="cancelEdit()" style="display:none; border-color: #666; margin-left:5px;">X</button>
            </div>
            
            <div id="configList" style="max-height: 300px; overflow-y: auto; margin-top:10px;"></div>
            
            <div style="margin-top:10px;">
                <button class="dyn-btn" onclick="restoreDefaults()" style="width:100%; color:#888;">Restaurar Botones por Defecto</button>
            </div>
        </div>
    </div>

    <script>
        // --- UTILIDADES ---
        const pad = (n) => n.toString().padStart(2, '0');
        const getDaySeconds = (d) => (d.getHours() * 3600) + (d.getMinutes() * 60) + d.getSeconds() + (d.getMilliseconds() / 1000);
        const formatHMS = (d) => `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;

        // --- ESTADO ---
        let laps = [];
        let buttons = [];
        let activeTimers = {}; 
        let editingIndex = -1; // Para saber si estamos editando un bot√≥n

        function init() {
            const sLaps = localStorage.getItem('v11_laps');
            const sBtns = localStorage.getItem('v11_btns');
            const sActive = localStorage.getItem('v11_active');

            if(sLaps) laps = JSON.parse(sLaps);
            if(sBtns) buttons = JSON.parse(sBtns);
            else restoreDefaults(false);
            if(sActive) activeTimers = JSON.parse(sActive);

            renderUI();
            setInterval(loop, 100);
        }

        function saveData() {
            localStorage.setItem('v11_laps', JSON.stringify(laps));
            localStorage.setItem('v11_btns', JSON.stringify(buttons));
            localStorage.setItem('v11_active', JSON.stringify(activeTimers));
        }

        // --- L√ìGICA CORE (TOGGLE) ---
        function handleBtnClick(name, cat) {
            const now = Date.now();

            if (activeTimers[cat]) {
                const prev = activeTimers[cat];
                
                // 1. Siempre detenemos el anterior
                const duration = (now - prev.start) / 1000;
                laps.unshift({
                    id: now,
                    name: prev.btnName,
                    cat: cat,
                    duration: parseFloat(duration.toFixed(1)),
                    endTime: formatHMS(new Date())
                });

                delete activeTimers[cat]; // Borramos el timer activo
                
                // 2. Si es el MISMO bot√≥n, terminamos aqu√≠ (efecto Toggle OFF)
                if(prev.btnName === name) {
                    saveData();
                    renderUI();
                    return;
                }
            }

            // 3. Si no era el mismo, iniciamos el nuevo (Toggle ON nuevo)
            activeTimers[cat] = { start: now, btnName: name };

            saveData();
            renderUI();
        }

        function stopAllTimers() {
            const now = Date.now();
            for (const cat in activeTimers) {
                const prev = activeTimers[cat];
                const duration = (now - prev.start) / 1000;
                laps.unshift({
                    id: now,
                    name: prev.btnName,
                    cat: cat,
                    duration: parseFloat(duration.toFixed(1)),
                    endTime: formatHMS(new Date())
                });
            }
            activeTimers = {};
            saveData();
            renderUI();
        }

        function deleteLap(index) {
            if(!confirm("¬øBorrar?")) return;
            laps.splice(index, 1);
            saveData();
            renderUI();
        }

        // --- GESTI√ìN BOTONES (EDICI√ìN) ---
        function restoreDefaults(save = true) {
            buttons = [
                { name: 'Hito Gen√©rico', cat: 'General' },
                { name: 'Operaci√≥n A', cat: 'Producci√≥n' },
                { name: 'Mantenimiento', cat: 'Paro' },
                { name: 'Descanso', cat: 'Personal' }
            ];
            if(save) { saveData(); renderUI(); }
        }

        function handleSaveButton() {
            const name = document.getElementById('newBtnName').value.trim();
            const cat = document.getElementById('newBtnCat').value.trim();
            
            if(!name || !cat) return alert("Nombre y categor√≠a requeridos");

            if(editingIndex >= 0) {
                // ACTUALIZAR
                buttons[editingIndex] = { name, cat };
                editingIndex = -1;
            } else {
                // CREAR NUEVO
                buttons.push({ name, cat });
            }
            
            cancelEdit(); // Limpia form
            saveData();
            renderUI();
        }

        function editButton(index) {
            editingIndex = index;
            const btn = buttons[index];
            document.getElementById('newBtnName').value = btn.name;
            document.getElementById('newBtnCat').value = btn.cat;
            
            // UI Feedback
            document.getElementById('saveBtn').innerText = "Actualizar";
            document.getElementById('saveBtn').style.color = "var(--edit-mode)";
            document.getElementById('saveBtn').style.borderColor = "var(--edit-mode)";
            document.getElementById('cancelBtn').style.display = "block";
            document.getElementById('formContainer').classList.add('edit-mode');
        }

        function cancelEdit() {
            editingIndex = -1;
            document.getElementById('newBtnName').value = '';
            document.getElementById('newBtnCat').value = '';
            document.getElementById('saveBtn').innerText = "Crear";
            document.getElementById('saveBtn').style.color = "#fff";
            document.getElementById('saveBtn').style.borderColor = "var(--primary-sec)";
            document.getElementById('cancelBtn').style.display = "none";
            document.getElementById('formContainer').classList.remove('edit-mode');
        }

        function removeButton(index) {
            if(!confirm("¬øEliminar bot√≥n?")) return;
            buttons.splice(index, 1);
            if(editingIndex === index) cancelEdit();
            saveData(); renderUI();
        }

        // --- RENDERIZADO ---
        function renderUI() {
            // 1. Botonera
            const btnContainer = document.getElementById('dynamicButtons');
            btnContainer.innerHTML = '';
            buttons.forEach(btn => {
                const isActive = activeTimers[btn.cat] && activeTimers[btn.cat].btnName === btn.name;
                const b = document.createElement('button');
                b.className = `dyn-btn ${isActive ? 'is-running' : ''}`;
                b.innerHTML = `${isActive ? '‚ñ∂ ' : ''}${btn.name} <small>${btn.cat}</small>`;
                if(isActive) b.innerHTML += `<small style="color:#fff" id="timer-${btn.cat}">...</small>`;
                b.onclick = () => handleBtnClick(btn.name, btn.cat);
                btnContainer.appendChild(b);
            });

            // 2. Timers Activos
            const timerList = document.getElementById('activeTimersList');
            const catsActive = Object.keys(activeTimers);
            if(catsActive.length > 0) {
                timerList.style.display = 'block';
                timerList.innerHTML = '<div class="label" style="margin-bottom:5px;">ACTIVIDAD EN CURSO:</div>';
                catsActive.forEach(cat => {
                    const t = activeTimers[cat];
                    timerList.innerHTML += `
                        <div class="active-timer-row">
                            <span class="timer-cat">[${cat}]</span>
                            <span class="timer-name">${t.btnName}</span>
                            <span class="timer-val" id="panel-timer-${cat}">0.0s</span>
                        </div>`;
                });
            } else {
                timerList.style.display = 'none';
            }

            // 3. Historial
            const list = document.getElementById('lapList');
            list.innerHTML = '';
            laps.forEach((l, idx) => {
                list.innerHTML += `
                    <div class="lap-item">
                        <div><span style="color:#fff">${l.name}</span> <span style="color:#666">(${l.cat})</span></div>
                        <div style="display:flex; align-items:center;">
                            <span class="lap-val">${l.duration}s</span>
                            <button onclick="deleteLap(${idx})" style="background:none; border:none; color:#444; margin-left:8px; cursor:pointer;">x</button>
                        </div>
                    </div>`;
            });

            // 4. Config Lista
            const conf = document.getElementById('configList');
            conf.innerHTML = '';
            buttons.forEach((btn, idx) => {
                conf.innerHTML += `
                    <div class="config-row">
                        <span>${btn.name} <small>(${btn.cat})</small></span>
                        <div>
                            <button class="dyn-btn" style="padding:2px 6px; margin-right:5px; border-color:#888;" onclick="editButton(${idx})">‚úé</button>
                            <button class="dyn-btn" style="padding:2px 6px; color:var(--danger); border-color:var(--danger);" onclick="removeButton(${idx})">üóë</button>
                        </div>
                    </div>`;
            });

            updateFilterOptions();
            calculateStats();
        }

        // --- STATS ---
        function updateFilterOptions() {
            const sel = document.getElementById('statsFilter');
            const current = sel.value;
            const cats = [...new Set(laps.map(l => l.cat))];
            const names = [...new Set(laps.map(l => l.name))];

            let html = '<option value="ALL">Todo el Historial</option>';
            if(cats.length) {
                html += '<optgroup label="Por Categor√≠a">';
                cats.forEach(c => html += `<option value="CAT:${c}">${c}</option>`);
                html += '</optgroup>';
            }
            if(names.length) {
                html += '<optgroup label="Por Bot√≥n">';
                names.forEach(n => html += `<option value="NAME:${n}">${n}</option>`);
                html += '</optgroup>';
            }
            sel.innerHTML = html;
            // Restaurar selecci√≥n si existe, sino ALL
            if([...sel.options].some(o => o.value === current)) sel.value = current;
        }

        function calculateStats() {
            const filter = document.getElementById('statsFilter').value;
            let vals = [];

            if(filter === 'ALL') vals = laps.map(l => l.duration);
            else if(filter.startsWith('CAT:')) vals = laps.filter(l => l.cat === filter.split(':')[1]).map(l => l.duration);
            else if(filter.startsWith('NAME:')) vals = laps.filter(l => l.name === filter.split(':')[1]).map(l => l.duration);

            vals.sort((a,b) => a-b);

            const noData = document.getElementById('noDataMsg');
            const bell = document.getElementById('bellCurve');
            
            if(vals.length < 1) {
                noData.style.display = 'block';
                bell.innerHTML = '';
                document.getElementById('boxPlotContainer').innerHTML = '<div style="text-align:center; padding-top:30px; color:#444;">Sin datos</div>';
                ['min','q1','med','q3','max'].forEach(id => document.getElementById(`st-${id}`).innerText = '--');
                return;
            }
            
            // Si hay datos, ocultar mensaje y procesar
            noData.style.display = 'none';

            // Quartiles
            const q1Pos = Math.floor(vals.length * 0.25);
            const medPos = Math.floor(vals.length * 0.50);
            const q3Pos = Math.floor(vals.length * 0.75);
            
            const min = vals[0];
            const max = vals[vals.length - 1];
            const q1 = vals[q1Pos];
            const med = vals[medPos];
            const q3 = vals[q3Pos];

            document.getElementById('st-min').innerText = min;
            document.getElementById('st-q1').innerText = q1;
            document.getElementById('st-med').innerText = med;
            document.getElementById('st-q3').innerText = q3;
            document.getElementById('st-max').innerText = max;

            drawBoxPlot(min, q1, med, q3, max);
            drawBellCurve(vals);
        }

        function drawBoxPlot(min, q1, med, q3, max) {
            const c = document.getElementById('boxPlotContainer');
            // Evitar divisi√≥n por cero si min == max
            let range = max - min;
            if(range === 0) range = 1;

            const getPct = (v) => ((v - min) / range) * 90 + 5;

            c.innerHTML = `
                <div class="boxplot-track">
                    <div class="bp-whisker" style="left:${getPct(min)}%"></div>
                    <div class="bp-line" style="left:${getPct(min)}%; width:${getPct(q1)-getPct(min)}%"></div>
                    <div class="bp-box" style="left:${getPct(q1)}%; width:${getPct(q3)-getPct(q1)}%"></div>
                    <div class="bp-median" style="left:${getPct(med)}%"></div>
                    <div class="bp-line" style="left:${getPct(q3)}%; width:${getPct(max)-getPct(q3)}%"></div>
                    <div class="bp-whisker" style="left:${getPct(max)}%"></div>
                    <div class="bp-label" style="left:${getPct(min)}%">${min}</div>
                    <div class="bp-label" style="left:${getPct(med)}%; top:-20px; color:#fff;">${med}</div>
                    <div class="bp-label" style="left:${getPct(max)}%">${max}</div>
                </div>`;
        }

        function drawBellCurve(values) {
            const n = values.length;
            const mean = values.reduce((a,b)=>a+b,0)/n;
            let variance = values.reduce((a,b)=>a+Math.pow(b-mean,2),0)/n;
            let stdDev = Math.sqrt(variance);

            // Protecci√≥n contra stdDev muy peque√±a (datos id√©nticos) para que la curva no explote
            if(stdDev < 0.01) stdDev = 0.5; 

            const startX = Math.min(...values) - (stdDev * 2);
            const endX = Math.max(...values) + (stdDev * 2);
            
            const w = 300, h = 150, pad = 10;
            let points = []; let maxY = 0;

            for(let x=startX; x<=endX; x+=(endX-startX)/50) {
                const y = (1/(stdDev*Math.sqrt(2*Math.PI))) * Math.exp(-0.5*Math.pow((x-mean)/stdDev, 2));
                if(y>maxY) maxY=y;
                points.push({x,y});
            }

            const mapX = (v) => ((v-startX)/(endX-startX))*(w-2*pad) + pad;
            const mapY = (v) => h - pad - ((v/maxY)*(h-2*pad));

            let d = `M ${mapX(points[0].x)} ${mapY(points[0].y)}`;
            points.forEach(p => d += ` L ${mapX(p.x)} ${mapY(p.y)}`);
            const dArea = d + ` L ${mapX(points[points.length-1].x)} ${h} L ${mapX(points[0].x)} ${h} Z`;

            document.getElementById('bellCurve').innerHTML = `
                <path d="${dArea}" style="fill:rgba(0,255,157,0.1); stroke:none;" />
                <path d="${d}" style="fill:none; stroke:#00d4ff; stroke-width:2;" />
                <line x1="${mapX(mean)}" y1="10" x2="${mapX(mean)}" y2="${h}" style="stroke:#fff; stroke-dasharray:4; opacity:0.5" />
                <text x="${mapX(mean)}" y="10" fill="#fff" font-size="10" text-anchor="middle">Œº ${mean.toFixed(1)}</text>
            `;
        }

        function loop() {
            const now = new Date();
            const nowTs = Date.now();
            document.getElementById('mainSeconds').innerText = getDaySeconds(now).toFixed(1);
            document.getElementById('mainTime').innerText = formatHMS(now);

            for (const cat in activeTimers) {
                const t = activeTimers[cat];
                const val = ((nowTs - t.start) / 1000).toFixed(1) + 's';
                const elBtn = document.getElementById(`timer-${cat}`);
                const elPanel = document.getElementById(`panel-timer-${cat}`);
                if(elBtn) elBtn.innerText = val;
                if(elPanel) elPanel.innerText = val;
            }
        }

        function clearAllData() {
            if(confirm("¬øBorrar TODO?")) {
                laps = []; activeTimers = {};
                saveData(); init();
            }
        }
        function switchTab(t) {
            document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active'));
            document.getElementById('tab-'+t).classList.add('active');
            document.querySelector(`button[onclick="switchTab('${t}')"]`).classList.add('active');
            if(t==='stats') calculateStats();
        }

        init();
    </script>
</body>
</html>
