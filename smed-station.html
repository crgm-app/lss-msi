<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SMED Master Hub v13</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { --neon-green: #00ff00; --neon-blue: #00d4ff; --neon-orange: #ffaa00; --bg-dark: #050505; --panel: #111; }
        * { box-sizing: border-box; margin: 0; padding: 0; touch-action: manipulation; }
        body { background-color: var(--bg-dark); color: #fff; font-family: 'Segoe UI', Roboto, sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        header { background: var(--panel); padding: 5px 10px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; flex-shrink: 0; }
        .main-clock { font-size: 2rem; font-weight: 900; font-family: monospace; color: var(--neon-green); }
        
        nav { display: flex; background: #000; border-bottom: 1px solid #333; height: 45px; flex-shrink: 0; }
        .tab-btn { flex: 1; background: none; border: none; color: #666; font-weight: bold; font-size: 0.75rem; text-transform: uppercase; cursor: pointer; }
        .tab-btn.active { color: var(--neon-blue); background: #151515; border-bottom: 3px solid var(--neon-blue); }

        .view-section { display: none; flex: 1; overflow: hidden; position: relative; }
        .view-section.active { display: flex; }

        /* VISTA 1: CAPTURA */
        .capture-layout { flex-direction: row; width: 100%; }
        .left-list { flex: 1.4; display: flex; flex-direction: column; border-right: 1px solid #333; }
        .log-container { flex: 1; overflow-y: auto; background: #000; }
        .right-buttons { flex: 1; background: #080808; padding: 5px; overflow-y: auto; display: flex; flex-direction: column; gap: 4px; }

        table { width: 100%; border-collapse: collapse; font-family: monospace; font-size: 0.7rem; }
        th { background: #151515; color: var(--neon-blue); padding: 5px; text-align: left; position: sticky; top: 0; z-index: 2; }
        td { padding: 4px 6px; border-bottom: 1px solid #222; }
        tr:nth-child(even) { background: #0a0a0a; }

        .smed-btn-box { display: flex; height: 55px; border: 1px solid #333; border-radius: 4px; overflow: hidden; background: #151515; flex-shrink: 0; }
        .smed-btn { flex: 1; background: transparent; color: #ddd; border: none; text-align: left; padding-left: 10px; position: relative; font-weight: 600; font-size: 0.8rem; }
        .smed-btn.active { background: linear-gradient(90deg, #332200, #151515); color: var(--neon-orange); border-left: 3px solid var(--neon-orange); }
        .grp-label { position: absolute; top: 2px; right: 5px; font-size: 0.5rem; color: #555; text-transform: uppercase; }
        .del-btn { width: 30px; background: #200; color: #f55; border: none; font-size: 1rem; cursor: pointer; }

        /* VISTA 2: DASHBOARD */
        .dashboard-layout { flex-direction: column; padding: 10px; overflow-y: auto; gap: 10px; background: #000; }
        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; flex-shrink: 0; }
        .kpi-card { background: #111; padding: 8px; border-radius: 4px; text-align: center; border: 1px solid #222; }
        .kpi-val { font-size: 1.1rem; font-weight: bold; }
        .kpi-lbl { font-size: 0.55rem; color: #777; text-transform: uppercase; }

        .chart-wrapper { background: #111; border: 1px solid #333; border-radius: 6px; padding: 10px; min-height: 200px; display: flex; flex-direction: column; }
        .chart-title { font-size: 0.7rem; color: #aaa; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }

        /* CSS FALLBACK */
        .css-bar-container { width: 100%; display: flex; height: 30px; margin-bottom: 5px; background: #222; border-radius: 4px; overflow: hidden; }
        .css-bar-segment { height: 100%; display: flex; align-items: center; justify-content: center; font-size: 0.6rem; color: #000; font-weight: bold; }
        .css-gantt-row { display: flex; align-items: center; margin-bottom: 4px; height: 25px; }
        .css-gantt-label { width: 30%; font-size: 0.6rem; color: #ccc; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 5px; }
        .css-gantt-track { width: 70%; background: #111; height: 100%; position: relative; border-radius: 3px; }
        .css-gantt-bar { position: absolute; height: 100%; top: 0; border-radius: 2px; opacity: 0.8; }

        /* VISTA 3: SIX SIGMA */
        .sigma-layout { flex-direction: column; padding: 10px; overflow-y: auto; }
        .stat-table-container { background: #111; border-radius: 6px; overflow: hidden; margin-bottom: 15px; }
        
        footer { height: 55px; background: var(--panel); border-top: 1px solid #333; display: flex; align-items: center; justify-content: center; gap: 8px; flex-shrink: 0; }
        .btn-act { padding: 8px 12px; border-radius: 4px; border: 1px solid #444; background: #222; color: #fff; font-weight: bold; font-size: 0.7rem; }
        
        input { background: #000; border: 1px solid #333; color: #fff; padding: 8px; }
        
        /* INPUT DE IMPORTACI칍N OCULTO */
        #csv-file-input { display: none; }
    </style>
</head>
<body>

    <header>
        <div>
            <div id="abs-clock" class="main-clock">00000.0</div>
            <div style="font-size:0.6rem; color:#555">TIEMPO ABSOLUTO (S)</div>
        </div>
        <div style="text-align:right">
            <div id="real-time" style="font-size:0.9rem; font-weight:bold; color:#aaa">00:00:00</div>
            <button onclick="toggleFS()" style="background:none; border:1px solid #333; color:#555; font-size:9px; padding:2px 5px; margin-top:2px;">FULLSCREEN</button>
        </div>
    </header>

    <nav>
        <button class="tab-btn active" onclick="showView('capture', this)">1. Captura</button>
        <button class="tab-btn" onclick="showView('dashboard', this)">2. Gr치ficos</button>
        <button class="tab-btn" onclick="showView('sigma', this)">3. Estad칤stica</button>
    </nav>

    <div id="view-capture" class="view-section capture-layout active">
        <section class="left-list">
            <div class="log-container">
                <table>
                    <thead><tr><th>Actividad</th><th>Clase</th><th>Seg</th><th>Inicio</th></tr></thead>
                    <tbody id="log-table-body"></tbody>
                </table>
            </div>
            <div style="padding:5px; background:#111; display:flex; gap:5px; border-top:1px solid #222;">
                <input type="text" id="new-btn-name" placeholder="Nueva actividad..." style="flex:1; border-radius:4px;">
                <button onclick="addButton()" style="width:40px; background:var(--neon-blue); border:none; border-radius:4px; font-weight:bold;">+</button>
            </div>
        </section>
        <section class="right-buttons" id="buttons-area"></section>
    </div>

    <div id="view-dashboard" class="view-section dashboard-layout">
        <div class="kpi-grid">
            <div class="kpi-card"><div class="kpi-val" id="kpi-total">0</div><div class="kpi-lbl">Total (s)</div></div>
            <div class="kpi-card"><div class="kpi-val" id="kpi-int" style="color:var(--neon-blue)">0</div><div class="kpi-lbl">Interna</div></div>
            <div class="kpi-card"><div class="kpi-val" id="kpi-ext" style="color:var(--neon-green)">0</div><div class="kpi-lbl">Externa</div></div>
            <div class="kpi-card"><div class="kpi-val" id="kpi-muda" style="color:var(--neon-orange)">0</div><div class="kpi-lbl">Muda</div></div>
        </div>

        <div class="chart-wrapper">
            <div class="chart-title">Distribuci칩n de Tiempos</div>
            <div id="canvas-container-pie" style="position:relative; height:200px; display:none;">
                <canvas id="pieChart"></canvas>
            </div>
            <div id="css-pie-fallback" style="display:flex; flex-direction:column; justify-content:center; height:100%;">
                <div class="css-bar-container" id="css-proportion-bar"></div>
            </div>
        </div>

        <div class="chart-wrapper">
            <div class="chart-title">Cronolog칤a de Actividades (Gantt)</div>
            <div id="canvas-container-bar" style="position:relative; height:250px; display:none;">
                <canvas id="barChart"></canvas>
            </div>
            <div id="css-gantt-fallback" style="overflow-y:auto; flex:1;"></div>
        </div>
    </div>

    <div id="view-sigma" class="view-section sigma-layout">
        <div class="chart-title" style="padding:10px 0;">An치lisis de Variabilidad (Pareto & Desviaci칩n)</div>
        <div class="stat-table-container">
            <table>
                <thead>
                    <tr><th>Tarea</th><th>Cant</th><th>Media</th><th>Min/Max</th><th>Total</th></tr>
                </thead>
                <tbody id="sigma-body"></tbody>
            </table>
        </div>
        <div style="padding:10px; background:#111; border:1px solid #333; border-radius:6px;">
            <div class="chart-title">Insights de Datos</div>
            <ul id="smed-recommendations" style="font-size:0.75rem; color:#ccc; padding-left:20px; line-height:1.5;"></ul>
        </div>
    </div>

    <input type="file" id="csv-file-input" accept=".csv" multiple onchange="handleFileImport(this)">

    <footer>
        <button class="btn-act" style="background:var(--neon-blue); color:#000" onclick="triggerImport()">IMPORTAR CSV</button>
        <button class="btn-act" onclick="exportData('csv')">EXP CSV</button>
        <button class="btn-act" onclick="exportData('txt')">EXP TXT</button>
        <button class="btn-act" style="background:#311; color:#f55; border-color:#522" onclick="rescueData()">FIX</button>
        <button class="btn-act" style="background:#000; color:#555" onclick="hardReset()">RESET</button>
    </footer>

    <script>
        let absTime = 0;
        let logs = [];
        let btns = ["Troquel Desmontar", "Troquel Montar", "Sello Ajuste", "Limpieza"]; 
        let activeTasks = {};
        const C_INT = '#00d4ff'; const C_EXT = '#00ff00'; const C_MUDA = '#ffaa00';

        function init() {
            try {
                const sLogs = localStorage.getItem('smed_logs_v13');
                if(sLogs) logs = JSON.parse(sLogs);
                const sBtns = localStorage.getItem('smed_btns_v13');
                if(sBtns) btns = JSON.parse(sBtns);
            } catch(e) {}
            renderButtons();
            renderLogs();
            setInterval(tick, 100);
        }

        function tick() {
            const d = new Date();
            absTime = (d.getHours()*3600) + (d.getMinutes()*60) + d.getSeconds() + (d.getMilliseconds()/1000);
            document.getElementById('abs-clock').textContent = absTime.toFixed(1);
            document.getElementById('real-time').textContent = d.toLocaleTimeString();
        }

        /* --- IMPORTACI칍N MASIVA --- */
        function triggerImport() {
            document.getElementById('csv-file-input').click();
        }

        function handleFileImport(input) {
            const files = input.files;
            if(!files.length) return;

            let loadedCount = 0;
            let newRecords = 0;

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const text = e.target.result;
                    const lines = text.split('\n');
                    
                    // Detectar formato
                    lines.forEach(line => {
                        // Limpiar comillas y espacios
                        const cleanLine = line.replace(/"/g, '').trim();
                        if(!cleanLine) return;

                        const parts = cleanLine.split(',');
                        // Formato V12/13: Nombre, Tipo, Duracion, Inicio, Fin (o similar)
                        // Buscamos l칤neas que tengan al menos 5 columnas y donde la 3ra sea num칠rica (duraci칩n)
                        if(parts.length >= 5) {
                            const name = parts[0].trim();
                            const type = parts[1].trim();
                            const dur = parseFloat(parts[2]);
                            const start = parseFloat(parts[3]);
                            const end = parseFloat(parts[4]);

                            // Validar que sea un registro de datos v치lido y no un encabezado
                            if(!isNaN(dur) && !isNaN(start) && name !== "Tarea" && name !== "Actividad") {
                                // DEDUPLICACI칍N: Usamos (Start + Name) como llave 칰nica
                                const exists = logs.some(l => 
                                    Math.abs(parseFloat(l.start) - start) < 0.1 && l.name === name
                                );

                                if(!exists) {
                                    logs.push({
                                        name: name,
                                        type: (type === 'Int' || type === 'Interna') ? 'Interna' : (type === 'Ext' || type === 'Externa' ? 'Externa' : 'Muda'),
                                        dur: dur,
                                        start: start.toFixed(1),
                                        end: end.toFixed(1)
                                    });
                                    newRecords++;
                                }
                            }
                        }
                    });

                    loadedCount++;
                    if(loadedCount === files.length) {
                        // Finalizar proceso
                        logs.sort((a,b) => parseFloat(a.start) - parseFloat(b.start));
                        saveData();
                        renderLogs();
                        alert(`Importaci칩n completa.\nArchivos procesados: ${files.length}\nRegistros nuevos agregados: ${newRecords}`);
                        input.value = ''; // Limpiar input
                    }
                };
                reader.readAsText(file);
            });
        }

        /* --- BOTONES Y TAREAS --- */
        function addButton() {
            const name = document.getElementById('new-btn-name').value.trim();
            if(!name || btns.includes(name)) return;
            btns.push(name);
            saveData();
            renderButtons();
            document.getElementById('new-btn-name').value = "";
        }

        function renderButtons() {
            const container = document.getElementById('buttons-area');
            container.innerHTML = "";
            btns.forEach(name => {
                const grp = name.split(' ')[0].toUpperCase();
                const div = document.createElement('div');
                div.className = 'smed-btn-box';
                div.innerHTML = `<button class="smed-btn" onclick="toggleTask(this, '${name}')">${name}<div class="grp-label">${grp}</div></button><button class="del-btn" onclick="delButton('${name}')">칑</button>`;
                container.appendChild(div);
            });
        }

        function delButton(name) {
            if(confirm("쮹orrar bot칩n?")) {
                btns = btns.filter(b => b !== name);
                saveData();
                renderButtons();
            }
        }

        function toggleTask(btn, name) {
            const grp = name.split(' ')[0].toUpperCase();
            if(activeTasks[grp] && activeTasks[grp].name === name) {
                finishTask(grp, btn);
            } else {
                if(activeTasks[grp]) {
                    const prevName = activeTasks[grp].name;
                    const allBtns = document.querySelectorAll('.smed-btn');
                    let prevBtn = null;
                    allBtns.forEach(b => { if(b.textContent.includes(prevName)) prevBtn = b; });
                    if(prevBtn) finishTask(grp, prevBtn);
                }
                activeTasks[grp] = { name: name, start: absTime };
                btn.classList.add('active');
            }
        }

        function finishTask(grp, btn) {
            if(!activeTasks[grp]) return;
            const task = activeTasks[grp];
            const dur = parseFloat((absTime - task.start).toFixed(1));
            if(!isNaN(dur) && dur > 0) {
                logs.push({ name: task.name, type: "Interna", start: task.start.toFixed(1), end: absTime.toFixed(1), dur: dur });
                saveData();
                renderLogs();
            }
            delete activeTasks[grp];
            if(btn) btn.classList.remove('active');
        }

        function renderLogs() {
            const tbody = document.getElementById('log-table-body');
            tbody.innerHTML = logs.map((l, i) => `<tr><td>${l.name}</td><td><select onchange="updateType(${i}, this.value)" style="background:#000; color:#fff; border:1px solid #333; font-size:0.6rem"><option value="Interna" ${l.type==='Interna'?'selected':''}>Int</option><option value="Externa" ${l.type==='Externa'?'selected':''}>Ext</option><option value="Muda" ${l.type==='Muda'?'selected':''}>Muda</option></select></td><td style="color:var(--neon-orange); font-weight:bold">${l.dur}</td><td style="color:#555">${l.start}</td></tr>`).join('');
            const container = document.querySelector('.log-container');
            container.scrollTop = container.scrollHeight;
        }

        function updateType(idx, val) { logs[idx].type = val; saveData(); }
        function saveData() { localStorage.setItem('smed_logs_v13', JSON.stringify(logs)); localStorage.setItem('smed_btns_v13', JSON.stringify(btns)); }

        /* --- VISUALIZACI칍N --- */
        let myPie = null, myBar = null;
        function showView(viewId, btn) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('view-'+viewId).classList.add('active');
            btn.classList.add('active');
            if(viewId === 'dashboard') updateDashboard();
            if(viewId === 'sigma') updateSigma();
        }

        function updateDashboard() {
            let t = { Interna:0, Externa:0, Muda:0, Total:0 };
            logs.forEach(l => { const d = parseFloat(l.dur); if(!isNaN(d)) { t[l.type] += d; t.Total += d; } });
            document.getElementById('kpi-total').textContent = t.Total.toFixed(1);
            document.getElementById('kpi-int').textContent = t.Interna.toFixed(1);
            document.getElementById('kpi-ext').textContent = t.Externa.toFixed(1);
            document.getElementById('kpi-muda').textContent = t.Muda.toFixed(1);

            if(typeof Chart !== 'undefined') {
                document.getElementById('canvas-container-pie').style.display = 'block'; document.getElementById('css-pie-fallback').style.display = 'none';
                document.getElementById('canvas-container-bar').style.display = 'block'; document.getElementById('css-gantt-fallback').style.display = 'none';
                renderJSCharts(t);
            } else {
                document.getElementById('canvas-container-pie').style.display = 'none'; document.getElementById('css-pie-fallback').style.display = 'flex';
                document.getElementById('canvas-container-bar').style.display = 'none'; document.getElementById('css-gantt-fallback').style.display = 'block';
                renderCSSCharts(t);
            }
        }

        function renderJSCharts(t) {
            const ctxPie = document.getElementById('pieChart').getContext('2d');
            if(myPie) myPie.destroy();
            myPie = new Chart(ctxPie, { type: 'doughnut', data: { labels: ['Interna', 'Externa', 'Muda'], datasets: [{ data: [t.Interna, t.Externa, t.Muda], backgroundColor: [C_INT, C_EXT, C_MUDA], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position:'right', labels:{color:'#fff'} } } } });

            const ctxBar = document.getElementById('barChart').getContext('2d');
            if(myBar) myBar.destroy();
            const colorsGantt = logs.map(l => l.type==='Interna'?C_INT:(l.type==='Externa'?C_EXT:C_MUDA));
            myBar = new Chart(ctxBar, { type: 'bar', data: { labels: logs.map(l => l.name), datasets: [{ label: 'L칤nea de Tiempo', data: logs.map(l => [parseFloat(l.start), parseFloat(l.end)]), backgroundColor: colorsGantt, barPercentage: 0.5 }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { min: logs.length?parseFloat(logs[0].start):0, ticks: { color:'#666'} }, y: { ticks: { color:'#fff', font:{size:9} } } }, plugins: { legend: { display:false } } } });
        }

        function renderCSSCharts(t) {
            const bar = document.getElementById('css-proportion-bar'); bar.innerHTML = '';
            if(t.Total > 0) {
                if(t.Interna>0) bar.innerHTML += `<div class="css-bar-segment" style="width:${(t.Interna/t.Total)*100}%; background:${C_INT}">INT</div>`;
                if(t.Externa>0) bar.innerHTML += `<div class="css-bar-segment" style="width:${(t.Externa/t.Total)*100}%; background:${C_EXT}">EXT</div>`;
                if(t.Muda>0)    bar.innerHTML += `<div class="css-bar-segment" style="width:${(t.Muda/t.Total)*100}%; background:${C_MUDA}">MUDA</div>`;
            } else { bar.innerHTML = '<div style="width:100%; text-align:center; color:#555; font-size:0.6rem; padding-top:8px;">Sin datos</div>'; }

            const gantt = document.getElementById('css-gantt-fallback'); gantt.innerHTML = '';
            if(logs.length === 0) return;
            const minStart = parseFloat(logs[0].start); const totalRange = parseFloat(logs[logs.length-1].end) - minStart;
            logs.forEach(l => {
                const leftPct = ((parseFloat(l.start) - minStart) / totalRange) * 100;
                const widthPct = (parseFloat(l.dur) / totalRange) * 100;
                const col = l.type==='Interna'?C_INT:(l.type==='Externa'?C_EXT:C_MUDA);
                gantt.innerHTML += `<div class="css-gantt-row"><div class="css-gantt-label">${l.name}</div><div class="css-gantt-track"><div class="css-gantt-bar" style="left:${leftPct}%; width:${widthPct}%; background:${col}"></div></div></div>`;
            });
        }

        function updateSigma() {
            let groups = {};
            logs.forEach(l => { if(!groups[l.name]) groups[l.name] = []; groups[l.name].push(parseFloat(l.dur)); });
            const tbody = document.getElementById('sigma-body'); tbody.innerHTML = "";
            let recommendations = [];
            Object.keys(groups).forEach(name => {
                const times = groups[name]; const n = times.length; const sum = times.reduce((a,b)=>a+b,0); const avg = sum / n;
                const min = Math.min(...times); const max = Math.max(...times);
                const variance = times.reduce((a,b)=>a+Math.pow(b-avg,2),0) / n; const stdDev = Math.sqrt(variance);
                tbody.innerHTML += `<tr><td style="color:#fff">${name}</td><td>${n}</td><td style="color:var(--neon-blue)">${avg.toFixed(1)}s</td><td style="font-size:0.6rem">${min.toFixed(1)} / ${max.toFixed(1)}</td><td style="font-weight:bold">${sum.toFixed(1)}s</td></tr>`;
                if(stdDev > (avg * 0.2)) recommendations.push(`丘멆잺 <b>${name}:</b> Alta variabilidad (Desv: ${stdDev.toFixed(1)}).`);
                if(sum > (parseFloat(document.getElementById('kpi-total').textContent)*0.2)) recommendations.push(`游늵 <b>${name}:</b> Carga significativa del tiempo total (Pareto).`);
            });
            document.getElementById('smed-recommendations').innerHTML = recommendations.map(r => `<li>${r}</li>`).join('');
        }

        function exportData(format) {
            if(logs.length === 0) return alert("Sin datos");
            const op = prompt("OP:") || "X"; const resp = prompt("Resp:") || "X";
            let c = "";
            if(format==='csv') {
                c = `REPORTE SMED CONSOLIDADO\nOP,${op},Resp,${resp},Fecha,${new Date().toLocaleDateString()}\n\nTarea,Tipo,Duracion,Inicio,Fin\n`;
                logs.forEach(l => c += `"${l.name}","${l.type}",${l.dur},${l.start},${l.end}\n`);
            } else {
                c = `SMED LOG - OP:${op}\n----------------\n`; logs.forEach(l => c += `[${l.type}] ${l.name}: ${l.dur}s\n`);
            }
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([c], {type:'text/plain'})); a.download = `SMED_${op}.${format}`; a.click();
        }

        function rescueData() {
            if(!confirm("Reparar base de datos?")) return;
            const originalL = logs.length;
            logs = logs.filter(l => !isNaN(parseFloat(l.dur)) && l.dur > 0);
            alert(`Reparado. Registros v치lidos: ${logs.length} (Eliminados: ${originalL - logs.length})`);
            saveData(); renderLogs();
        }

        function hardReset() { if(confirm("Borrar todo?")) { localStorage.clear(); location.reload(); } }
        function toggleFS() { if(!document.fullscreenElement) document.documentElement.requestFullscreen().catch(e=>{}); else document.exitFullscreen(); }
        window.onload = init;
    </script>
</body>
</html>
