<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SMED Statistics Master v14</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { --neon-green: #00ff00; --neon-blue: #00d4ff; --neon-orange: #ffaa00; --neon-purple: #bd00ff; --bg-dark: #050505; --panel: #111; }
        * { box-sizing: border-box; margin: 0; padding: 0; touch-action: manipulation; }
        body { background-color: var(--bg-dark); color: #fff; font-family: 'Segoe UI', Roboto, sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* HEADER & NAV */
        header { background: var(--panel); padding: 5px 10px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; flex-shrink: 0; }
        .main-clock { font-size: 1.8rem; font-weight: 900; font-family: monospace; color: var(--neon-green); }
        
        nav { display: flex; background: #000; border-bottom: 1px solid #333; height: 45px; flex-shrink: 0; }
        .tab-btn { flex: 1; background: none; border: none; color: #666; font-weight: bold; font-size: 0.75rem; text-transform: uppercase; cursor: pointer; }
        .tab-btn.active { color: var(--neon-blue); background: #151515; border-bottom: 3px solid var(--neon-blue); }

        .view-section { display: none; flex: 1; overflow: hidden; position: relative; }
        .view-section.active { display: flex; }

        /* VISTA 1: CAPTURA */
        .capture-layout { flex-direction: row; width: 100%; }
        .left-list { flex: 1.4; display: flex; flex-direction: column; border-right: 1px solid #333; }
        .log-container { flex: 1; overflow-y: auto; background: #000; }
        .right-buttons { flex: 1; background: #080808; padding: 5px; overflow-y: auto; display: flex; flex-direction: column; gap: 4px; }

        table { width: 100%; border-collapse: collapse; font-family: monospace; font-size: 0.65rem; }
        th { background: #151515; color: var(--neon-blue); padding: 5px; text-align: left; position: sticky; top: 0; z-index: 2; border-bottom: 1px solid #333; }
        td { padding: 4px 6px; border-bottom: 1px solid #222; }
        tr:nth-child(even) { background: #0a0a0a; }

        .smed-btn-box { display: flex; height: 50px; border: 1px solid #333; border-radius: 4px; overflow: hidden; background: #151515; flex-shrink: 0; }
        .smed-btn { flex: 1; background: transparent; color: #ddd; border: none; text-align: left; padding-left: 10px; position: relative; font-weight: 600; font-size: 0.8rem; }
        .smed-btn.active { background: linear-gradient(90deg, #332200, #151515); color: var(--neon-orange); border-left: 3px solid var(--neon-orange); }
        .grp-label { position: absolute; top: 2px; right: 5px; font-size: 0.5rem; color: #555; text-transform: uppercase; }
        .del-btn { width: 30px; background: #200; color: #f55; border: none; font-size: 1rem; cursor: pointer; }

        /* VISTA 2: DASHBOARD */
        .dashboard-layout { flex-direction: column; padding: 10px; overflow-y: auto; gap: 10px; background: #000; }
        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; flex-shrink: 0; }
        .kpi-card { background: #111; padding: 8px; border-radius: 4px; text-align: center; border: 1px solid #222; }
        .kpi-val { font-size: 1rem; font-weight: bold; }
        .kpi-lbl { font-size: 0.5rem; color: #777; text-transform: uppercase; }
        .chart-wrapper { background: #111; border: 1px solid #333; border-radius: 6px; padding: 10px; min-height: 200px; display: flex; flex-direction: column; }

        /* VISTA 3: ESTADÍSTICA (NUEVO DISEÑO) */
        .sigma-layout { flex-direction: column; padding: 10px; overflow-y: auto; background: #050505; }
        .filter-bar { display: flex; gap: 5px; margin-bottom: 10px; overflow-x: auto; padding-bottom: 5px; }
        .filter-btn { padding: 6px 12px; background: #222; border: 1px solid #444; color: #aaa; border-radius: 15px; font-size: 0.7rem; cursor: pointer; white-space: nowrap; }
        .filter-btn.active { background: var(--neon-blue); color: #000; border-color: var(--neon-blue); font-weight: bold; }

        .boxplot-container { height: 300px; background: #111; border: 1px solid #333; border-radius: 6px; padding: 10px; margin-bottom: 15px; position: relative; }
        canvas#boxPlotCanvas { width: 100%; height: 100%; display: block; }
        
        .stat-card-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .stat-detail-table { width: 100%; border-collapse: collapse; font-family: monospace; font-size: 0.7rem; }
        .stat-detail-table th { background: #1a1a1a; color: #fff; padding: 8px; text-align: center; border-bottom: 2px solid #333; }
        .stat-detail-table td { padding: 8px; border-bottom: 1px solid #222; text-align: center; color: #ccc; }
        .stat-detail-table td:first-child { text-align: left; color: var(--neon-blue); font-weight: bold; }

        /* FOOTER */
        footer { height: 50px; background: var(--panel); border-top: 1px solid #333; display: flex; align-items: center; justify-content: center; gap: 8px; flex-shrink: 0; }
        .btn-act { padding: 8px 12px; border-radius: 4px; border: 1px solid #444; background: #222; color: #fff; font-weight: bold; font-size: 0.7rem; }
        
        input { background: #000; border: 1px solid #333; color: #fff; padding: 8px; }
        #csv-file-input { display: none; }

        /* CSS Fallbacks */
        .css-bar-container { width: 100%; display: flex; height: 30px; background: #222; border-radius: 4px; overflow: hidden; }
        .css-bar-segment { height: 100%; display: flex; align-items: center; justify-content: center; font-size: 0.6rem; color: #000; font-weight: bold; }
    </style>
</head>
<body>

    <header>
        <div>
            <div id="abs-clock" class="main-clock">00000.0</div>
            <div style="font-size:0.6rem; color:#555">TIEMPO ABSOLUTO (S)</div>
        </div>
        <div style="text-align:right">
            <div id="real-time" style="font-size:0.8rem; font-weight:bold; color:#aaa">00:00:00</div>
            <button onclick="toggleFS()" style="background:none; border:1px solid #333; color:#555; font-size:9px; padding:2px 5px; margin-top:2px;">FULLSCREEN</button>
        </div>
    </header>

    <nav>
        <button class="tab-btn active" onclick="showView('capture', this)">1. Captura</button>
        <button class="tab-btn" onclick="showView('dashboard', this)">2. Gráficos</button>
        <button class="tab-btn" onclick="showView('sigma', this)">3. Estadística Pro</button>
    </nav>

    <div id="view-capture" class="view-section capture-layout active">
        <section class="left-list">
            <div class="log-container">
                <table>
                    <thead><tr><th>Actividad</th><th>Clase</th><th>Seg</th><th>Inicio</th></tr></thead>
                    <tbody id="log-table-body"></tbody>
                </table>
            </div>
            <div style="padding:5px; background:#111; display:flex; gap:5px; border-top:1px solid #222;">
                <input type="text" id="new-btn-name" placeholder="Nueva actividad..." style="flex:1; border-radius:4px;">
                <button onclick="addButton()" style="width:40px; background:var(--neon-blue); border:none; border-radius:4px; font-weight:bold;">+</button>
            </div>
        </section>
        <section class="right-buttons" id="buttons-area"></section>
    </div>

    <div id="view-dashboard" class="view-section dashboard-layout">
        <div class="kpi-grid">
            <div class="kpi-card"><div class="kpi-val" id="kpi-total">0</div><div class="kpi-lbl">Total</div></div>
            <div class="kpi-card"><div class="kpi-val" id="kpi-int" style="color:var(--neon-blue)">0</div><div class="kpi-lbl">Interna</div></div>
            <div class="kpi-card"><div class="kpi-val" id="kpi-ext" style="color:var(--neon-green)">0</div><div class="kpi-lbl">Externa</div></div>
            <div class="kpi-card"><div class="kpi-val" id="kpi-muda" style="color:var(--neon-orange)">0</div><div class="kpi-lbl">Muda</div></div>
        </div>

        <div class="chart-wrapper">
            <div style="font-size:0.7rem; color:#aaa; margin-bottom:5px;">DISTRIBUCIÓN DE TIEMPOS</div>
            <div id="canvas-container-pie" style="position:relative; height:180px; display:none;">
                <canvas id="pieChart"></canvas>
            </div>
            <div id="css-pie-fallback" style="display:flex; flex-direction:column; justify-content:center; height:100%;">
                <div class="css-bar-container" id="css-proportion-bar"></div>
            </div>
        </div>

        <div class="chart-wrapper">
            <div style="font-size:0.7rem; color:#aaa; margin-bottom:5px;">CRONOLOGÍA (GANTT)</div>
            <div id="canvas-container-bar" style="position:relative; height:220px; display:none;">
                <canvas id="barChart"></canvas>
            </div>
            <div id="css-gantt-fallback" style="overflow-y:auto; flex:1;"></div>
        </div>
    </div>

    <div id="view-sigma" class="view-section sigma-layout">
        <div style="margin-bottom:10px; font-size:0.8rem; font-weight:bold; color:#fff;">ANÁLISIS DE VARIABILIDAD (BOX PLOTS)</div>
        
        <div class="filter-bar">
            <button class="filter-btn active" onclick="setBoxFilter('all', this)">VER TODAS</button>
            <button class="filter-btn" onclick="setBoxFilter('Interna', this)">INTERNAS</button>
            <button class="filter-btn" onclick="setBoxFilter('Externa', this)">EXTERNAS</button>
            <button class="filter-btn" onclick="setBoxFilter('Muda', this)">MUDAS</button>
        </div>

        <div class="boxplot-container">
            <canvas id="boxPlotCanvas"></canvas>
        </div>

        <div class="stat-table-container" style="background:#111; border-radius:6px; overflow-x:auto;">
            <table class="stat-detail-table">
                <thead>
                    <tr>
                        <th>Tarea</th>
                        <th>Frec</th>
                        <th>Media</th>
                        <th>Min</th>
                        <th>Q1</th>
                        <th>Med</th>
                        <th>Q3</th>
                        <th>Max</th>
                    </tr>
                </thead>
                <tbody id="sigma-body"></tbody>
            </table>
        </div>
    </div>

    <input type="file" id="csv-file-input" accept=".csv" multiple onchange="handleFileImport(this)">

    <footer>
        <button class="btn-act" style="background:var(--neon-blue); color:#000" onclick="triggerImport()">IMPORTAR</button>
        <button class="btn-act" onclick="exportData('csv')">CSV</button>
        <button class="btn-act" onclick="exportData('txt')">TXT</button>
        <button class="btn-act" style="background:#311; color:#f55; border-color:#522" onclick="rescueData()">FIX</button>
        <button class="btn-act" style="background:#000; color:#555" onclick="hardReset()">RESET</button>
    </footer>

    <script>
        // --- CORE DATA ---
        let absTime = 0;
        let logs = [];
        let btns = ["Troquel Desmontar", "Troquel Montar", "Sello Ajuste", "Limpieza"]; 
        let activeTasks = {};
        const C_INT = '#00d4ff'; const C_EXT = '#00ff00'; const C_MUDA = '#ffaa00';
        let currentBoxFilter = 'all';

        function init() {
            try {
                const sLogs = localStorage.getItem('smed_logs_v14');
                if(sLogs) logs = JSON.parse(sLogs);
                const sBtns = localStorage.getItem('smed_btns_v14');
                if(sBtns) btns = JSON.parse(sBtns);
            } catch(e) {}
            renderButtons();
            renderLogs();
            setInterval(tick, 100);
        }

        function tick() {
            const d = new Date();
            absTime = (d.getHours()*3600) + (d.getMinutes()*60) + d.getSeconds() + (d.getMilliseconds()/1000);
            document.getElementById('abs-clock').textContent = absTime.toFixed(1);
            document.getElementById('real-time').textContent = d.toLocaleTimeString();
        }

        /* --- BOTONES Y TAREAS --- */
        function addButton() {
            const name = document.getElementById('new-btn-name').value.trim();
            if(!name || btns.includes(name)) return;
            btns.push(name);
            saveData();
            renderButtons();
            document.getElementById('new-btn-name').value = "";
        }

        function renderButtons() {
            const container = document.getElementById('buttons-area');
            container.innerHTML = "";
            btns.forEach(name => {
                const grp = name.split(' ')[0].toUpperCase();
                const div = document.createElement('div');
                div.className = 'smed-btn-box';
                div.innerHTML = `<button class="smed-btn" onclick="toggleTask(this, '${name}')">${name}<div class="grp-label">${grp}</div></button><button class="del-btn" onclick="delButton('${name}')">×</button>`;
                container.appendChild(div);
            });
        }

        function delButton(name) {
            if(confirm("¿Borrar botón?")) {
                btns = btns.filter(b => b !== name);
                saveData();
                renderButtons();
            }
        }

        function toggleTask(btn, name) {
            const grp = name.split(' ')[0].toUpperCase();
            if(activeTasks[grp] && activeTasks[grp].name === name) {
                finishTask(grp, btn);
            } else {
                if(activeTasks[grp]) {
                    const prevName = activeTasks[grp].name;
                    const allBtns = document.querySelectorAll('.smed-btn');
                    let prevBtn = null;
                    allBtns.forEach(b => { if(b.textContent.includes(prevName)) prevBtn = b; });
                    if(prevBtn) finishTask(grp, prevBtn);
                }
                activeTasks[grp] = { name: name, start: absTime };
                btn.classList.add('active');
            }
        }

        function finishTask(grp, btn) {
            if(!activeTasks[grp]) return;
            const task = activeTasks[grp];
            const dur = parseFloat((absTime - task.start).toFixed(1));
            if(!isNaN(dur) && dur > 0) {
                logs.push({ name: task.name, type: "Interna", start: task.start.toFixed(1), end: absTime.toFixed(1), dur: dur });
                saveData();
                renderLogs();
            }
            delete activeTasks[grp];
            if(btn) btn.classList.remove('active');
        }

        function renderLogs() {
            const tbody = document.getElementById('log-table-body');
            tbody.innerHTML = logs.map((l, i) => `<tr><td>${l.name}</td><td><select onchange="updateType(${i}, this.value)" style="background:#000; color:#fff; border:1px solid #333; font-size:0.6rem"><option value="Interna" ${l.type==='Interna'?'selected':''}>Int</option><option value="Externa" ${l.type==='Externa'?'selected':''}>Ext</option><option value="Muda" ${l.type==='Muda'?'selected':''}>Muda</option></select></td><td style="color:var(--neon-orange); font-weight:bold">${l.dur}</td><td style="color:#555">${l.start}</td></tr>`).join('');
            const container = document.querySelector('.log-container');
            container.scrollTop = container.scrollHeight;
        }

        function updateType(idx, val) { logs[idx].type = val; saveData(); }
        function saveData() { localStorage.setItem('smed_logs_v14', JSON.stringify(logs)); localStorage.setItem('smed_btns_v14', JSON.stringify(btns)); }

        /* --- VISUALIZACIÓN --- */
        function showView(viewId, btn) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('view-'+viewId).classList.add('active');
            btn.classList.add('active');
            if(viewId === 'dashboard') updateDashboard();
            if(viewId === 'sigma') updateSigma();
        }

        /* --- DASHBOARD CHART.JS --- */
        let myPie = null, myBar = null;
        function updateDashboard() {
            let t = { Interna:0, Externa:0, Muda:0, Total:0 };
            logs.forEach(l => { const d = parseFloat(l.dur); if(!isNaN(d)) { t[l.type] += d; t.Total += d; } });
            document.getElementById('kpi-total').textContent = t.Total.toFixed(1);
            document.getElementById('kpi-int').textContent = t.Interna.toFixed(1);
            document.getElementById('kpi-ext').textContent = t.Externa.toFixed(1);
            document.getElementById('kpi-muda').textContent = t.Muda.toFixed(1);

            if(typeof Chart !== 'undefined') {
                document.getElementById('canvas-container-pie').style.display = 'block'; document.getElementById('css-pie-fallback').style.display = 'none';
                document.getElementById('canvas-container-bar').style.display = 'block'; document.getElementById('css-gantt-fallback').style.display = 'none';
                
                const ctxPie = document.getElementById('pieChart').getContext('2d');
                if(myPie) myPie.destroy();
                myPie = new Chart(ctxPie, { type: 'doughnut', data: { labels: ['Interna', 'Externa', 'Muda'], datasets: [{ data: [t.Interna, t.Externa, t.Muda], backgroundColor: [C_INT, C_EXT, C_MUDA], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position:'right', labels:{color:'#fff'} } } } });

                const ctxBar = document.getElementById('barChart').getContext('2d');
                if(myBar) myBar.destroy();
                const colorsGantt = logs.map(l => l.type==='Interna'?C_INT:(l.type==='Externa'?C_EXT:C_MUDA));
                myBar = new Chart(ctxBar, { type: 'bar', data: { labels: logs.map(l => l.name), datasets: [{ label: 'Línea de Tiempo', data: logs.map(l => [parseFloat(l.start), parseFloat(l.end)]), backgroundColor: colorsGantt, barPercentage: 0.5 }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { min: logs.length?parseFloat(logs[0].start):0, ticks: { color:'#666'} }, y: { ticks: { color:'#fff', font:{size:9} } } }, plugins: { legend: { display:false } } } });
            } else {
                // CSS Fallback logic omitted for brevity, identical to v13
                document.getElementById('canvas-container-pie').style.display = 'none'; document.getElementById('css-pie-fallback').style.display = 'flex';
                document.getElementById('canvas-container-bar').style.display = 'none'; document.getElementById('css-gantt-fallback').style.display = 'block';
                // (Implementar renderCSSCharts aquí si Chart.js falla)
            }
        }

        /* --- ESTADÍSTICA AVANZADA (BOX PLOTS) --- */
        function setBoxFilter(filter, btn) {
            currentBoxFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            updateSigma();
        }

        function updateSigma() {
            // 1. Filtrar y Agrupar Datos
            let groups = {};
            logs.forEach(l => {
                if(currentBoxFilter === 'all' || l.type === currentBoxFilter) {
                    if(!groups[l.name]) groups[l.name] = [];
                    groups[l.name].push(parseFloat(l.dur));
                }
            });

            const tbody = document.getElementById('sigma-body');
            tbody.innerHTML = "";
            let statsData = [];

            // 2. Calcular Estadísticos
            Object.keys(groups).forEach(name => {
                const times = groups[name].sort((a,b)=>a-b); // Ordenar para cuartiles
                const n = times.length;
                const sum = times.reduce((a,b)=>a+b,0);
                const avg = sum / n;
                const min = times[0];
                const max = times[n-1];
                
                // Cuartiles
                const q1 = percentile(times, 25);
                const med = percentile(times, 50);
                const q3 = percentile(times, 75);

                statsData.push({ name, n, avg, min, q1, med, q3, max, times });

                tbody.innerHTML += `
                    <tr>
                        <td>${name}</td>
                        <td>${n}</td>
                        <td style="color:var(--neon-blue)">${avg.toFixed(1)}</td>
                        <td>${min.toFixed(1)}</td>
                        <td>${q1.toFixed(1)}</td>
                        <td style="color:#fff; font-weight:bold">${med.toFixed(1)}</td>
                        <td>${q3.toFixed(1)}</td>
                        <td>${max.toFixed(1)}</td>
                    </tr>
                `;
            });

            // 3. Dibujar Box Plot en Canvas Nativo (Sin librerías)
            drawBoxPlots(statsData);
        }

        function percentile(arr, p) {
            if (arr.length === 0) return 0;
            if (typeof p !== 'number') throw new TypeError('p must be a number');
            if (p <= 0) return arr[0];
            if (p >= 100) return arr[arr.length - 1];

            const index = (arr.length - 1) * p / 100;
            const lower = Math.floor(index);
            const upper = lower + 1;
            const weight = index - lower;

            if (upper >= arr.length) return arr[lower];
            return arr[lower] * (1 - weight) + arr[upper] * weight;
        }

        function drawBoxPlots(stats) {
            const canvas = document.getElementById('boxPlotCanvas');
            const ctx = canvas.getContext('2d');
            
            // Ajustar resolución
            const rect = canvas.parentNode.getBoundingClientRect();
            canvas.width = rect.width * 2; // Retina scale
            canvas.height = rect.height * 2;
            ctx.scale(2, 2); 
            const w = rect.width;
            const h = rect.height;

            // Limpiar
            ctx.clearRect(0, 0, w, h);
            
            if(stats.length === 0) {
                ctx.fillStyle = "#555"; ctx.font = "14px monospace"; ctx.textAlign = "center";
                ctx.fillText("NO HAY DATOS PARA MOSTRAR", w/2, h/2);
                return;
            }

            // Escalas
            const maxVal = Math.max(...stats.map(s => s.max)) * 1.1; // 10% margen
            const paddingLeft = 100; // Espacio para nombres
            const paddingBottom = 20;
            const plotW = w - paddingLeft - 20;
            const plotH = h - paddingBottom;
            const barHeight = Math.min(40, (plotH / stats.length) - 10);
            
            stats.forEach((s, i) => {
                const y = (i * (plotH / stats.length)) + ((plotH / stats.length)/2);
                
                // Escalar X
                const xMin = paddingLeft + (s.min / maxVal) * plotW;
                const xQ1 = paddingLeft + (s.q1 / maxVal) * plotW;
                const xMed = paddingLeft + (s.med / maxVal) * plotW;
                const xQ3 = paddingLeft + (s.q3 / maxVal) * plotW;
                const xMax = paddingLeft + (s.max / maxVal) * plotW;

                // Nombres Eje Y
                ctx.fillStyle = "#ccc"; ctx.font = "10px monospace"; ctx.textAlign = "right";
                ctx.fillText(s.name.substring(0, 15), paddingLeft - 10, y + 4);

                // Bigotes (Whiskers) Linea de Min a Max
                ctx.strokeStyle = "#666"; ctx.lineWidth = 1;
                ctx.beginPath(); ctx.moveTo(xMin, y); ctx.lineTo(xMax, y); ctx.stroke();

                // Topes de Bigotes
                ctx.beginPath(); ctx.moveTo(xMin, y-5); ctx.lineTo(xMin, y+5); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(xMax, y-5); ctx.lineTo(xMax, y+5); ctx.stroke();

                // Caja (Q1 a Q3)
                ctx.fillStyle = "rgba(0, 212, 255, 0.2)"; // Neon Blue transparente
                ctx.strokeStyle = "#00d4ff";
                ctx.fillRect(xQ1, y - barHeight/2, xQ3 - xQ1, barHeight);
                ctx.strokeRect(xQ1, y - barHeight/2, xQ3 - xQ1, barHeight);

                // Mediana (Linea roja vertical)
                ctx.strokeStyle = "#ffaa00"; ctx.lineWidth = 2;
                ctx.beginPath(); ctx.moveTo(xMed, y - barHeight/2); ctx.lineTo(xMed, y + barHeight/2); ctx.stroke();
            });

            // Eje X (Regla)
            ctx.strokeStyle = "#333"; ctx.lineWidth = 1;
            ctx.beginPath(); ctx.moveTo(paddingLeft, plotH); ctx.lineTo(w, plotH); ctx.stroke();
        }

        /* --- IMPORT/EXPORT/UTIL --- */
        function triggerImport() { document.getElementById('csv-file-input').click(); }
        function handleFileImport(input) {
            const files = input.files;
            if(!files.length) return;
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const lines = e.target.result.split('\n');
                    lines.forEach(line => {
                        const parts = line.replace(/"/g, '').split(',');
                        if(parts.length >= 5 && !isNaN(parseFloat(parts[2]))) {
                            const name = parts[0].trim();
                            const start = parseFloat(parts[3]);
                            if(!logs.some(l => Math.abs(parseFloat(l.start)-start)<0.1 && l.name===name)) {
                                logs.push({ name: name, type: parts[1].trim(), dur: parseFloat(parts[2]), start: start.toFixed(1), end: parts[4] });
                            }
                        }
                    });
                    logs.sort((a,b)=>parseFloat(a.start)-parseFloat(b.start));
                    saveData(); renderLogs();
                };
                reader.readAsText(file);
            });
        }
        function exportData(format) {
            if(!logs.length) return alert("Sin datos");
            const op = prompt("OP:") || "X"; const resp = prompt("Resp:") || "X";
            let c = "";
            if(format==='csv') {
                c = `REPORTE SMED\nOP,${op},Resp,${resp}\n\nTarea,Tipo,Dur,Ini,Fin\n`;
                logs.forEach(l => c += `"${l.name}","${l.type}",${l.dur},${l.start},${l.end}\n`);
            } else { logs.forEach(l => c += `[${l.type}] ${l.name}: ${l.dur}s\n`); }
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([c], {type:'text/plain'})); a.download = `SMED_${op}.${format}`; a.click();
        }
        function rescueData() { if(confirm("Fix data?")) { logs=logs.filter(l=>!isNaN(parseFloat(l.dur))); saveData(); location.reload(); } }
        function hardReset() { if(confirm("Borrar todo?")) { localStorage.clear(); location.reload(); } }
        function toggleFS() { if(!document.fullscreenElement) document.documentElement.requestFullscreen().catch(e=>{}); else document.exitFullscreen(); }
        window.onload = init;
    </script>
</body>
</html>
