<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SMED Master V18</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <style>
        :root {
            --neon-green: #00ff00; --neon-red: #ff3333; --neon-blue: #00d4ff; 
            --neon-orange: #ffaa00; --bg-dark: #050505; --panel: #111;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; touch-action: manipulation; }
        body { background-color: var(--bg-dark); color: #fff; font-family: 'Segoe UI', Roboto, monospace; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* HEADER COMPACTO CON TODA LA INFO */
        header { 
            background: var(--panel); padding: 5px 10px; border-bottom: 1px solid #333; 
            display: grid; grid-template-columns: 1fr 1fr 1fr; align-items: center; 
            height: 60px; flex-shrink: 0;
        }

        .h-col { display: flex; flex-direction: column; justify-content: center; }
        .h-center { align-items: center; text-align: center; }
        .h-right { align-items: flex-end; text-align: right; }

        .main-clock { font-size: 1.4rem; font-weight: 900; color: var(--neon-green); line-height: 1; }
        .sub-clock { font-size: 0.6rem; color: #666; letter-spacing: 1px; }
        
        .rem-clock { font-size: 1.1rem; font-weight: bold; color: var(--neon-red); }
        .rem-label { font-size: 0.55rem; color: #844; }

        .real-time { font-size: 0.9rem; color: #fff; }
        .date-display { font-size: 0.6rem; color: var(--neon-blue); }

        /* NAVEGACIÓN */
        nav { display: flex; background: #000; border-bottom: 1px solid #333; height: 40px; flex-shrink: 0; }
        .tab-btn { flex: 1; background: none; border: none; color: #555; font-weight: bold; font-size: 0.7rem; text-transform: uppercase; cursor: pointer; }
        .tab-btn.active { color: var(--neon-blue); background: #151515; border-bottom: 2px solid var(--neon-blue); }

        /* VISTAS */
        .view-section { display: none; flex: 1; overflow: hidden; position: relative; }
        .view-section.active { display: flex; }

        /* VISTA 1: CAPTURA (Compacta) */
        .capture-layout { flex-direction: row; width: 100%; }
        .left-panel { flex: 1.2; display: flex; flex-direction: column; border-right: 1px solid #222; }
        .log-container { flex: 1; overflow-y: auto; background: #000; }
        .right-panel { flex: 1; background: #080808; padding: 5px; overflow-y: auto; display: flex; flex-direction: column; gap: 4px; }

        /* TABLA DE REGISTROS */
        table { width: 100%; border-collapse: collapse; font-size: 0.65rem; }
        th { background: #151515; color: var(--neon-blue); padding: 4px; text-align: left; position: sticky; top: 0; z-index: 2; border-bottom: 1px solid #333; }
        td { padding: 3px 5px; border-bottom: 1px solid #1a1a1a; color: #ccc; }
        .dur-cell { color: var(--neon-orange); font-weight: bold; }

        /* BOTONES SMED */
        .smed-btn-box { display: flex; height: 50px; border: 1px solid #333; border-radius: 4px; overflow: hidden; background: #151515; flex-shrink: 0; }
        .smed-btn { flex: 1; background: transparent; color: #ddd; border: none; text-align: left; padding-left: 8px; position: relative; font-weight: 600; font-size: 0.75rem; cursor: pointer; }
        .smed-btn.active { background: linear-gradient(90deg, #331500, #151515); color: var(--neon-orange); border-left: 3px solid var(--neon-orange); }
        .grp-label { position: absolute; top: 2px; right: 4px; font-size: 0.45rem; color: #555; text-transform: uppercase; }
        .del-btn { width: 25px; background: #220a0a; color: #f55; border: none; font-size: 0.9rem; cursor: pointer; border-left: 1px solid #333; }

        /* VISTA 2: GRÁFICOS */
        .dashboard-layout { flex-direction: column; padding: 10px; overflow-y: auto; background: #000; gap: 10px; }
        .chart-container { background: #111; border: 1px solid #333; border-radius: 6px; padding: 5px; min-height: 200px; display: flex; flex-direction: column; }
        .chart-title { font-size: 0.7rem; color: #888; margin-bottom: 5px; text-transform: uppercase; text-align: center; }

        /* VISTA 3: ESTADÍSTICA */
        .stats-layout { flex-direction: column; padding: 10px; overflow-y: auto; background: #000; }
        .kpi-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-bottom: 10px; }
        .kpi-card { background: #111; padding: 8px; border-radius: 4px; text-align: center; border: 1px solid #222; }
        .kpi-val { font-size: 0.9rem; font-weight: bold; }
        .kpi-lbl { font-size: 0.5rem; color: #666; }

        /* FOOTER */
        footer { height: 45px; background: var(--panel); border-top: 1px solid #333; display: flex; align-items: center; justify-content: center; gap: 5px; flex-shrink: 0; }
        .btn-foot { padding: 6px 10px; border-radius: 3px; border: 1px solid #444; background: #222; color: #fff; font-weight: bold; font-size: 0.65rem; cursor: pointer; }
        .btn-primary { background: var(--neon-blue); color: #000; border: none; }
        
        input { background: #000; border: 1px solid #333; color: #fff; padding: 5px; font-size: 0.7rem; }
        #csv-input { display: none; }
    </style>
</head>
<body>

    <header>
        <div class="h-col">
            <div id="abs-clock" class="main-clock">00000.0</div>
            <div class="sub-clock">SEGUNDOS DÍA</div>
        </div>
        <div class="h-col h-center">
            <div id="rem-sec" class="rem-clock">-00000</div>
            <div id="rem-hms" class="rem-label">FALTAN 00:00:00</div>
        </div>
        <div class="h-col h-right">
            <div id="real-time" class="real-time">00:00:00</div>
            <div id="date-display" class="date-display">--/--/--</div>
        </div>
    </header>

    <nav>
        <button class="tab-btn active" onclick="showTab('capture', this)">1. Registro</button>
        <button class="tab-btn" onclick="showTab('charts', this)">2. Gráficos</button>
        <button class="tab-btn" onclick="showTab('stats', this)">3. Datos</button>
    </nav>

    <div id="view-capture" class="view-section capture-layout active">
        <section class="left-panel">
            <div class="log-container">
                <table id="log-table">
                    <thead><tr><th>Tarea</th><th>Tipo</th><th>Dur</th><th>Fin</th></tr></thead>
                    <tbody id="log-body"></tbody>
                </table>
            </div>
            <div style="padding:5px; background:#111; display:flex; gap:5px; border-top:1px solid #222;">
                <input type="text" id="new-btn" placeholder="Nueva Tarea..." style="flex:1;">
                <button onclick="addBtn()" style="background:var(--neon-green); color:#000; border:none; padding:0 10px; font-weight:bold; border-radius:3px;">+</button>
            </div>
        </section>
        <section class="right-panel" id="btn-area"></section>
    </div>

    <div id="view-charts" class="view-section dashboard-layout">
        <div class="chart-container" style="flex:1">
            <div class="chart-title">Distribución de Tiempos (%)</div>
            <div style="flex:1; position:relative">
                <canvas id="pieChart"></canvas>
            </div>
        </div>
        <div class="chart-container" style="flex:1.5">
            <div class="chart-title">Cronología (Gantt)</div>
            <div style="flex:1; position:relative">
                <canvas id="barChart"></canvas>
            </div>
        </div>
    </div>

    <div id="view-stats" class="view-section stats-layout">
        <div class="kpi-row">
            <div class="kpi-card"><div class="kpi-val" id="k-total">0</div><div class="kpi-lbl">TOTAL</div></div>
            <div class="kpi-card"><div class="kpi-val" id="k-int" style="color:var(--neon-blue)">0</div><div class="kpi-lbl">INT</div></div>
            <div class="kpi-card"><div class="kpi-val" id="k-ext" style="color:var(--neon-green)">0</div><div class="kpi-lbl">EXT</div></div>
            <div class="kpi-card"><div class="kpi-val" id="k-muda" style="color:var(--neon-orange)">0</div><div class="kpi-lbl">MUDA</div></div>
        </div>
        
        <div style="background:#111; padding:10px; border-radius:5px;">
            <div class="chart-title">Resumen por Actividad</div>
            <table style="width:100%; text-align:center; font-size:0.7rem; margin-top:5px;">
                <thead><tr style="color:#888"><th>Tarea</th><th>N</th><th>Media</th><th>Max</th></tr></thead>
                <tbody id="stats-body"></tbody>
            </table>
        </div>
    </div>

    <input type="file" id="csv-input" accept=".csv" multiple onchange="importCSV(this)">

    <footer>
        <button class="btn-foot" onclick="toggleFS()">FS (F11)</button>
        <button class="btn-foot btn-primary" onclick="document.getElementById('csv-input').click()">IMPORTAR</button>
        <button class="btn-foot" onclick="exportData()">EXPORTAR</button>
        <button class="btn-foot" style="background:#300; color:#f55; border-color:#500" onclick="hardReset()">RESET</button>
    </footer>

    <script>
        // --- VARIABLES DE ESTADO ---
        let absTime = 0;
        // Usamos una clave NUEVA para evitar conflictos con versiones rotas
        let logs = JSON.parse(localStorage.getItem('smed_master_v18_logs')) || [];
        let btns = JSON.parse(localStorage.getItem('smed_master_v18_btns')) || ["Troquel Desmontar", "Troquel Montar", "Limpieza", "Ajuste"];
        let activeTasks = {}; // Objeto para manejar multitarea
        let charts = { pie: null, bar: null };

        // --- INICIO ---
        function init() {
            renderBtns();
            renderLogs();
            setInterval(tick, 100);
        }

        // --- RELOJES (Lo que pediste arreglar) ---
        function tick() {
            const now = new Date();
            // 1. Hora Absoluta en Segundos (con 1 decimal)
            const h = now.getHours();
            const m = now.getMinutes();
            const s = now.getSeconds();
            const ms = now.getMilliseconds();
            
            absTime = (h * 3600) + (m * 60) + s + (ms/1000);
            document.getElementById('abs-clock').textContent = absTime.toFixed(1);

            // 2. Cuenta Regresiva (86400 - Actual)
            const remaining = 86400 - absTime;
            document.getElementById('rem-sec').textContent = "-" + remaining.toFixed(0);
            
            // Convertir restante a HH:MM:SS
            const rH = Math.floor(remaining / 3600);
            const rM = Math.floor((remaining % 3600) / 60);
            const rS = Math.floor(remaining % 60);
            document.getElementById('rem-hms').textContent = 
                `FALTAN ${String(rH).padStart(2,'0')}:${String(rM).padStart(2,'0')}:${String(rS).padStart(2,'0')}`;

            // 3. Reloj Real y Fecha
            document.getElementById('real-time').textContent = now.toLocaleTimeString();
            document.getElementById('date-display').textContent = now.toLocaleDateString();
        }

        // --- LÓGICA SMED (BOTONES Y GRUPOS) ---
        function getGroup(name) {
            return name.split(' ')[0].toUpperCase();
        }

        function toggleTask(btn, name) {
            const group = getGroup(name);
            
            // A. Si presiono el mismo botón que está activo -> APAGAR
            if(activeTasks[group] && activeTasks[group].name === name) {
                stopTask(group, btn);
            } 
            // B. Si presiono otro botón del MISMO GRUPO -> APAGAR EL ANTERIOR, ENCENDER ESTE
            else {
                if(activeTasks[group]) {
                    // Buscar el botón visual del anterior para quitarle el estilo
                    const prevName = activeTasks[group].name;
                    // (Truco simple para encontrar el botón en el DOM)
                    renderBtns(); // Re-render rápido para limpiar estados
                    // Guardamos el anterior
                    saveLog(activeTasks[group], absTime); 
                }
                // Encender el nuevo
                activeTasks[group] = { name: name, start: absTime };
                renderBtns(); // Actualizar visualmente
            }
        }

        function stopTask(group, btn) {
            if(!activeTasks[group]) return;
            saveLog(activeTasks[group], absTime);
            delete activeTasks[group];
            renderBtns();
        }

        function saveLog(task, endTime) {
            const dur = parseFloat((endTime - task.start).toFixed(1));
            if(dur > 0) {
                logs.push({
                    name: task.name,
                    type: "Interna", // Por defecto
                    start: task.start.toFixed(1),
                    end: endTime.toFixed(1),
                    dur: dur
                });
                persist();
                renderLogs();
            }
        }

        // --- INTERFAZ ---
        function renderBtns() {
            const area = document.getElementById('btn-area');
            area.innerHTML = "";
            btns.forEach(name => {
                const group = getGroup(name);
                const isActive = activeTasks[group] && activeTasks[group].name === name;
                
                const div = document.createElement('div');
                div.className = 'smed-btn-box';
                div.innerHTML = `
                    <button class="smed-btn ${isActive?'active':''}" onclick="toggleTask(this, '${name}')">
                        ${name}
                        <div class="grp-label">${group}</div>
                    </button>
                    <button class="del-btn" onclick="delBtn('${name}')">×</button>
                `;
                area.appendChild(div);
            });
        }

        function addBtn() {
            const name = document.getElementById('new-btn').value.trim();
            if(!name || btns.includes(name)) return;
            btns.push(name); persist(); renderBtns();
            document.getElementById('new-btn').value = "";
        }

        function delBtn(name) {
            if(confirm("¿Eliminar botón?")) { btns = btns.filter(b=>b!==name); persist(); renderBtns(); }
        }

        function renderLogs() {
            const tbody = document.getElementById('log-body');
            // Mostramos los últimos 20 para no saturar
            tbody.innerHTML = logs.slice().reverse().map((l, i) => `
                <tr>
                    <td>${l.name}</td>
                    <td>
                        <select onchange="changeType(${logs.length - 1 - i}, this.value)" style="background:#000; color:#fff; border:none; font-size:0.6rem">
                            <option ${l.type==='Interna'?'selected':''}>Interna</option>
                            <option ${l.type==='Externa'?'selected':''}>Externa</option>
                            <option ${l.type==='Muda'?'selected':''}>Muda</option>
                        </select>
                    </td>
                    <td class="dur-cell">${l.dur}</td>
                    <td>${l.end}</td>
                </tr>
            `).join('');
            calcStats();
        }

        function changeType(realIndex, val) {
            logs[realIndex].type = val;
            persist();
            calcStats();
        }

        // --- ESTADÍSTICAS Y GRÁFICOS ---
        function calcStats() {
            let t = { Interna:0, Externa:0, Muda:0, Total:0 };
            let counts = {};

            logs.forEach(l => {
                const d = parseFloat(l.dur);
                t[l.type] += d;
                t.Total += d;

                if(!counts[l.name]) counts[l.name] = [];
                counts[l.name].push(d);
            });

            // Actualizar KPIs
            document.getElementById('k-total').textContent = t.Total.toFixed(1);
            document.getElementById('k-int').textContent = t.Interna.toFixed(1);
            document.getElementById('k-ext').textContent = t.Externa.toFixed(1);
            document.getElementById('k-muda').textContent = t.Muda.toFixed(1);

            // Tabla Resumen
            const tbody = document.getElementById('stats-body');
            tbody.innerHTML = Object.keys(counts).map(k => {
                const arr = counts[k];
                const avg = arr.reduce((a,b)=>a+b,0)/arr.length;
                return `<tr><td>${k}</td><td>${arr.length}</td><td>${avg.toFixed(1)}</td><td>${Math.max(...arr).toFixed(1)}</td></tr>`;
            }).join('');

            // Actualizar Gráficos (si la librería cargó)
            if(typeof Chart !== 'undefined' && document.getElementById('view-charts').classList.contains('active')) {
                updateCharts(t);
            }
        }

        function updateCharts(t) {
            // Pie
            const ctxP = document.getElementById('pieChart');
            if(charts.pie) charts.pie.destroy();
            charts.pie = new Chart(ctxP, {
                type: 'doughnut',
                data: {
                    labels: ['INT', 'EXT', 'MUDA'],
                    datasets: [{ data: [t.Interna, t.Externa, t.Muda], backgroundColor: ['#00d4ff', '#00ff00', '#ffaa00'], borderWidth: 0 }]
                },
                options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'right', labels:{color:'#fff', font:{size:9}}}} }
            });

            // Gantt Simplificado (Barra horizontal)
            const ctxB = document.getElementById('barChart');
            if(charts.bar) charts.bar.destroy();
            
            // Datos para Gantt
            const dataGantt = logs.map(l => ({
                x: [parseFloat(l.start), parseFloat(l.end)],
                y: l.name
            }));

            charts.bar = new Chart(ctxB, {
                type: 'bar',
                data: {
                    labels: logs.map(l=>l.name),
                    datasets: [{
                        label: 'Duración',
                        data: logs.map(l=>[parseFloat(l.start), parseFloat(l.end)]),
                        backgroundColor: logs.map(l => l.type==='Interna'?'#00d4ff':(l.type==='Externa'?'#00ff00':'#ffaa00')),
                        barPercentage: 0.5
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { min: logs.length?parseFloat(logs[0].start):0, ticks:{color:'#666'} },
                        y: { ticks:{color:'#fff', font:{size:9}} }
                    },
                    plugins: { legend: { display:false } }
                }
            });
        }

        // --- UTILIDADES ---
        function persist() {
            localStorage.setItem('smed_master_v18_logs', JSON.stringify(logs));
            localStorage.setItem('smed_master_v18_btns', JSON.stringify(btns));
        }

        function showTab(id, btn) {
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('view-'+id).classList.add('active');
            btn.classList.add('active');
            if(id === 'charts') calcStats(); // Forzar redibujado
        }

        function importCSV(input) {
            const files = input.files;
            if(!files.length) return;
            Array.from(files).forEach(f => {
                const r = new FileReader();
                r.onload = e => {
                    const lines = e.target.result.split('\n');
                    lines.forEach(line => {
                        const p = line.replace(/"/g,'').split(',');
                        if(p.length >= 3 && !isNaN(parseFloat(p[2]))) {
                            logs.push({
                                name: p[0].trim(),
                                type: p[1].trim(),
                                dur: parseFloat(p[2]),
                                start: p[3] || "0",
                                end: p[4] || "0"
                            });
                        }
                    });
                    persist(); renderLogs();
                };
                r.readAsText(f);
            });
            alert("Datos importados y fusionados.");
        }

        function exportData() {
            let c = "Tarea,Tipo,Duracion,Inicio,Fin\n";
            logs.forEach(l => c += `"${l.name}","${l.type}",${l.dur},${l.start},${l.end}\n`);
            const blob = new Blob([c], {type:'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `SMED_V18_${Date.now()}.csv`;
            a.click();
        }

        function hardReset() {
            if(confirm("¿RESET TOTAL? Se borrarán todos los datos.")) {
                localStorage.clear();
                location.reload();
            }
        }
        function toggleFS() { if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }

        window.onload = init;

    </script>
</body>
</html>
