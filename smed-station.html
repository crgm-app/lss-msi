<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SMED Parallel Master v15</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { --neon-green: #00ff00; --neon-blue: #00d4ff; --neon-orange: #ffaa00; --bg-dark: #050505; --panel: #111; }
        * { box-sizing: border-box; margin: 0; padding: 0; touch-action: manipulation; }
        body { background-color: var(--bg-dark); color: #fff; font-family: 'Segoe UI', sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        header { background: var(--panel); padding: 5px 10px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; flex-shrink: 0; }
        .main-clock { font-size: 1.8rem; font-weight: 900; font-family: monospace; color: var(--neon-green); }
        
        nav { display: flex; background: #000; border-bottom: 1px solid #333; height: 45px; flex-shrink: 0; }
        .tab-btn { flex: 1; background: none; border: none; color: #666; font-weight: bold; font-size: 0.75rem; text-transform: uppercase; cursor: pointer; }
        .tab-btn.active { color: var(--neon-blue); background: #151515; border-bottom: 3px solid var(--neon-blue); }

        .view-section { display: none; flex: 1; overflow: hidden; position: relative; }
        .view-section.active { display: flex; }

        /* CAPTURA MULTITAREA */
        .capture-layout { flex-direction: row; width: 100%; }
        .left-list { flex: 1.2; display: flex; flex-direction: column; border-right: 1px solid #333; }
        .log-container { flex: 1; overflow-y: auto; background: #000; }
        .right-buttons { flex: 1.8; background: #080808; padding: 5px; overflow-y: auto; display: grid; grid-template-columns: 1fr; gap: 6px; align-content: start; }

        table { width: 100%; border-collapse: collapse; font-family: monospace; font-size: 0.65rem; }
        th { background: #151515; color: var(--neon-blue); padding: 5px; text-align: left; position: sticky; top: 0; z-index: 2; }
        td { padding: 4px 6px; border-bottom: 1px solid #222; }

        /* BOTONES MEJORADOS */
        .smed-btn-box { display: flex; height: 55px; border: 1px solid #333; border-radius: 6px; overflow: hidden; background: #151515; }
        .smed-btn { flex: 1; background: transparent; color: #fff; border: none; text-align: left; padding-left: 12px; position: relative; font-weight: bold; font-size: 0.85rem; cursor: pointer; }
        
        /* Animación de activo */
        .smed-btn.active { 
            background: #221100; 
            color: var(--neon-orange); 
            border-left: 4px solid var(--neon-orange);
            animation: pulse-border 1.5s infinite;
        }

        @keyframes pulse-border {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        .grp-tag { font-size: 0.55rem; color: #555; display: block; text-transform: uppercase; margin-bottom: 2px; }
        .del-btn { width: 35px; background: #1a0a0a; color: #444; border: none; font-size: 1.2rem; }

        /* DASHBOARD Y STATS OMITIDOS POR BREVEDAD, PERO FUNCIONALES */
        footer { height: 55px; background: var(--panel); border-top: 1px solid #333; display: flex; align-items: center; justify-content: center; gap: 5px; flex-shrink: 0; }
        .btn-act { padding: 8px 10px; border-radius: 4px; border: 1px solid #444; background: #222; color: #fff; font-weight: bold; font-size: 0.65rem; }

        #csv-file-input { display: none; }
    </style>
</head>
<body>

    <header>
        <div><div id="abs-clock" class="main-clock">00000.0</div><div style="font-size:0.5rem; color:#555">SISTEMA MULTI-TAREA</div></div>
        <div style="text-align:right"><div id="real-time" style="font-size:0.8rem; color:#aaa">00:00:00</div></div>
    </header>

    <nav>
        <button class="tab-btn active" onclick="showView('capture', this)">Captura</button>
        <button class="tab-btn" onclick="showView('dashboard', this)">Gráficos</button>
        <button class="tab-btn" onclick="showView('sigma', this)">Estadística</button>
    </nav>

    <div id="view-capture" class="view-section capture-layout active">
        <section class="left-list">
            <div class="log-container">
                <table>
                    <thead><tr><th>Actividad</th><th>Tipo</th><th>Seg</th></tr></thead>
                    <tbody id="log-table-body"></tbody>
                </table>
            </div>
            <div style="padding:8px; background:#111; display:flex; flex-direction:column; gap:5px;">
                <input type="text" id="new-btn-name" placeholder="Ej: GRUPO Actividad" style="background:#000; border:1px solid #333; color:#fff; padding:8px; border-radius:4px; font-size:0.7rem;">
                <button onclick="addButton()" style="background:var(--neon-blue); border:none; padding:8px; border-radius:4px; font-weight:bold; color:#000;">AGREGAR BOTÓN</button>
                <p style="font-size:0.5rem; color:#555; text-align:center;">Botones con mismo GRUPO se detienen entre sí.<br>Nombres únicos son independientes.</p>
            </div>
        </section>
        <section class="right-buttons" id="buttons-area"></section>
    </div>

    <div id="view-dashboard" class="view-section" style="padding:10px; flex-direction:column; overflow-y:auto;">
        <canvas id="pieChart" style="max-height:200px;"></canvas>
        <div id="css-gantt-fallback" style="margin-top:20px;"></div>
    </div>

    <div id="view-sigma" class="view-section" style="padding:10px; flex-direction:column; overflow-y:auto;">
        <table style="width:100%; border-collapse:collapse;" id="sigma-table">
            <thead><tr style="color:var(--neon-blue)"><th>Tarea</th><th>N</th><th>Media</th><th>Max</th></tr></thead>
            <tbody id="sigma-body"></tbody>
        </table>
    </div>

    <input type="file" id="csv-file-input" accept=".csv" multiple onchange="handleFileImport(this)">

    <footer>
        <button class="btn-act" style="background:var(--neon-blue); color:#000" onclick="document.getElementById('csv-file-input').click()">IMPORTAR</button>
        <button class="btn-act" onclick="exportData('csv')">CSV</button>
        <button class="btn-act" style="background:#200; color:#f55;" onclick="hardReset()">RESET</button>
    </footer>

    <script>
        let absTime = 0;
        let logs = [];
        let btns = ["PRENSA Ajuste", "PRENSA Limpieza", "CONTROL Inspeccion", "EMBALAJE"]; 
        let activeTasks = {}; // Ahora guarda múltiples: { 'PRENSA': {name, start}, 'EMBALAJE': {name, start} }

        function init() {
            const sLogs = localStorage.getItem('smed_logs_v15');
            if(sLogs) logs = JSON.parse(sLogs);
            const sBtns = localStorage.getItem('smed_btns_v15');
            if(sBtns) btns = JSON.parse(sBtns);
            renderButtons();
            renderLogs();
            setInterval(() => {
                absTime += 0.1;
                document.getElementById('abs-clock').textContent = absTime.toFixed(1);
                document.getElementById('real-time').textContent = new Date().toLocaleTimeString();
            }, 100);
        }

        function renderButtons() {
            const container = document.getElementById('buttons-area');
            container.innerHTML = "";
            btns.forEach(fullName => {
                const parts = fullName.split(' ');
                const group = parts.length > 1 ? parts[0] : fullName; // Si no tiene espacio, el grupo es el nombre mismo
                const label = parts.length > 1 ? parts.slice(1).join(' ') : fullName;

                const div = document.createElement('div');
                div.className = 'smed-btn-box';
                
                // Verificar si este botón específico está activo
                const isActive = Object.values(activeTasks).some(t => t.name === fullName);
                
                div.innerHTML = `
                    <button class="smed-btn ${isActive ? 'active' : ''}" onclick="handleTaskClick(this, '${fullName}', '${group}')">
                        <span class="grp-tag">${group}</span>
                        ${label}
                    </button>
                    <button class="del-btn" onclick="delButton('${fullName}')">×</button>
                `;
                container.appendChild(div);
            });
        }

        function handleTaskClick(btn, name, group) {
            // 1. Si el botón que presioné ya estaba activo -> LO DETENGO
            if (activeTasks[group] && activeTasks[group].name === name) {
                stopTask(group);
            } 
            // 2. Si hay otro botón del MISMO GRUPO corriendo -> DETENGO EL ANTERIOR Y ARRANCO ESTE
            else if (activeTasks[group]) {
                stopTask(group);
                startTask(group, name);
            }
            // 3. Si no hay nada de este grupo -> ARRANCO
            else {
                startTask(group, name);
            }
            renderButtons();
        }

        function startTask(group, name) {
            activeTasks[group] = { name: name, start: absTime };
        }

        function stopTask(group) {
            const task = activeTasks[group];
            const duration = parseFloat((absTime - task.start).toFixed(1));
            if (duration > 0.2) {
                logs.push({
                    name: task.name,
                    type: "Interna",
                    dur: duration,
                    start: task.start.toFixed(1),
                    end: absTime.toFixed(1)
                });
                saveData();
                renderLogs();
            }
            delete activeTasks[group];
        }

        function addButton() {
            const val = document.getElementById('new-btn-name').value.trim();
            if(!val || btns.includes(val)) return;
            btns.push(val);
            saveData();
            renderButtons();
            document.getElementById('new-btn-name').value = "";
        }

        function delButton(n) { btns = btns.filter(b => b!==n); saveData(); renderButtons(); }

        function renderLogs() {
            const tbody = document.getElementById('log-table-body');
            tbody.innerHTML = logs.slice(-10).reverse().map(l => `
                <tr><td>${l.name}</td><td>${l.type[0]}</td><td style="color:var(--neon-orange)">${l.dur}s</td></tr>
            `).join('');
        }

        function showView(v, b) {
            document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
            document.getElementById('view-'+v).classList.add('active');
            b.classList.add('active');
            if(v === 'sigma') updateSigma();
        }

        function updateSigma() {
            const tbody = document.getElementById('sigma-body');
            let g = {};
            logs.forEach(l => { if(!g[l.name]) g[l.name]=[]; g[l.name].push(l.dur); });
            tbody.innerHTML = Object.keys(g).map(k => {
                const avg = g[k].reduce((a,b)=>a+b,0)/g[k].length;
                return `<tr><td>${k}</td><td>${g[k].length}</td><td>${avg.toFixed(1)}</td><td>${Math.max(...g[k])}</td></tr>`;
            }).join('');
        }

        function exportData(fmt) {
            let c = "Tarea,Tipo,Duracion,Inicio,Fin\n";
            logs.forEach(l => c += `"${l.name}","${l.type}",${l.dur},${l.start},${l.end}\n`);
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([c], {type:'text/csv'}));
            a.download = `SMED_V15.csv`;
            a.click();
        }

        function saveData() { 
            localStorage.setItem('smed_logs_v15', JSON.stringify(logs)); 
            localStorage.setItem('smed_btns_v15', JSON.stringify(btns)); 
        }

        function hardReset() { if(confirm("¿Borrar todo?")) { localStorage.clear(); location.reload(); } }

        window.onload = init;
    </script>
</body>
</html>
