<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SMED Ultimate V19</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { --neon-green: #00ff00; --neon-red: #ff3333; --neon-blue: #00d4ff; --neon-orange: #ffaa00; --bg-dark: #050505; --panel: #111; }
        * { box-sizing: border-box; margin: 0; padding: 0; touch-action: manipulation; }
        body { background-color: var(--bg-dark); color: #fff; font-family: 'Segoe UI', Roboto, sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* HEADER */
        header { 
            background: var(--panel); padding: 5px 10px; border-bottom: 1px solid #333; 
            display: flex; justify-content: space-between; align-items: center; 
            height: 55px; flex-shrink: 0;
        }
        .main-clock { font-size: 1.5rem; font-weight: 900; color: var(--neon-green); font-family: monospace; }
        .header-btn { background: #222; border: 1px solid #444; color: #ccc; padding: 5px 10px; border-radius: 4px; font-size: 0.7rem; cursor: pointer; }

        /* NAV */
        nav { display: flex; background: #000; border-bottom: 1px solid #333; height: 45px; flex-shrink: 0; }
        .tab-btn { flex: 1; background: none; border: none; color: #666; font-weight: bold; font-size: 0.75rem; text-transform: uppercase; cursor: pointer; }
        .tab-btn.active { color: var(--neon-blue); background: #151515; border-bottom: 3px solid var(--neon-blue); }

        /* VISTAS */
        .view-section { display: none; flex: 1; overflow: hidden; position: relative; }
        .view-section.active { display: flex; }

        /* VISTA 1: CAPTURA */
        .capture-layout { flex-direction: row; width: 100%; }
        .left-panel { flex: 1.2; display: flex; flex-direction: column; border-right: 1px solid #222; }
        .log-container { flex: 1; overflow-y: auto; background: #000; }
        .right-panel { flex: 1; background: #080808; padding: 5px; overflow-y: auto; display: flex; flex-direction: column; gap: 4px; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.7rem; }
        th { background: #151515; color: var(--neon-blue); padding: 5px; text-align: left; position: sticky; top: 0; border-bottom: 1px solid #333; }
        td { padding: 4px; border-bottom: 1px solid #222; color: #ccc; }

        .smed-btn-box { display: flex; height: 50px; border: 1px solid #333; border-radius: 4px; overflow: hidden; background: #151515; flex-shrink: 0; }
        .smed-btn { flex: 1; background: transparent; color: #ddd; border: none; text-align: left; padding-left: 10px; font-weight: bold; font-size: 0.8rem; position: relative; }
        .smed-btn.active { background: linear-gradient(90deg, #331500, #151515); color: var(--neon-orange); border-left: 3px solid var(--neon-orange); }
        .grp-label { position: absolute; top: 2px; right: 5px; font-size: 0.5rem; color: #555; text-transform: uppercase; }
        .del-btn { width: 30px; background: #221; color: #f55; border: none; font-size: 1rem; }

        /* VISTA 2: ANÁLISIS INTELIGENTE Y GANTT */
        .dashboard-layout { flex-direction: column; padding: 10px; overflow-y: auto; background: #000; gap: 15px; }
        
        .smart-analysis-box { background: #111; border: 1px solid #333; border-radius: 6px; padding: 10px; }
        .smart-title { color: var(--neon-blue); font-size: 0.8rem; font-weight: bold; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
        .smart-list { list-style: none; padding: 0; font-size: 0.75rem; color: #ccc; }
        .smart-list li { margin-bottom: 4px; padding-left: 10px; border-left: 2px solid #555; }
        
        .chart-wrapper { background: #111; border: 1px solid #333; border-radius: 6px; padding: 10px; display: flex; flex-direction: column; }
        
        /* GANTT SCROLLABLE AREA */
        .gantt-scroll-area { 
            width: 100%; 
            overflow-x: auto; /* Permite scroll horizontal */
            overflow-y: hidden;
            border: 1px solid #222;
            background: #080808;
            margin-top: 10px;
        }
        
        /* VISTA 3: ESTADÍSTICA (VELAS) */
        .stats-layout { flex-direction: column; padding: 10px; overflow-y: auto; background: #000; }
        .boxplot-wrapper { height: 350px; background: #111; border: 1px solid #333; border-radius: 6px; padding: 10px; margin-bottom: 10px; }

        /* FOOTER */
        footer { height: 50px; background: var(--panel); border-top: 1px solid #333; display: flex; align-items: center; justify-content: center; gap: 5px; flex-shrink: 0; }
        .btn-foot { padding: 8px 12px; border-radius: 3px; border: 1px solid #444; background: #222; color: #fff; font-weight: bold; font-size: 0.7rem; }
        input { background: #000; border: 1px solid #333; color: #fff; padding: 5px; }
        #csv-input { display: none; }
    </style>
</head>
<body>

    <header>
        <div>
            <div style="font-size:0.5rem; color:#666">TIEMPO ACTUAL</div>
            <div id="abs-clock" class="main-clock">00000.0</div>
        </div>
        <div style="text-align:right">
            <button class="header-btn" onclick="toggleFS()">PANTALLA COMPLETA</button>
            <div id="real-time" style="font-size:0.7rem; color:#aaa; margin-top:2px">00:00:00</div>
        </div>
    </header>

    <nav>
        <button class="tab-btn active" onclick="showTab('capture', this)">Captura</button>
        <button class="tab-btn" onclick="showTab('dashboard', this)">Análisis Smart</button>
        <button class="tab-btn" onclick="showTab('stats', this)">Estadística</button>
    </nav>

    <div id="view-capture" class="view-section capture-layout active">
        <section class="left-panel">
            <div class="log-container">
                <table id="log-table">
                    <thead><tr><th>Tarea</th><th>Tipo</th><th>Dur</th><th>Fin</th></tr></thead>
                    <tbody id="log-body"></tbody>
                </table>
            </div>
            <div style="padding:5px; background:#111; display:flex; gap:5px; border-top:1px solid #222;">
                <input type="text" id="new-btn" placeholder="Nueva Tarea..." style="flex:1;">
                <button onclick="addBtn()" style="background:var(--neon-blue); color:#000; border:none; padding:0 10px; font-weight:bold; border-radius:3px;">+</button>
            </div>
        </section>
        <section class="right-panel" id="btn-area"></section>
    </div>

    <div id="view-dashboard" class="view-section dashboard-layout">
        
        <div class="smart-analysis-box">
            <div class="smart-title">✨ Análisis Inteligente de Procesos</div>
            <ul id="smart-list" class="smart-list">
                <li>Registra datos para ver recomendaciones...</li>
            </ul>
        </div>

        <div class="chart-wrapper">
            <div style="font-size:0.7rem; color:#888; text-align:center; margin-bottom:5px;">DISTRIBUCIÓN DE TIEMPOS</div>
            <div style="position:relative; height: 200px; width: 100%; display:flex; justify-content:center;">
                <canvas id="pieChart"></canvas>
            </div>
        </div>

        <div class="chart-wrapper">
            <div style="font-size:0.7rem; color:#888; text-align:center;">HORIZONTE CRONOLÓGICO (DESLIZA PARA VER MÁS ➡)</div>
            <div class="gantt-scroll-area">
                <canvas id="ganttCanvas" height="250" width="1200"></canvas>
            </div>
        </div>
    </div>

    <div id="view-stats" class="view-section stats-layout">
        <div class="boxplot-wrapper">
            <div style="font-size:0.7rem; color:#888; margin-bottom:5px; text-align:center">DIAGRAMA DE VELAS (MIN - MEDIANA - MAX)</div>
            <canvas id="boxPlotCanvas"></canvas>
        </div>
        
        <div style="background:#111; padding:10px; border-radius:5px;">
            <table style="width:100%; text-align:center; font-size:0.7rem;">
                <thead><tr style="color:#888"><th>Tarea</th><th>Cant</th><th>Promedio</th><th>Max</th></tr></thead>
                <tbody id="stats-body"></tbody>
            </table>
        </div>
    </div>

    <input type="file" id="csv-input" accept=".csv" multiple onchange="importCSV(this)">

    <footer>
        <button class="btn-foot" style="background:var(--neon-blue); color:#000" onclick="document.getElementById('csv-input').click()">IMPORTAR</button>
        <button class="btn-foot" onclick="exportData()">EXPORTAR</button>
        <button class="btn-foot" style="background:#300; color:#f55; border-color:#500" onclick="hardReset()">RESET</button>
    </footer>

    <script>
        // --- ESTADO ---
        let absTime = 0;
        let logs = JSON.parse(localStorage.getItem('smed_v19_logs')) || [];
        let btns = JSON.parse(localStorage.getItem('smed_v19_btns')) || ["Troquel Desmontar", "Troquel Montar", "Sello Ajuste", "Limpieza"];
        let activeTasks = {}; 
        let pieChartInst = null;

        function init() {
            renderBtns();
            renderLogs();
            setInterval(tick, 100);
            window.addEventListener('resize', () => { if(document.getElementById('view-stats').classList.contains('active')) drawBoxPlots(); });
        }

        function tick() {
            const now = new Date();
            absTime = (now.getHours()*3600)+(now.getMinutes()*60)+now.getSeconds()+(now.getMilliseconds()/1000);
            document.getElementById('abs-clock').textContent = absTime.toFixed(1);
            document.getElementById('real-time').textContent = now.toLocaleTimeString();
        }

        /* --- LÓGICA DE GRUPOS (MIXTA) --- */
        function getGroup(name) { return name.split(' ')[0].toUpperCase(); }

        function toggleTask(btn, name) {
            const group = getGroup(name);
            if(activeTasks[group] && activeTasks[group].name === name) {
                stopTask(group);
            } else {
                if(activeTasks[group]) stopTask(group); // Apagar anterior del mismo grupo
                activeTasks[group] = { name: name, start: absTime };
                renderBtns();
            }
        }

        function stopTask(group) {
            if(!activeTasks[group]) return;
            const task = activeTasks[group];
            const dur = parseFloat((absTime - task.start).toFixed(1));
            if(dur > 0) {
                logs.push({ name: task.name, type: "Interna", start: task.start.toFixed(1), end: absTime.toFixed(1), dur: dur });
                persist(); renderLogs();
            }
            delete activeTasks[group];
            renderBtns();
        }

        /* --- VISUALIZACIÓN --- */
        function showTab(id, btn) {
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('view-'+id).classList.add('active');
            btn.classList.add('active');
            
            if(id === 'dashboard') {
                updateSmartAnalysis();
                drawPie();
                drawGantt();
            }
            if(id === 'stats') {
                updateStatTable();
                setTimeout(drawBoxPlots, 100); // Delay para asegurar que el canvas tenga tamaño
            }
        }

        /* --- ANÁLISIS INTELIGENTE (RECUPERADO) --- */
        function updateSmartAnalysis() {
            const list = document.getElementById('smart-list');
            list.innerHTML = "";
            
            if(logs.length < 3) {
                list.innerHTML = "<li>Registra más datos para ver análisis.</li>";
                return;
            }

            // 1. Calcular Pareto (Quién consume más tiempo)
            let totals = {};
            let grandTotal = 0;
            logs.forEach(l => {
                if(!totals[l.name]) totals[l.name] = 0;
                totals[l.name] += l.dur;
                grandTotal += l.dur;
            });

            // Ordenar
            const sortedTasks = Object.keys(totals).sort((a,b) => totals[b] - totals[a]);
            const topTask = sortedTasks[0];
            const topPct = ((totals[topTask] / grandTotal) * 100).toFixed(1);

            list.innerHTML += `<li style="border-color:var(--neon-red)"><b>Atención Pareto:</b> "${topTask}" consume el <b>${topPct}%</b> del tiempo total. Prioriza reducir esta tarea.</li>`;

            // 2. Calcular Variabilidad (Desviación)
            let groups = {};
            logs.forEach(l => { if(!groups[l.name]) groups[l.name]=[]; groups[l.name].push(l.dur); });
            
            Object.keys(groups).forEach(name => {
                const arr = groups[name];
                if(arr.length > 2) {
                    const avg = arr.reduce((a,b)=>a+b,0)/arr.length;
                    const max = Math.max(...arr);
                    const min = Math.min(...arr);
                    const variation = max - min;
                    
                    if(variation > avg) {
                        list.innerHTML += `<li style="border-color:var(--neon-orange)"><b>Alta Variabilidad en "${name}":</b> Diferencia de ${variation.toFixed(1)}s entre el mejor y peor tiempo. Estandarizar proceso.</li>`;
                    }
                }
            });

            // 3. Recomendación SMED General
            const extTime = logs.filter(l=>l.type==='Externa').reduce((a,b)=>a+b.dur,0);
            if(extTime === 0 && logs.length > 5) {
                 list.innerHTML += `<li style="border-color:var(--neon-blue)"><b>Consejo SMED:</b> No tienes tareas "Externas". Revisa si "${topTask}" se puede hacer con la máquina en marcha.</li>`;
            }
        }

        /* --- GANTT HORIZONTAL CON SCROLL --- */
        function drawGantt() {
            const canvas = document.getElementById('ganttCanvas');
            const ctx = canvas.getContext('2d');
            
            // Configurar anchura dinámica basada en datos si se desea, o fija larga (24h)
            // Aquí usaremos 0 a 24h mapeado a 1200px para permitir scroll
            const W = 1200; 
            const H = 250;
            canvas.width = W; canvas.height = H;

            ctx.fillStyle = "#080808"; ctx.fillRect(0,0,W,H);
            
            // Dibujar líneas de hora
            ctx.strokeStyle = "#222"; ctx.lineWidth = 1;
            ctx.fillStyle = "#555"; ctx.font = "10px monospace";
            for(let h=0; h<=24; h++) {
                const x = (h/24) * W;
                ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, H); ctx.stroke();
                ctx.fillText(h+"h", x+2, 10);
            }

            // Agrupar Tareas Únicas para Eje Y
            const uniqueTasks = [...new Set(logs.map(l => l.name))];
            const rowHeight = (H - 20) / (uniqueTasks.length || 1);

            logs.forEach(l => {
                const startSec = parseFloat(l.start);
                const endSec = parseFloat(l.end);
                
                // Convertir segundos del día (0-86400) a posición X (0-1200)
                const x1 = (startSec / 86400) * W;
                const x2 = (endSec / 86400) * W;
                const wBar = Math.max(x2 - x1, 2); // Mínimo 2px
                
                const taskIndex = uniqueTasks.indexOf(l.name);
                const y = 20 + (taskIndex * rowHeight) + (rowHeight * 0.2);
                const hBar = rowHeight * 0.6;

                // Color según tipo
                ctx.fillStyle = l.type==='Interna' ? '#00d4ff' : (l.type==='Externa' ? '#00ff00' : '#ffaa00');
                ctx.fillRect(x1, y, wBar, hBar);
                
                // Nombre de la tarea (Dibujar solo si cabe o una vez por fila)
                ctx.fillStyle = "#fff"; ctx.font = "10px sans-serif";
                // Dibujamos el nombre a la izquierda de la barra o al inicio de la fila
                ctx.fillText(l.name, 5, y + hBar/2 + 3); 
            });
        }

        /* --- GRÁFICO DE VELAS (BOX PLOT) CON VALORES --- */
        function drawBoxPlots() {
            const canvas = document.getElementById('boxPlotCanvas');
            const ctx = canvas.getContext('2d');
            const parent = canvas.parentElement;
            canvas.width = parent.clientWidth; canvas.height = parent.clientHeight;
            const W = canvas.width; const H = canvas.height;

            ctx.clearRect(0,0,W,H);
            
            // Agrupar datos
            let groups = {};
            logs.forEach(l => {
                if(!groups[l.name]) groups[l.name]=[];
                groups[l.name].push(l.dur);
            });
            
            const taskNames = Object.keys(groups);
            if(taskNames.length === 0) return;

            // Encontrar escala máxima
            const maxVal = Math.max(...logs.map(l=>l.dur)) * 1.1;
            const rowH = H / taskNames.length;

            taskNames.forEach((name, i) => {
                const vals = groups[name].sort((a,b)=>a-b);
                const min = vals[0];
                const max = vals[vals.length-1];
                const med = vals[Math.floor(vals.length/2)];
                const q1 = vals[Math.floor(vals.length*0.25)];
                const q3 = vals[Math.floor(vals.length*0.75)];

                const y = i * rowH + rowH/2;
                const padLeft = 100; // Espacio para nombre
                const chartW = W - padLeft - 20;

                const toX = (v) => padLeft + (v/maxVal)*chartW;

                // Nombre Tarea
                ctx.fillStyle = "#aaa"; ctx.textAlign="right"; ctx.font="10px monospace";
                ctx.fillText(name.substring(0,15), padLeft-10, y+4);

                // Línea Rango (Min a Max)
                ctx.strokeStyle="#555"; ctx.beginPath(); ctx.moveTo(toX(min), y); ctx.lineTo(toX(max), y); ctx.stroke();
                
                // Topes
                ctx.beginPath(); ctx.moveTo(toX(min), y-5); ctx.lineTo(toX(min), y+5); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(toX(max), y-5); ctx.lineTo(toX(max), y+5); ctx.stroke();

                // Caja (Q1 a Q3)
                ctx.fillStyle="rgba(0, 212, 255, 0.2)";
                ctx.fillRect(toX(q1), y-8, toX(q3)-toX(q1), 16);
                ctx.strokeStyle="#00d4ff";
                ctx.strokeRect(toX(q1), y-8, toX(q3)-toX(q1), 16);

                // Mediana
                ctx.strokeStyle="#ffaa00"; ctx.lineWidth=2;
                ctx.beginPath(); ctx.moveTo(toX(med), y-8); ctx.lineTo(toX(med), y+8); ctx.stroke();
                ctx.lineWidth=1;

                // --- ETIQUETAS DE VALORES (TEXTO) ---
                ctx.fillStyle="#fff"; ctx.font="9px sans-serif"; ctx.textAlign="center";
                // Min abajo
                ctx.fillText(min.toFixed(0), toX(min), y+20);
                // Max abajo
                ctx.fillText(max.toFixed(0), toX(max), y+20);
                // Mediana arriba
                ctx.fillStyle="#ffaa00";
                ctx.fillText(med.toFixed(0), toX(med), y-12);
            });
        }

        /* --- PIE CHART (Chart.js) --- */
        function drawPie() {
            if(typeof Chart === 'undefined') return;
            const t = { Interna:0, Externa:0, Muda:0 };
            logs.forEach(l => t[l.type] += l.dur);
            
            const ctx = document.getElementById('pieChart');
            if(pieChartInst) pieChartInst.destroy();
            
            pieChartInst = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Int', 'Ext', 'Muda'],
                    datasets: [{ data: [t.Interna, t.Externa, t.Muda], backgroundColor: ['#00d4ff', '#00ff00', '#ffaa00'], borderWidth: 0 }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { legend: { position:'right', labels:{color:'#fff', font:{size:10}} } } 
                }
            });
        }

        /* --- TABLA STATS --- */
        function updateStatTable() {
            const body = document.getElementById('stats-body');
            let g = {};
            logs.forEach(l=>{if(!g[l.name])g[l.name]=[]; g[l.name].push(l.dur)});
            body.innerHTML = Object.keys(g).map(k=>{
                const arr = g[k];
                const avg = arr.reduce((a,b)=>a+b,0)/arr.length;
                return `<tr><td style="text-align:left; padding-left:10px">${k}</td><td>${arr.length}</td><td style="color:var(--neon-blue)">${avg.toFixed(1)}</td><td>${Math.max(...arr).toFixed(1)}</td></tr>`;
            }).join('');
        }

        /* --- BASE --- */
        function renderBtns() {
            const area = document.getElementById('btn-area'); area.innerHTML="";
            btns.forEach(n => {
                const g = getGroup(n);
                const act = activeTasks[g] && activeTasks[g].name === n;
                const div = document.createElement('div'); div.className='smed-btn-box';
                div.innerHTML=`<button class="smed-btn ${act?'active':''}" onclick="toggleTask(this,'${n}')">${n}<div class="grp-label">${g}</div></button><button class="del-btn" onclick="delBtn('${n}')">×</button>`;
                area.appendChild(div);
            });
        }
        function addBtn() { const n=document.getElementById('new-btn').value.trim(); if(n && !btns.includes(n)){btns.push(n); persist(); renderBtns(); document.getElementById('new-btn').value="";} }
        function delBtn(n) { if(confirm("¿Borrar?")){btns=btns.filter(b=>b!==n); persist(); renderBtns();} }
        function renderLogs() { document.getElementById('log-body').innerHTML = logs.slice().reverse().map(l=>`<tr><td>${l.name}</td><td>${l.type.substring(0,3)}</td><td style="color:var(--neon-orange)">${l.dur}</td><td>${l.end}</td></tr>`).join(''); }
        function persist() { localStorage.setItem('smed_v19_logs', JSON.stringify(logs)); localStorage.setItem('smed_v19_btns', JSON.stringify(btns)); }
        function exportData() {
            let c = "Tarea,Tipo,Duracion,Inicio,Fin\n"; logs.forEach(l=>c+=`"${l.name}","${l.type}",${l.dur},${l.start},${l.end}\n`);
            const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([c],{type:'text/csv'})); a.download=`SMED_V19_${Date.now()}.csv`; a.click();
        }
        function importCSV(i) {
            Array.from(i.files).forEach(f=>{ const r=new FileReader(); r.onload=e=>{ e.target.result.split('\n').forEach(x=>{ const p=x.replace(/"/g,'').split(','); if(p.length>=3 && !isNaN(parseFloat(p[2]))) logs.push({name:p[0], type:p[1], dur:parseFloat(p[2]), start:p[3], end:p[4]}); }); persist(); renderLogs(); }; r.readAsText(f); });
        }
        function hardReset() { if(confirm("¿RESET TOTAL?")) { localStorage.clear(); location.reload(); } }
        function toggleFS() { if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }

        window.onload = init;
    </script>
</body>
</html>
