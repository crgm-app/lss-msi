<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lean Tracker - Calibraci√≥n Flotante</title>
    <style>
        :root { --p: #2563eb; --s: #059669; --d: #dc2626; --w: #f59e0b; }
        body { font-family: sans-serif; margin: 0; background: #f1f5f9; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* Interfaz superior */
        .header { background: white; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 10; }
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-bottom: 8px; }
        input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; }
        .full { grid-column: span 2; }
        
        .controls { display: flex; gap: 5px; }
        button { flex: 1; padding: 10px; border: none; border-radius: 5px; color: white; font-weight: bold; cursor: pointer; }
        #startBtn { background: var(--p); }
        #stopBtn { background: var(--s); display: none; }

        /* Contenedor de Mapa */
        #viewport { flex: 1; overflow: auto; background: #475569; position: relative; }
        canvas { background: white; display: block; }

        /* VENTANA FLOTANTE DE CALIBRACI√ìN */
        #calibBox { 
            position: fixed; top: 100px; right: 10px; width: 220px; 
            background: rgba(255, 255, 255, 0.95); padding: 15px; 
            border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 1000; border: 2px solid var(--p); display: none;
        }
        #calibBox h4 { margin: 0 0 10px 0; color: var(--p); font-size: 14px; }
        #calibBox p { font-size: 11px; margin-bottom: 10px; }
        .calib-step { background: #f8fafc; padding: 8px; border-radius: 4px; margin-bottom: 8px; border-left: 4px solid #ddd; }
        .calib-step.active { border-left-color: var(--w); background: #fffbeb; }
        .calib-step label { font-size: 10px; font-weight: bold; display: block; }
        
        /* Pines visuales en el canvas */
        .pin { position: absolute; width: 20px; height: 20px; border-radius: 50% 50% 50% 0; background: var(--p); transform: rotate(-45deg); pointer-events: none; border: 2px solid white; }
        .pin::after { content: ""; position: absolute; width: 8px; height: 8px; background: white; border-radius: 50%; top: 6px; left: 6px; }
        #pinA { background: var(--w); }
        #pinB { background: var(--d); }

        .floating-btns { position: fixed; bottom: 20px; left: 20px; display: flex; flex-direction: column; gap: 10px; }
        .round-btn { width: 50px; height: 50px; border-radius: 25px; font-size: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

<div class="header">
    <div class="input-grid">
        <input type="text" id="opName" placeholder="Operario / OP" class="full">
        <input type="text" id="origin" placeholder="Origen">
        <input type="text" id="destination" placeholder="Destino">
        <div style="display:flex; align-items:center; gap:10px; grid-column: span 2;">
            <input type="file" id="mapLoader" accept="image/*" style="flex:1">
            <input type="color" id="routeColor" value="#2563eb" style="width:40px; height:35px; padding:0;">
        </div>
    </div>
    <div class="controls">
        <button id="startBtn">‚ñ∂ INICIAR</button>
        <button id="stopBtn">üíæ GUARDAR</button>
    </div>
</div>

<div id="calibBox">
    <h4>üìç Calibrar Mapa</h4>
    <p>1. Toca un punto en el plano.<br>2. Escribe su GPS real.</p>
    
    <div id="stepA" class="calib-step active">
        <label>PUNTO 1 (AMARILLO)</label>
        <input type="number" id="latA" placeholder="Lat: 14.6349" step="0.000001">
        <input type="number" id="lonA" placeholder="Lon: -90.5068" step="0.000001">
    </div>

    <div id="stepB" class="calib-step">
        <label>PUNTO 2 (ROJO)</label>
        <input type="number" id="latB" placeholder="Lat: 14.6341" step="0.000001">
        <input type="number" id="lonB" placeholder="Lon: -90.5061" step="0.000001">
    </div>

    <button onclick="saveCalib()" style="background:var(--p); width:100%; font-size:12px;">FINALIZAR</button>
    <button onclick="toggleCalib()" style="background:#64748b; width:100%; font-size:10px; margin-top:5px;">CANCELAR</button>
</div>

<div id="viewport">
    <canvas id="mapCanvas"></canvas>
    <div id="pinA" class="pin" style="display:none;"></div>
    <div id="pinB" class="pin" style="display:none;"></div>
</div>

<div class="floating-btns">
    <button onclick="toggleCalib()" class="round-btn" style="background:var(--w)">üìç</button>
    <button onclick="downloadPNG()" class="round-btn" style="background:#6d28d9">üñºÔ∏è</button>
    <button onclick="downloadCSV()" class="round-btn" style="background:var(--s)">üì•</button>
</div>

<script>
    const canvas = document.getElementById('mapCanvas');
    const ctx = canvas.getContext('2d');
    const bg = new Image();
    let calibPoints = { a: null, b: null };
    let calibStep = 'a';
    let isCalibrating = false;
    let history = JSON.parse(localStorage.getItem('leanHistory') || '[]');

    // Cargar Mapa
    if(localStorage.getItem('leanMap')) bg.src = localStorage.getItem('leanMap');
    document.getElementById('mapLoader').onchange = e => {
        const r = new FileReader();
        r.onload = f => { localStorage.setItem('leanMap', f.target.result); bg.src = f.target.result; };
        r.readAsDataURL(e.target.files[0]);
    };

    bg.onload = () => {
        canvas.width = bg.width;
        canvas.height = bg.height;
        redraw();
    };

    function redraw() {
        ctx.clearRect(0,0,canvas.width, canvas.height);
        ctx.drawImage(bg, 0, 0);
        history.forEach(route => {
            ctx.fillStyle = route.color || 'blue';
            route.points.forEach(p => {
                const pos = gpsToCanvas(p.lat, p.lon);
                ctx.beginPath(); ctx.arc(pos.x, pos.y, 3, 0, Math.PI*2); ctx.fill();
            });
        });
    }

    // --- L√≥gica de Calibraci√≥n ---
    function toggleCalib() {
        isCalibrating = !isCalibrating;
        document.getElementById('calibBox').style.display = isCalibrating ? 'block' : 'none';
        calibStep = 'a';
        updateCalibUI();
    }

    canvas.addEventListener('click', e => {
        if(!isCalibrating) return;
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        if(calibStep === 'a') {
            calibPoints.a = { x, y };
            setPin('pinA', x, y);
            calibStep = 'b';
        } else {
            calibPoints.b = { x, y };
            setPin('pinB', x, y);
            calibStep = 'a';
        }
        updateCalibUI();
    });

    function setPin(id, x, y) {
        const p = document.getElementById(id);
        p.style.left = x + 'px';
        p.style.top = (y - 20) + 'px'; // Ajuste para que la punta toque el pixel
        p.style.display = 'block';
    }

    function updateCalibUI() {
        document.getElementById('stepA').className = calibStep === 'a' ? 'calib-step active' : 'calib-step';
        document.getElementById('stepB').className = calibStep === 'b' ? 'calib-step active' : 'calib-step';
    }

    function saveCalib() {
        const latA = parseFloat(document.getElementById('latA').value);
        const lonA = parseFloat(document.getElementById('lonA').value);
        const latB = parseFloat(document.getElementById('latB').value);
        const lonB = parseFloat(document.getElementById('lonB').value);

        if(!calibPoints.a || !calibPoints.b || isNaN(latA) || isNaN(latB)) return alert("Completa los puntos y las coordenadas");

        const calibration = {
            p1: { x: calibPoints.a.x, y: calibPoints.a.y, lat: latA, lon: lonA },
            p2: { x: calibPoints.b.x, y: calibPoints.b.y, lat: latB, lon: lonB }
        };
        localStorage.setItem('leanCalib', JSON.stringify(calibration));
        alert("¬°Mapa Calibrado!");
        toggleCalib();
    }

    function gpsToCanvas(lat, lon) {
        const c = JSON.parse(localStorage.getItem('leanCalib'));
        if(!c) return { x: 0, y: 0 };

        // Interpolaci√≥n lineal simple entre dos puntos
        const pctLat = (lat - c.p1.lat) / (c.p2.lat - c.p1.lat);
        const pctLon = (lon - c.p1.lon) / (c.p2.lon - c.p1.lon);

        return {
            x: c.p1.x + (pctLon * (c.p2.x - c.p1.x)),
            y: c.p1.y + (pctLat * (c.p2.y - c.p1.y))
        };
    }

    // --- Seguimiento ---
    let currentRoute = [];
    let watchId = null;

    document.getElementById('startBtn').onclick = () => {
        if(!localStorage.getItem('leanCalib')) return alert("Calibra primero");
        currentRoute = [];
        document.getElementById('startBtn').style.display = 'none';
        document.getElementById('stopBtn').style.display = 'block';

        watchId = navigator.geolocation.watchPosition(pos => {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            
            // Filtro 1 metro (aprox)
            if(currentRoute.length > 0) {
                const last = currentRoute[currentRoute.length-1];
                const d = Math.sqrt(Math.pow(lat-last.lat, 2) + Math.pow(lon-last.lon, 2));
                if(d < 0.00001) return; 
            }

            currentRoute.push({ lat, lon, time: new Date().getTime() });
            redraw();
            // Dibujar ruta actual en vivo
            ctx.fillStyle = document.getElementById('routeColor').value;
            currentRoute.forEach(p => {
                const c = gpsToCanvas(p.lat, p.lon);
                ctx.beginPath(); ctx.arc(c.x, c.y, 4, 0, Math.PI*2); ctx.fill();
            });
        }, null, { enableHighAccuracy: true });
    };

    document.getElementById('stopBtn').onclick = () => {
        navigator.geolocation.clearWatch(watchId);
        const newRoute = {
            op: document.getElementById('opName').value,
            color: document.getElementById('routeColor').value,
            points: currentRoute
        };
        history.push(newRoute);
        localStorage.setItem('leanHistory', JSON.stringify(history));
        document.getElementById('startBtn').style.display = 'block';
        document.getElementById('stopBtn').style.display = 'none';
        alert("Ruta guardada.");
    };

    function downloadCSV() {
        let csv = "OP,Lat,Lon,Timestamp\n";
        history.forEach(r => r.points.forEach(p => csv += `${r.op},${p.lat},${p.lon},${p.time}\n`));
        const b = new Blob([csv], {type: 'text/csv'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(b);
        a.download = "lean_data.csv";
        a.click();
    }

    function downloadPNG() {
        const a = document.createElement('a');
        a.href = canvas.toDataURL();
        a.download = "mapa_lean.png";
        a.click();
    }
</script>
</body>
</html>
