<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lean Tracker Precision</title>
    <style>
        :root { --p: #2563eb; --s: #059669; --d: #dc2626; --w: #f59e0b; }
        body { font-family: system-ui, sans-serif; margin: 0; background: #0f172a; color: white; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        .header { background: white; color: #333; padding: 10px; z-index: 100; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .gps-monitor { background: #f1f5f9; padding: 5px 10px; border-radius: 4px; border: 1px dashed var(--p); color: var(--p); font-family: monospace; font-size: 12px; display: flex; justify-content: space-between; margin-bottom: 5px; }
        
        .main-container { flex: 1; display: flex; position: relative; overflow: hidden; }
        #sidebar { width: 260px; background: #1e293b; border-right: 1px solid #334155; overflow-y: auto; padding: 10px; transition: 0.3s; }
        #sidebar.collapsed { margin-left: -280px; }
        
        #viewport { flex: 1; position: relative; overflow: auto; background: #000; display: block; }
        canvas { cursor: crosshair; }

        .calib-box { position: fixed; top: 120px; right: 20px; width: 240px; background: white; color: #333; padding: 15px; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); z-index: 200; display: none; border: 2px solid var(--p); }
        .route-card { background: #334155; padding: 10px; border-radius: 6px; margin-bottom: 10px; font-size: 11px; border-left: 4px solid var(--p); position: relative;}
        .del-btn { position: absolute; top: 5px; right: 5px; background: var(--d); color: white; border: none; padding: 2px 5px; cursor: pointer; border-radius: 3px; }

        .fab-container { position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; }
        .btn-round { width: 50px; height: 50px; border-radius: 25px; border: none; color: white; font-size: 18px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        
        input { width: 100%; padding: 6px; margin: 4px 0; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        .active-step { background: #fff7ed; border: 1px solid var(--w); padding: 5px; border-radius: 4px; }
    </style>
</head>
<body>

<div class="header">
    <div class="gps-monitor">
        <span>GPS VIVO:</span> <span id="liveGPS">Localizando...</span>
    </div>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
        <input type="text" id="opName" placeholder="Operario">
        <input type="text" id="routeLabel" placeholder="Nombre de Ruta">
        <input type="file" id="mapLoader" accept="image/*">
        <input type="color" id="routeColor" value="#2563eb">
    </div>
    <button id="startBtn" onclick="startTracking()" style="width:100%; background:var(--p); color:white; border:none; padding:10px; font-weight:bold; margin-top:5px; border-radius:4px;">‚ñ∂ INICIAR RUTA</button>
    <button id="stopBtn" onclick="stopTracking()" style="width:100%; background:var(--s); color:white; border:none; padding:10px; font-weight:bold; margin-top:5px; border-radius:4px; display:none;">üíæ GUARDAR RUTA</button>
</div>

<div class="main-container">
    <div id="sidebar">
        <h4 style="margin:0 0 10px 0;">Historial</h4>
        <div id="routeList"></div>
    </div>
    <div id="viewport">
        <canvas id="mapCanvas"></canvas>
    </div>
</div>

<div id="calibBox" class="calib-box">
    <h4 style="margin:0">üìç Calibraci√≥n</h4>
    <p style="font-size:11px">Toca el punto en el mapa y escribe su GPS.</p>
    
    <div id="uiStepA">
        <label style="font-size:10px; font-weight:bold;">PUNTO A (Amarillo)</label>
        <input type="number" id="latA" placeholder="Latitud" step="0.0000001">
        <input type="number" id="lonA" placeholder="Longitud" step="0.0000001">
    </div>
    <hr>
    <div id="uiStepB">
        <label style="font-size:10px; font-weight:bold;">PUNTO B (Rojo)</label>
        <input type="number" id="latB" placeholder="Latitud" step="0.0000001">
        <input type="number" id="lonB" placeholder="Longitud" step="0.0000001">
    </div>
    <button onclick="saveCalibration()" style="width:100%; background:var(--p); color:white; border:none; padding:8px; margin-top:10px; border-radius:4px;">GUARDAR ESCALA</button>
</div>

<div class="fab-container">
    <button onclick="toggleSidebar()" class="btn-round" style="background:var(--dark)">üìã</button>
    <button onclick="toggleCalib()" class="btn-round" style="background:var(--w)">üìç</button>
    <button onclick="downloadPNG()" class="btn-round" style="background:#6d28d9">üñºÔ∏è</button>
</div>

<script>
    const canvas = document.getElementById('mapCanvas');
    const ctx = canvas.getContext('2d');
    const bg = new Image();
    let history = JSON.parse(localStorage.getItem('leanHistory') || '[]');
    let isCalibrating = false, calibStep = 'a', pA = null, pB = null;

    // Cargar Plano
    if(localStorage.getItem('leanMap')) bg.src = localStorage.getItem('leanMap');
    document.getElementById('mapLoader').onchange = e => {
        const r = new FileReader();
        r.onload = f => { localStorage.setItem('leanMap', f.target.result); bg.src = f.target.result; };
        r.readAsDataURL(e.target.files[0]);
    };

    bg.onload = () => {
        canvas.width = bg.width;
        canvas.height = bg.height;
        renderAll();
    };

    function renderAll() {
        ctx.clearRect(0,0,canvas.width, canvas.height);
        ctx.drawImage(bg, 0, 0);
        
        // Dibujar Rutas Hist√≥ricas
        history.forEach(route => {
            if(route.points.length < 2) return;
            ctx.beginPath();
            ctx.strokeStyle = route.color;
            ctx.lineWidth = 3;
            route.points.forEach((p, i) => {
                const pos = gpsToCanvas(p.lat, p.lon);
                if(i===0) ctx.moveTo(pos.x, pos.y); else ctx.lineTo(pos.x, pos.y);
            });
            ctx.stroke();
        });

        // Dibujar Puntos de Calibraci√≥n si existen
        if(pA) drawMarker(pA.x, pA.y, 'yellow');
        if(pB) drawMarker(pB.x, pB.y, 'red');
    }

    function drawMarker(x, y, color) {
        ctx.fillStyle = color;
        ctx.beginPath(); ctx.arc(x, y, 8, 0, Math.PI*2); ctx.fill();
        ctx.strokeStyle = 'white'; ctx.stroke();
    }

    // GPS Monitor
    navigator.geolocation.watchPosition(pos => {
        document.getElementById('liveGPS').innerText = `${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)}`;
    }, null, { enableHighAccuracy: true });

    // Calibraci√≥n con Precisi√≥n
    function toggleCalib() { 
        isCalibrating = !isCalibrating; 
        document.getElementById('calibBox').style.display = isCalibrating ? 'block' : 'none';
        updateCalibUI();
    }

    canvas.addEventListener('click', e => {
        if(!isCalibrating) return;
        // Calculo exacto de la posici√≥n del clic relativo al contenido del canvas
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        const x = (e.clientX - rect.left) * scaleX;
        const y = (e.clientY - rect.top) * scaleY;

        if(calibStep === 'a') {
            pA = { x, y };
            calibStep = 'b';
        } else {
            pB = { x, y };
            calibStep = 'a';
        }
        updateCalibUI();
        renderAll();
    });

    function updateCalibUI() {
        document.getElementById('uiStepA').className = calibStep === 'a' ? 'active-step' : '';
        document.getElementById('uiStepB').className = calibStep === 'b' ? 'active-step' : '';
    }

    function saveCalibration() {
        const calibData = {
            a: { x: pA.x, y: pA.y, lat: parseFloat(document.getElementById('latA').value), lon: parseFloat(document.getElementById('lonA').value) },
            b: { x: pB.x, y: pB.y, lat: parseFloat(document.getElementById('latB').value), lon: parseFloat(document.getElementById('lonB').value) }
        };
        if(!calibData.a.lat || !calibData.b.lat) return alert("Ingresa las coordenadas GPS.");
        localStorage.setItem('leanCalib', JSON.stringify(calibData));
        alert("Escala guardada correctamente.");
        toggleCalib();
    }

    function gpsToCanvas(lat, lon) {
        const c = JSON.parse(localStorage.getItem('leanCalib'));
        if(!c) return {x:0, y:0};
        const pctLat = (lat - c.a.lat) / (c.b.lat - c.a.lat);
        const pctLon = (lon - c.a.lon) / (c.b.lon - c.a.lon);
        return {
            x: c.a.x + (pctLon * (c.b.x - c.a.x)),
            y: c.a.y + (pctLat * (c.b.y - c.a.y))
        };
    }

    // Tracking
    let currentPoints = [], watchId = null, startT = null;

    function startTracking() {
        if(!localStorage.getItem('leanCalib')) return alert("DEBES CALIBRAR ANTES DE INICIAR.");
        currentPoints = [];
        startT = Date.now();
        document.getElementById('startBtn').style.display = 'none';
        document.getElementById('stopBtn').style.display = 'block';

        watchId = navigator.geolocation.watchPosition(pos => {
            currentPoints.push({ lat: pos.coords.latitude, lon: pos.coords.longitude, t: Date.now() });
            renderAll();
            // Dibujar l√≠nea actual
            ctx.beginPath();
            ctx.strokeStyle = document.getElementById('routeColor').value;
            ctx.lineWidth = 5;
            currentPoints.forEach((p, i) => {
                const c = gpsToCanvas(p.lat, p.lon);
                if(i===0) ctx.moveTo(c.x, c.y); else ctx.lineTo(c.x, c.y);
            });
            ctx.stroke();
        }, null, { enableHighAccuracy: true });
    }

    function stopTracking() {
        navigator.geolocation.clearWatch(watchId);
        const duration = Math.round((Date.now() - startT) / 1000);
        
        let metros = 0;
        for(let i=1; i<currentPoints.length; i++) {
            const p1 = currentPoints[i-1], p2 = currentPoints[i];
            metros += Math.sqrt(Math.pow(p2.lat-p1.lat, 2) + Math.pow(p2.lon-p1.lon, 2)) * 111320;
        }

        history.push({
            op: document.getElementById('opName').value || 'S/N',
            label: document.getElementById('routeLabel').value || 'Ruta',
            color: document.getElementById('routeColor').value,
            duration: duration,
            dist: metros.toFixed(1),
            points: currentPoints
        });
        localStorage.setItem('leanHistory', JSON.stringify(history));
        location.reload();
    }

    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('collapsed'); }
    function downloadPNG() { const a = document.createElement('a'); a.href = canvas.toDataURL(); a.download="lean.png"; a.click(); }

    // Cargar historial en sidebar
    const list = document.getElementById('routeList');
    list.innerHTML = history.map((r, i) => `
        <div class="route-card" style="border-left-color:${r.color}">
            <button class="del-btn" onclick="deleteR(${i})">√ó</button>
            <strong>${r.label}</strong><br>
            OP: ${r.op} | ${r.duration}s | ${r.dist}m
        </div>
    `).join('');

    function deleteR(i) {
        history.splice(i, 1);
        localStorage.setItem('leanHistory', JSON.stringify(history));
        location.reload();
    }
</script>
</body>
</html>
