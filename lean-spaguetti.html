<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lean Spaghetti Tracker</title>
    <style>
        :root { --primary: #0056b3; --danger: #dc3545; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 10px; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; }
        .card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); width: 100%; max-width: 500px; margin-bottom: 10px; }
        button { width: 100%; padding: 12px; margin: 5px 0; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }
        #startBtn { background: var(--primary); color: white; }
        #stopBtn { background: var(--danger); color: white; }
        #canvasContainer { width: 100%; overflow: auto; background: #ddd; border: 1px solid #999; }
        canvas { background-color: white; display: block; margin: 0 auto; }
        .stats { font-size: 12px; color: #555; display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
    </style>
</head>
<body>

    <div class="card">
        <h3>Lean Flow Tracker</h3>
        <input type="text" id="routeName" placeholder="Nombre: Ej. Operador A - Turno 1" style="width:95%; padding:8px; margin-bottom:10px;">
        <div class="stats">
            <div>Seg. Día: <span id="statSec">-</span></div>
            <div>Puntos: <span id="statPoints">0</span></div>
            <div>X: <span id="statX">0</span> m</div>
            <div>Y: <span id="statY">0</span> m</div>
        </div>
        <button id="startBtn">INICIAR RUTA</button>
        <button id="stopBtn" disabled>DETENER Y DESCARGAR CSV</button>
    </div>

    <div id="canvasContainer">
        <canvas id="mapCanvas" width="600" height="600"></canvas>
    </div>

    <script>
        let dataLog = [];
        let baseCoords = null;
        let watchId = null;
        let intervalId = null;
        let lastPos = null;

        const canvas = document.getElementById('mapCanvas');
        const ctx = canvas.getContext('2d');
        
        // Dibujar cuadrícula inicial
        const drawGrid = () => {
            ctx.strokeStyle = "#eee";
            for(let i=0; i<canvas.width; i+=20) {
                ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,canvas.height); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(canvas.width,i); ctx.stroke();
            }
        };
        drawGrid();

        function getSecondOfDay() {
            const now = new Date();
            return (now.getHours() * 3600) + (now.getMinutes() * 60) + now.getSeconds();
        }

        function getRelativeCoords(lat, lon, bLat, bLon) {
            // Conversión aproximada: 1 grado latitud = 111,111 metros
            const y = (lat - bLat) * 111111;
            const x = (lon - bLon) * 111111 * Math.cos(bLat * Math.PI / 180);
            return { x: x.toFixed(2), y: y.toFixed(2) };
        }

        document.getElementById('startBtn').onclick = () => {
            if (!navigator.geolocation) return alert("Tu móvil no soporta GPS");

            baseCoords = null;
            dataLog = [];
            ctx.clearRect(0,0,canvas.width, canvas.height);
            drawGrid();

            watchId = navigator.geolocation.watchPosition(pos => {
                lastPos = pos;
                if (!baseCoords) {
                    baseCoords = { lat: pos.coords.latitude, lon: pos.coords.longitude };
                }
            }, err => alert("Error GPS: " + err.message), { enableHighAccuracy: true });

            intervalId = setInterval(() => {
                if (lastPos && baseCoords) {
                    const sec = getSecondOfDay();
                    const rel = getRelativeCoords(lastPos.coords.latitude, lastPos.coords.longitude, baseCoords.lat, baseCoords.lon);
                    
                    dataLog.push({
                        segundo: sec,
                        x: rel.x,
                        y: rel.y,
                        z: lastPos.coords.altitude || 0
                    });

                    // Actualizar UI
                    document.getElementById('statSec').innerText = sec;
                    document.getElementById('statPoints').innerText = dataLog.length;
                    document.getElementById('statX').innerText = rel.x;
                    document.getElementById('statY').innerText = rel.y;

                    // Dibujar en el canvas (escala 1m = 10px)
                    const drawX = (canvas.width/2) + (rel.x * 10);
                    const drawY = (canvas.height/2) - (rel.y * 10);
                    ctx.fillStyle = "blue";
                    ctx.fillRect(drawX, drawY, 3, 3);
                }
            }, 1000);

            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
        };

        document.getElementById('stopBtn').onclick = () => {
            navigator.geolocation.clearWatch(watchId);
            clearInterval(intervalId);

            let csv = "segundo_dia,x_metros,y_metros,z_metros\n";
            dataLog.forEach(d => csv += `${d.segundo},${d.x},${d.y},${d.z}\n`);

            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `ruta_${document.getElementById('routeName').value || 'lean'}.csv`;
            a.click();

            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
        };
    </script>
</body>
</html>
