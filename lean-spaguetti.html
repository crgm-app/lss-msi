<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lean Tracking System Pro</title>
    <style>
        :root { --p: #2563eb; --s: #059669; --d: #dc2626; --w: #f59e0b; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: #f1f5f9; color: #1e293b; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* Panel de Control */
        .header { background: white; padding: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 100; border-bottom: 2px solid #e2e8f0; }
        .input-group { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; }
        input, select { padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 14px; width: 100%; box-sizing: border-box; }
        .full-input { grid-column: span 2; }
        
        /* Botonera */
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        button { padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; color: white; transition: 0.2s; }
        #startBtn { background: var(--p); grid-column: span 2; }
        #pauseBtn { background: var(--w); display: none; }
        #stopBtn { background: var(--s); display: none; }
        button:disabled { background: #94a3b8; cursor: not-allowed; }

        /* Estado */
        .status-bar { background: #1e293b; color: #f8fafc; padding: 6px 12px; font-size: 11px; display: flex; justify-content: space-between; align-items: center; }
        .indicator { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 4px; }
        .active-gps { background: #22c55e; box-shadow: 0 0 5px #22c55e; }
        .idle-gps { background: var(--w); }

        /* Mapa */
        #viewport { flex: 1; overflow: auto; background: #475569; position: relative; display: flex; align-items: flex-start; justify-content: center; }
        canvas { background: white; touch-action: none; cursor: crosshair; }
        
        .floating-menu { position: absolute; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; }
        .btn-float { width: 50px; height: 50px; border-radius: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); font-size: 20px; }
    </style>
</head>
<body>

<div class="header">
    <div class="input-group">
        <input type="text" id="opName" placeholder="ID Operario / OP" class="full-input">
        <input type="text" id="origin" placeholder="Desde (Origen)">
        <input type="text" id="destination" placeholder="Hacia (Destino)">
        <input type="text" id="purpose" placeholder="Prop√≥sito (Ej: Surtido)" class="full-input">
        <div style="display:flex; align-items:center; gap:5px; grid-column: span 2;">
            <label style="font-size:12px">Color de ruta:</label>
            <input type="color" id="routeColor" value="#2563eb" style="width:50px; padding:2px; height:30px;">
            <input type="file" id="mapLoader" accept="image/*" style="font-size:10px;">
        </div>
    </div>
    
    <div class="controls">
        <button id="startBtn">‚ñ∂ INICIAR RASTREO</button>
        <button id="pauseBtn">‚è∏ PAUSA MANUAL</button>
        <button id="stopBtn">üíæ GUARDAR TRAMO</button>
    </div>
</div>

<div class="status-bar">
    <span><span id="gpsDot" class="indicator"></span> <span id="gpsStatus">GPS OFF</span></span>
    <span>Movimiento: <span id="moveStatus">Parado</span></span>
    <span>Distancia: <span id="totalDist">0</span>m</span>
</div>

<div id="viewport">
    <canvas id="mapCanvas"></canvas>
</div>

<div class="floating-menu">
    <button onclick="downloadCSV()" title="Exportar Excel" style="background:var(--s)" class="btn-float">üì•</button>
    <button onclick="clearLogs()" title="Borrar Memoria" style="background:var(--d)" class="btn-float">üóëÔ∏è</button>
</div>

<script>
    let log = [];
    let watchId = null;
    let baseCoords = null;
    let lastPoint = null;
    let isPaused = false;
    
    const canvas = document.getElementById('mapCanvas');
    const ctx = canvas.getContext('2d');
    const bg = new Image();

    // Persistencia de imagen de plano
    if(localStorage.getItem('leanMap')) {
        bg.src = localStorage.getItem('leanMap');
    }

    document.getElementById('mapLoader').onchange = (e) => {
        const reader = new FileReader();
        reader.onload = (f) => {
            localStorage.setItem('leanMap', f.target.result);
            bg.src = f.target.result;
        };
        reader.readAsDataURL(e.target.files[0]);
    };

    bg.onload = () => {
        canvas.width = bg.width;
        canvas.height = bg.height;
        ctx.drawImage(bg, 0, 0);
        renderHistory();
    };

    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371000;
        const dLat = (lat2-lat1) * Math.PI/180;
        const dLon = (lon2-lon1) * Math.PI/180;
        const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    document.getElementById('startBtn').onclick = () => {
        if(!bg.src) return alert("Sube el plano de la planta primero.");
        isPaused = false;
        document.getElementById('startBtn').style.display = 'none';
        document.getElementById('pauseBtn').style.display = 'block';
        document.getElementById('stopBtn').style.display = 'block';
        
        watchId = navigator.geolocation.watchPosition(pos => {
            if(isPaused) return;

            const { latitude, longitude, altitude } = pos.coords;
            const now = new Date();
            const secondOfDay = (now.getHours() * 3600) + (now.getMinutes() * 60) + now.getSeconds();

            if(!baseCoords) baseCoords = { lat: latitude, lon: longitude };

            let distFromLast = lastPoint ? getDistance(latitude, longitude, lastPoint.lat, lastPoint.lon) : 999;

            // L√ìGICA AUTO-PAUSA (Si se mueve menos de 1 metro, no registra pero GPS sigue activo)
            if(distFromLast >= 1.0) {
                document.getElementById('moveStatus').innerText = "Caminando";
                document.getElementById('gpsDot').className = "indicator active-gps";
                
                // Conversi√≥n a metros (X, Y)
                const x = (longitude - baseCoords.lon) * 111320 * Math.cos(baseCoords.lat * Math.PI/180);
                const y = (latitude - baseCoords.lat) * 110540;

                const dataPoint = {
                    op: document.getElementById('opName').value || 'N/A',
                    orig: document.getElementById('origin').value || 'Inicio',
                    dest: document.getElementById('destination').value || 'Fin',
                    motive: document.getElementById('purpose').value || 'Transporte',
                    sec: secondOfDay,
                    x: x.toFixed(2),
                    y: y.toFixed(2),
                    z: (altitude || 0).toFixed(2),
                    color: document.getElementById('routeColor').value
                };

                log.push(dataPoint);
                lastPoint = { lat: latitude, lon: longitude };
                draw(dataPoint);
                
                document.getElementById('totalDist').innerText = log.length;
            } else {
                document.getElementById('moveStatus').innerText = "Auto-Pausa (Quieto)";
                document.getElementById('gpsDot').className = "indicator idle-gps";
            }
            document.getElementById('gpsStatus').innerText = "GPS Activo";
        }, err => console.error(err), { enableHighAccuracy: true });
    };

    document.getElementById('pauseBtn').onclick = () => {
        isPaused = !isPaused;
        document.getElementById('pauseBtn').innerText = isPaused ? "‚ñ∂ REANUDAR" : "‚è∏ PAUSA MANUAL";
        document.getElementById('moveStatus').innerText = isPaused ? "Pausado" : "Esperando...";
    };

    document.getElementById('stopBtn').onclick = () => {
        navigator.geolocation.clearWatch(watchId);
        const history = JSON.parse(localStorage.getItem('leanHistory') || '[]');
        history.push(...log);
        localStorage.setItem('leanHistory', JSON.stringify(history));
        
        alert("Tramo guardado con √©xito.");
        location.reload();
    };

    function draw(p) {
        const scale = 15; // Ajustar seg√∫n tama√±o del plano
        const dx = (canvas.width/2) + (p.x * scale);
        const dy = (canvas.height/2) - (p.y * scale);
        
        ctx.fillStyle = p.color;
        ctx.beginPath();
        ctx.arc(dx, dy, 3, 0, Math.PI*2);
        ctx.fill();
    }

    function renderHistory() {
        const history = JSON.parse(localStorage.getItem('leanHistory') || '[]');
        history.forEach(p => draw(p));
    }

    function downloadCSV() {
        const history = JSON.parse(localStorage.getItem('leanHistory') || '[]');
        if(history.length === 0) return alert("No hay datos para exportar.");

        let csv = "\uFEFFOP,Origen,Destino,Motivo,Segundo_Dia,X_Metros,Y_Metros,Z_Metros\n";
        history.forEach(p => {
            csv += `${p.op},${p.orig},${p.dest},${p.motive},${p.sec},${p.x},${p.y},${p.z}\n`;
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "Analisis_Lean_SixSigma.csv";
        link.click();
    }

    function clearLogs() {
        if(confirm("¬øSeguro que quieres borrar todo el historial?")) {
            localStorage.removeItem('leanHistory');
            location.reload();
        }
    }
</script>
</body>
</html>
