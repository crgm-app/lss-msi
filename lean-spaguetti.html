<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lean Route Tracker PRO</title>
    <style>
        :root { --p: #2563eb; --s: #10b981; --d: #ef4444; }
        body { font-family: system-ui, sans-serif; margin: 0; background: #f8fafc; display: flex; flex-direction: column; height: 100vh; }
        .panel { background: white; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 10; }
        .grid-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .controls button { width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; color: white; margin-top: 5px; }
        #startBtn { background: var(--p); }
        #stopBtn { background: var(--s); }
        #clearBtn { background: var(--d); margin-top: 20px; }
        
        #canvasWrapper { flex: 1; overflow: auto; position: relative; background: #64748b; display: flex; align-items: flex-start; justify-content: center; }
        canvas { background: white; cursor: crosshair; box-shadow: 0 0 20px rgba(0,0,0,0.3); }
        .status-bar { font-size: 11px; background: #1e293b; color: #cbd5e1; padding: 5px 15px; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

<div class="panel">
    <div class="grid-inputs">
        <input type="text" id="opName" placeholder="Operario / OP">
        <select id="turno">
            <option value="T1">Turno 1</option>
            <option value="T2">Turno 2</option>
            <option value="T3">Turno 3</option>
        </select>
        <input type="color" id="routeColor" value="#2563eb">
        <input type="file" id="mapUpload" accept="image/*">
    </div>
    <div class="controls">
        <button id="startBtn">INICIAR NUEVA RUTA</button>
        <button id="stopBtn" style="display:none;">DETENER Y GUARDAR</button>
    </div>
</div>

<div class="status-bar">
    <span id="posStats">GPS: Esperando...</span>
    <span id="distStats">Distancia: 0m</span>
    <span id="dbStats">Rutas en memoria: 0</span>
</div>

<div id="canvasWrapper">
    <canvas id="mapCanvas"></canvas>
</div>

<button id="clearBtn" onclick="clearHistory()">BORRAR TODO EL HISTORIAL</button>
<button id="downloadBtn" onclick="downloadAll()">DESCARGAR TODO (CSV)</button>

<script>
    let currentData = [];
    let watchId = null;
    let baseCoords = null;
    let lastRegisteredCoords = null;
    const canvas = document.getElementById('mapCanvas');
    const ctx = canvas.getContext('2d');
    const bgImage = new Image();

    // 1. FUNCIONAMIENTO SIN INTERNET Y PERSISTENCIA
    window.onload = () => {
        updateDbStats();
        if(localStorage.getItem('mapBase64')) {
            bgImage.src = localStorage.getItem('mapBase64');
        }
    };

    // Cargar imagen y guardarla localmente
    document.getElementById('mapUpload').onchange = (e) => {
        const reader = new FileReader();
        reader.onload = (event) => {
            localStorage.setItem('mapBase64', event.target.result);
            bgImage.src = event.target.result;
        };
        reader.readAsDataURL(e.target.files[0]);
    };

    bgImage.onload = () => {
        canvas.width = bgImage.width;
        canvas.height = bgImage.height;
        ctx.drawImage(bgImage, 0, 0);
        drawAllSavedRoutes();
    };

    // 2. LÓGICA DE GEOLOCALIZACIÓN Y FILTRO DE 1 METRO
    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3; // Metros
        const phi1 = lat1 * Math.PI/180;
        const phi2 = lat2 * Math.PI/180;
        const dPhi = (lat2-lat1) * Math.PI/180;
        const dLambda = (lon2-lon1) * Math.PI/180;
        const a = Math.sin(dPhi/2) * Math.sin(dPhi/2) +
                  Math.cos(phi1) * Math.cos(phi2) *
                  Math.sin(dLambda/2) * Math.sin(dLambda/2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    document.getElementById('startBtn').onclick = () => {
        if (!bgImage.src) return alert("Primero carga un plano de la planta");
        
        currentData = [];
        baseCoords = null;
        lastRegisteredCoords = null;
        
        document.getElementById('startBtn').style.display = 'none';
        document.getElementById('stopBtn').style.display = 'block';

        watchId = navigator.geolocation.watchPosition(pos => {
            const { latitude, longitude, altitude } = pos.coords;
            const now = new Date();
            const secOfDay = (now.getHours() * 3600) + (now.getMinutes() * 60) + now.getSeconds();

            if (!baseCoords) baseCoords = { lat: latitude, lon: longitude };

            // FILTRO: Solo registrar si se movió más de 1 metro
            let distanceMove = 0;
            if (lastRegisteredCoords) {
                distanceMove = calculateDistance(latitude, longitude, lastRegisteredCoords.lat, lastRegisteredCoords.lon);
            }

            if (!lastRegisteredCoords || distanceMove >= 1.0) {
                const xRel = (longitude - baseCoords.lon) * 111320 * Math.cos(baseCoords.lat * Math.PI / 180);
                const yRel = (latitude - baseCoords.lat) * 110540;

                const point = { 
                    s: secOfDay, 
                    x: xRel.toFixed(2), 
                    y: yRel.toFixed(2), 
                    z: (altitude || 0).toFixed(2),
                    op: document.getElementById('opName').value || 'SinNombre',
                    turno: document.getElementById('turno').value,
                    color: document.getElementById('routeColor').value
                };

                currentData.push(point);
                lastRegisteredCoords = { lat: latitude, lon: longitude };
                
                document.getElementById('posStats').innerText = `X: ${point.x} Y: ${point.y}`;
                document.getElementById('distStats').innerText = `Puntos: ${currentData.length}`;
                
                drawPoint(point);
            }
        }, null, { enableHighAccuracy: true });
    };

    function drawPoint(p) {
        // Ajuste manual: Escala 1m = 20px (puedes cambiar este factor)
        const scale = 20; 
        const drawX = (canvas.width / 2) + (p.x * scale);
        const drawY = (canvas.height / 2) - (p.y * scale);
        
        ctx.fillStyle = p.color;
        ctx.beginPath();
        ctx.arc(drawX, drawY, 4, 0, Math.PI * 2);
        ctx.fill();
    }

    // 3. GUARDADO AUTOMÁTICO EN LOCALSTORAGE
    document.getElementById('stopBtn').onclick = () => {
        navigator.geolocation.clearWatch(watchId);
        
        const history = JSON.parse(localStorage.getItem('leanHistory') || '[]');
        history.push({
            id: Date.now(),
            op: document.getElementById('opName').value,
            points: currentData
        });
        
        localStorage.setItem('leanHistory', JSON.stringify(history));
        
        document.getElementById('startBtn').style.display = 'block';
        document.getElementById('stopBtn').style.display = 'none';
        updateDbStats();
        alert("Ruta guardada en memoria local.");
    };

    function drawAllSavedRoutes() {
        const history = JSON.parse(localStorage.getItem('leanHistory') || '[]');
        history.forEach(route => {
            route.points.forEach(p => drawPoint(p));
        });
    }

    function updateDbStats() {
        const history = JSON.parse(localStorage.getItem('leanHistory') || '[]');
        document.getElementById('dbStats').innerText = `Rutas en memoria: ${history.length}`;
    }

    function downloadAll() {
        const history = JSON.parse(localStorage.getItem('leanHistory') || '[]');
        let csv = "OP,Turno,Segundo_Dia,X_Metros,Y_Metros,Z_Metros,Color\n";
        
        history.forEach(route => {
            route.points.forEach(p => {
                csv += `${p.op},${p.turno},${p.s},${p.x},${p.y},${p.z},${p.color}\n`;
            });
        });

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `reporte_lean_completo.csv`;
        a.click();
    }

    function clearHistory() {
        if(confirm("¿Borrar todos los datos guardados?")) {
            localStorage.removeItem('leanHistory');
            location.reload();
        }
    }
</script>
</body>
</html>
